<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Account Settings</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/><script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script><style>
    .container {
      max-width: 500px;
      margin: auto;
      text-align: center;
    }
    .cropper-container {
      width: 300px;
      height: 300px;
      margin: 20px auto;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid #ccc;
    }
    #preview {
      max-width: 100%;
    }
    .btn {
      margin-top: 10px;
    }
    </style></head>
<body class="bg-gray-100 text-gray-800">
<a class="inline-block mt-6 ml-6 px-4 py-2 bg-green-500 text-white rounded shadow hover:bg-green-600" href="index.html">← Back to Home</a>
<div class="max-w-xl mx-auto mt-10 p-6 bg-white rounded shadow">
<h1 class="text-2xl font-bold mb-4">Account Settings</h1>
<div class="mb-4">
<label class="block font-medium mb-2" for="profile-pic">Upload Profile Picture</label>
<input accept="image/*" class="mb-2" id="profile-pic" type="file"/>
<img alt="Preview" class="w-32 h-32 object-cover rounded-full border border-gray-300 hidden" id="preview" src=""/>
</div>
<button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" id="upload-btn">Upload</button>
<p class="mt-4 text-sm text-gray-600" id="status"></p>
</div>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const SUPABASE_URL = "https://jxxnfsydjrflnephmfjm.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const fileInput = document.getElementById("profile-pic");
  const preview = document.getElementById("preview");
  const uploadBtn = document.getElementById("upload-btn");
  const status = document.getElementById("status");

  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData?.session?.user) {
    window.location.href = "auth.html";
    return;
  }
  const user = sessionData.session.user;

  const { data: userData } = await supabase
    .from("users")
    .select("avatar_url")
    .eq("id", user.id)
    .single();

  if (userData?.avatar_url) {
    preview.src = userData.avatar_url;
    preview.classList.remove("hidden");
  }

  fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }
  });

  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) return alert("Please select a file first.");
    if (!file.type.startsWith("image/")) return alert("Only image files are allowed.");
    if (file.size > 5 * 1024 * 1024) return alert("File too large (max 5 MB).");

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Uploading...";
    status.textContent = "Uploading...";

    const fileName = `profile-${user.id}-${Date.now()}-${file.name}`;
    const { data: uploadData, error: uploadError } = await supabase.storage
      .from("profile-pictures")
      .upload(fileName, file, { upsert: true });

    if (uploadError) {
      status.textContent = "Upload failed: " + uploadError.message;
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Upload";
      return;
    }

    const { data: publicUrlData } = await supabase.storage
      .from("profile-pictures")
      .getPublicUrl(fileName);

    const publicUrl = publicUrlData?.publicUrl;
    if (!publicUrl) {
      status.textContent = "Could not retrieve image URL.";
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Upload";
      return;
    }

    const { error: updateError } = await supabase
      .from("users")
      .update({ avatar_url: publicUrl })
      .eq("id", user.id);

    await supabase.auth.updateUser({
      data: { avatar_url: publicUrl }
    });

    if (updateError) {
      status.textContent = "Upload succeeded, but failed to save to profile: " + updateError.message;
    } else {
      status.textContent = "Profile picture updated successfully!";
    }

    preview.src = publicUrl;
    preview.classList.remove("hidden");

    uploadBtn.disabled = false;
    uploadBtn.textContent = "Upload";
  });

  supabase.auth.onAuthStateChange((event, session) => {
    if (!session) window.location.href = "auth.html";
  });
});
</script>
<div class="container"><h2>Account Settings</h2><a href="index.html">← Back to Home</a><h3>Upload Profile Picture</h3><input accept="image/*" id="fileInput" type="file"/><div class="cropper-container"><img alt="Image Preview" id="preview" src=""/></div><button class="btn" id="uploadBtn">Save / Upload</button></div><script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const uploadBtn = document.getElementById('uploadBtn');
    let cropper;

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        preview.src = url;

        preview.onload = () => {
          if (cropper) cropper.destroy();
          cropper = new Cropper(preview, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            background: false,
            guides: false,
            autoCropArea: 1,
            cropBoxResizable: false,
            cropBoxMovable: false,
            ready() {
              const cropBox = document.querySelector('.cropper-crop-box');
              if (cropBox) cropBox.style.borderRadius = '50%';
            }
          });
        };
      }
    });

    uploadBtn.addEventListener('click', () => {
      if (cropper) {
        const canvas = cropper.getCroppedCanvas({
          width: 300,
          height: 300,
          imageSmoothingQuality: 'high'
        });

        canvas.toBlob((blob) => {
          const formData = new FormData();
          formData.append('avatar', blob, 'avatar.png');

          fetch('/upload-avatar', {
            method: 'POST',
            body: formData
          }).then(response => {
            if (response.ok) {
              alert('Avatar uploaded successfully!');
            } else {
              alert('Upload failed.');
            }
          });
        });
      }
    });
    </script></body>
</html>
