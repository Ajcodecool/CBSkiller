<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Connect Chat (Multi-Theme Demo)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<style>
        /* =======================================
           0. CORE VARIABLES (Base for Dark Theme)
           ======================================= */
        :root {
            --primary-bg: #1a1b2f;
            --content-bg: #2b2d42;
            --text-color: #f8f9fa;
            --accent-blue: #4cc9f0;
            --accent-green: #80ed99;
            --radius: 12px;
            --input-bg: #f8f9fa;
            --input-text: #1a1b2f;
            --message-bg-received: #3a3b5a;
            --message-bg-sent: #4cc9f0;
            --message-text-received: var(--text-color);
            --message-text-sent: #1a1b2f;
        }
        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s;
        }
        .chat-container {
            max-width: 800px;
            margin: 40px auto;
            background-color: var(--content-bg);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            height: 80vh;
            position: relative;
            transition: all 0.3s;
        }
        .chat-header {
            padding: 16px;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid #444;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(44, 46, 72, 0.8);
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .user-info img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-info span {
            font-weight: bold;
            color: var(--accent-blue);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .chat-input {
            border-top: 1px solid #444;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-input textarea {
            flex: 1;
            resize: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--input-text);
        }
        .chat-input button {
            background-color: var(--accent-blue);
            color: var(--input-text);
            font-weight: bold;
            padding: 10px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .chat-input button:hover {
            background-color: #6ce0ff;
        }
        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .message.self {
            justify-content: flex-end;
        }
        .message img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .message.self img {
            order: 2;
            margin-left: 12px;
            margin-right: 0;
        }
        .message-content {
            background-color: var(--message-bg-received);
            color: var(--message-text-received);
            padding: 10px 14px;
            border-radius: 10px;
            max-width: 70%;
        }
        .message.self .message-content {
            background-color: var(--message-bg-sent);
            color: var(--message-text-sent);
            border-top-right-radius: 2px;
        }
        .message-content .username {
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
        }
        .message.self .username {
            justify-content: flex-end;
        }
        .message-content .timestamp {
            font-size: 0.75rem;
            color: #ccc;
            margin-top: 4px;
            display: block;
        }
        .message.self .timestamp {
            text-align: right;
            color: rgba(0,0,0,0.6); /* Dark text color for readability on light blue bubble */
        }
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--accent-green);
            color: #1a1b2f;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s ease;
            z-index: 20;
        }
        .back-button:hover {
            background-color: #a0f0b0;
        }
        .mention {
            color: var(--accent-blue);
            font-weight: bold;
        }
        .verified-badge {
            width: 18px;
            height: 18px;
            margin-left: 2px;
            vertical-align: middle;
            display: inline-block;
        }
        #loading-older {
            color: #aaa;
            font-size: 0.95em;
            text-align: center;
            margin-bottom: 12px;
            margin-top: 2px;
        }

        /* =======================================
           1. LIGHT THEME OVERRIDES (.theme-light)
           ======================================= */
        .theme-light {
            --primary-bg: #f0f2f5;
            --content-bg: #ffffff;
            --text-color: #212529;
            --input-bg: #eeeeee;
            --input-text: #212529;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --message-bg-received: #e9ecef;
            --message-bg-sent: #007bff;
            --message-text-received: var(--text-color);
            --message-text-sent: #ffffff;
        }
        .theme-light .chat-container {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .theme-light .chat-header {
            border-bottom: 1px solid #dee2e6;
            color: var(--text-color);
        }
        .theme-light .user-info {
            background: rgba(230, 230, 230, 0.8);
        }
        .theme-light .chat-input {
            border-top: 1px solid #dee2e6;
        }
        .theme-light .message.self .message-content {
            border-top-right-radius: 10px; /* Reset modern corner */
        }

        /* =======================================
           2. WINDOWS 98 THEME OVERRIDES (.theme-win98)
           ======================================= */
        .theme-win98 {
            --win98-gray: #c0c0c0;
            --win98-dark-gray: #808080;
            --win98-white: #ffffff;
            --win98-blue: #000080;
            --win98-black: #000000;
            --win98-highlight: #fefefe;
            --win98-dark-shadow: #000000;

            --primary-bg: #008080; /* Teal desktop */
            --content-bg: var(--win98-gray);
            --text-color: var(--win98-black);
            --input-bg: var(--win98-white);
            --input-text: var(--win98-black);
            --message-bg-received: var(--win98-gray);
            --message-bg-sent: #008080; /* Teal for sent */
            --message-text-received: var(--win98-black);
            --message-text-sent: var(--win98-white);
            
            font-family: 'MS Sans Serif', 'Tahoma', sans-serif;
            font-size: 11px;
        }
        .theme-win98 .chat-container {
            border-radius: 0;
            border: 1px solid var(--win98-black);
            box-shadow: 4px 4px 0 0 var(--win98-dark-shadow);
        }
        .theme-win98 .chat-header {
            background-color: var(--win98-blue);
            color: var(--win98-white);
            border-bottom: none;
            padding: 3px 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .theme-win98 .user-info {
            background: none;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            color: var(--win98-white);
        }
        .theme-win98 .user-info span, .theme-win98 .user-info img {
            display: none; /* Hide in Win98 title bar */
        }
        .theme-win98 .chat-messages {
            padding: 8px;
            /* Sunken box for chat history */
            border-top: 1px solid var(--win98-dark-gray);
            border-left: 1px solid var(--win98-dark-gray);
            border-right: 1px solid var(--win98-highlight);
            border-bottom: 1px solid var(--win98-highlight);
            margin: 4px;
        }
        .theme-win98 .chat-input {
            border-top: none;
            padding: 4px;
        }
        .theme-win98 .chat-input textarea {
            border-radius: 0;
            border-top: 1px solid var(--win98-dark-gray);
            border-left: 1px solid var(--win98-dark-gray);
            border-right: 1px solid var(--win98-highlight);
            border-bottom: 1px solid var(--win98-highlight);
            padding: 3px;
        }
        .theme-win98 button, .theme-win98 .back-button, .theme-win98 #theme-selector {
            background-color: var(--win98-gray) !important;
            color: var(--win98-black) !important;
            border-radius: 0 !important;
            padding: 3px 8px !important;
            font-weight: normal !important;
            border: 1px solid var(--win98-dark-gray);
            box-shadow: none !important;
            transition: none;
            border-top: 1px solid var(--win98-highlight);
            border-left: 1px solid var(--win98-highlight);
            border-right: 1px solid var(--win98-dark-gray);
            border-bottom: 1px solid var(--win98-dark-gray);
        }
        .theme-win98 button:active, .theme-win98 .back-button:active {
            border-top: 1px solid var(--win98-dark-gray) !important;
            border-left: 1px solid var(--win98-dark-gray) !important;
            border-right: 1px solid var(--win98-highlight) !important;
            border-bottom: 1px solid var(--win98-highlight) !important;
            padding: 4px 7px 2px 9px !important; 
        }
        .theme-win98 .back-button { top: 10px; left: 10px; }
        /* Avatars are now correctly displayed by default message styles */
        .theme-win98 .message-content { border-radius: 0; padding: 2px 5px; }
        .theme-win98 .message.self .message-content { border-top-right-radius: 0; }
        .theme-win98 .message-content .username { color: var(--win98-blue); margin-bottom: 2px; }
        .theme-win98 .message-content .timestamp { color: var(--win98-dark-gray); font-size: 9px; }
        .theme-win98 .verified-badge { filter: grayscale(1); }

        /* =======================================
           3. WINDOWS 7 AERO THEME OVERRIDES (.theme-win7)
           ======================================= */
        .theme-win7 {
            --win7-blue: #0078D7;
            --win7-light-blue: #D9E8F6;
            --win7-dark-blue: #003761;
            --win7-glass-bg: rgba(255, 255, 255, 0.3);
            --win7-glow: rgba(0, 110, 192, 0.7);

            --primary-bg: #80c0ff; /* Light, bright desktop color */
            --content-bg: var(--win7-glass-bg);
            --text-color: var(--win7-dark-blue);
            --input-bg: #ffffff;
            --input-text: #000000;
            --accent-blue: var(--win7-blue);
            --accent-green: #38a938;
            --radius: 8px;
            --message-bg-received: #E6E8E9;
            --message-bg-sent: var(--win7-light-blue);
            --message-text-received: #000000;
            --message-text-sent: #000000;
            font-family: 'Segoe UI', 'Tahoma', sans-serif;
        }
        .theme-win7 .chat-container {
            background-color: var(--win7-glass-bg);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); /* Big shadow effect */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .theme-win7 .chat-header {
            background: linear-gradient(to bottom, var(--win7-blue) 0%, #005aa0 100%);
            color: #ffffff;
            border-bottom: 1px solid var(--win7-dark-blue);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            border-top-left-radius: 7px;
            border-top-right-radius: 7px;
        }
        .theme-win7 .user-info {
            background: none;
            color: #fff;
            box-shadow: none;
        }
        .theme-win7 .user-info span {
            color: #ffffff;
            text-shadow: 1px 1px 1px var(--win7-dark-blue);
        }
        .theme-win7 .chat-input {
            border-top: 1px solid var(--win7-blue);
        }
        .theme-win7 .chat-input button {
            background-color: var(--win7-blue);
            color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid var(--win7-dark-blue);
        }
        .theme-win7 .chat-input button:hover {
            background-color: #005aa0;
        }
        .theme-win7 .message-content .timestamp {
            color: #555;
        }
        .theme-win7 .message.self .message-content {
            border-top-right-radius: 8px;
            border-top-left-radius: 8px; /* Standard rounding */
            border-bottom-right-radius: 8px;
        }

        /* =======================================
           4. iOS IMESSAGE THEME OVERRIDES (.theme-ios)
           ======================================= */
        .theme-ios {
            --primary-bg: #f8f8f8;
            --content-bg: #ffffff;
            --text-color: #000000;
            --input-bg: #ffffff;
            --input-text: #000000;
            --accent-blue: #007aff; /* Apple Blue */
            --accent-green: #34c759; /* Apple Green */
            --radius: 20px;
            --message-bg-received: #e5e5ea;
            --message-bg-sent: var(--accent-green);
            --message-text-received: #000000;
            --message-text-sent: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji';
        }
        .theme-ios .chat-container {
            box-shadow: none;
            border: none;
            background-color: transparent;
            margin-top: 0;
            height: 100vh;
        }
        .theme-ios .chat-header {
            background-color: var(--content-bg);
            border-bottom: 1px solid #c8c7cc;
            font-size: 1.1rem;
            text-align: center;
            justify-content: center;
        }
        .theme-ios .user-info {
            display: none !important; /* Hide user status in iOS header style */
        }
        .theme-ios .chat-messages {
            padding: 10px;
            background-color: var(--primary-bg);
        }
        .theme-ios .chat-input {
            background-color: #f6f6f6;
            border-top: 1px solid #c8c7cc;
            padding: 8px 10px;
        }
        .theme-ios .chat-input textarea {
            border-radius: 20px;
            border: 1px solid #d1d1d6;
            background-color: #ffffff;
            padding: 8px 15px;
            font-size: 0.95rem;
            min-height: 20px;
            line-height: normal;
        }
        .theme-ios .chat-input button {
            background-color: var(--accent-blue);
            color: #ffffff;
            border-radius: 20px;
            padding: 8px 12px;
        }
        .theme-ios .message {
            margin-bottom: 6px;
            align-items: flex-end;
        }
        .theme-ios .message.self img {
            /* Keep standard self avatar styling if you want it to appear on the right */
            margin-left: 12px;
            margin-right: 0;
            order: 2;
        }
        .theme-ios .message-content {
            padding: 8px 12px;
            max-width: 80%;
            font-size: 0.95rem;
            color: var(--message-text-received);
            background-color: var(--message-bg-received);
            /* Standard Bubble shape */
            border-radius: 20px 20px 20px 5px; 
            box-shadow: 0 1px 0 rgba(0,0,0,0.08);
        }
        .theme-ios .message.self .message-content {
            color: var(--message-text-sent);
            background-color: var(--message-bg-sent);
            /* Sent Bubble shape (Green/Blue) */
            border-radius: 20px 20px 5px 20px;
        }
        .theme-ios .message-content .username {
            display: none; /* No usernames in iMessage bubbles */
        }
        .theme-ios .message-content .timestamp {
            display: none; /* Timestamps usually appear on scroll/tap */
        }
        .theme-ios .back-button {
            top: 10px;
            left: 10px;
            background-color: transparent;
            color: var(--accent-blue);
            font-weight: normal;
            box-shadow: none;
            padding: 5px 10px;
        }
        .theme-ios .back-button:hover {
            background-color: transparent;
            color: var(--accent-blue);
        }

        /* =======================================
           5. MSN MESSENGER THEME OVERRIDES (.theme-msn)
           ======================================= */
        .theme-msn {
            --msn-green: #5eb604;
            --msn-blue: #0087cb;
            --msn-light-bg: #e6f7ff;
            --msn-window-bg: #ffffff;
            --msn-text: #000000;
            --msn-input-border: #99c9ed;
            --msn-header-bg: linear-gradient(to top, #c7e5fc 0%, #e8f5ff 100%);
            --msn-message-bg-received: #e0f2ff;
            --msn-message-bg-sent: var(--msn-green);

            --primary-bg: var(--msn-light-bg); /* Background desktop */
            --content-bg: var(--msn-window-bg);
            --text-color: var(--msn-text);
            --input-bg: var(--msn-window-bg);
            --input-text: var(--msn-text);
            --accent-blue: var(--msn-blue);
            --accent-green: var(--msn-green);
            --radius: 4px; /* Slightly boxier, but still rounded */
            --message-bg-received: var(--msn-message-bg-received);
            --message-bg-sent: var(--msn-message-bg-sent);
            --message-text-received: var(--msn-text);
            --message-text-sent: #ffffff;
            font-family: 'Tahoma', 'Arial', sans-serif;
        }

        .theme-msn .chat-container {
            border-radius: 6px;
            border: 1px solid #7cb1df;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-height: 80vh; /* Fixed height for classic look */
        }
        .theme-msn .chat-header {
            background: var(--msn-header-bg);
            color: var(--msn-blue);
            font-size: 1.2rem;
            border-bottom: 1px solid #c7e5fc;
            padding: 8px 16px;
            justify-content: flex-start;
            gap: 16px;
        }
        .theme-msn .chat-header .text-xl {
            flex-grow: 1;
        }
        .theme-msn .user-info {
            background: #fff;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            order: -1; /* Place user info first */
        }
        .theme-msn .user-info img {
            width: 24px;
            height: 24px;
            border: 1px solid #ccc;
        }
        .theme-msn .user-info span {
            color: var(--msn-blue);
        }
        .theme-msn #theme-selector {
            background-color: var(--msn-window-bg);
            color: var(--msn-text);
            border: 1px solid var(--msn-input-border);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .theme-msn .chat-messages {
            padding: 10px;
            background-color: var(--msn-window-bg);
        }
        .theme-msn .message {
            margin-bottom: 8px;
            align-items: flex-end; /* MSN style often has avatar on bottom of bubble stack */
        }
        .theme-msn .message img {
            width: 32px;
            height: 32px;
            margin-right: 8px;
        }
        .theme-msn .message.self img {
            margin-left: 8px;
            margin-right: 0;
        }

        /* Message Bubbles */
        .theme-msn .message-content {
            padding: 6px 10px;
            max-width: 80%;
            font-size: 0.85rem;
            border-radius: 12px 12px 12px 4px; /* MSN has rounded ends, pointy corner on opposite bottom */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .theme-msn .message.self .message-content {
            background-color: var(--msn-message-bg-sent);
            color: var(--message-text-sent);
            border-radius: 12px 12px 4px 12px; /* Pointy corner on self side */
            border: 1px solid #458d03;
        }
        .theme-msn .message-content .username {
            font-size: 0.8rem;
            margin-bottom: 2px;
            color: var(--msn-blue);
        }
        .theme-msn .message.self .username {
            color: #ffffff; /* User name blends into green background */
        }
        .theme-msn .message-content .timestamp {
            font-size: 0.65rem;
            color: #666;
        }
        .theme-msn .message.self .timestamp {
            color: rgba(255,255,255,0.7);
        }

        .theme-msn .chat-input {
            border-top: 1px solid #ccc;
            background-color: #f0f0f0;
            padding: 8px;
        }
        .theme-msn .chat-input textarea {
            border-radius: 4px;
            border: 1px solid var(--msn-input-border);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            background-color: #fff;
            padding: 5px;
        }
        .theme-msn .chat-input button {
            background: linear-gradient(to bottom, #fcfcfc 0%, #e0e0e0 100%);
            color: var(--msn-blue);
            font-weight: bold;
            border: 1px solid #8ba8c3;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            padding: 6px 12px;
            border-radius: 4px;
        }
        .theme-msn .chat-input button:hover {
             background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
        }
        .theme-msn .back-button {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #8ba8c3;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .theme-msn .back-button:hover {
            background-color: #ffffff;
        }
        
        /* =======================================
           6. DOS THEME OVERRIDES (.theme-dos)
           ======================================= */
        .theme-dos {
            --primary-bg: #000000;
            --content-bg: #000000;
            --text-color: #00ff00; /* Bright Green */
            --accent-blue: #00ffff; /* Cyan */
            --accent-green: #00ff00;
            --input-bg: #000000;
            --input-text: #00ff00;
            --message-bg-received: #000000;
            --message-bg-sent: #000000;
            --message-text-received: var(--text-color);
            --message-text-sent: #ffffff; /* White text on black for sent to stand out slightly */
            --radius: 0;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
        }
        .theme-dos .chat-container {
            border-radius: 0;
            box-shadow: none;
            border: 2px solid var(--text-color);
            margin: 20px auto;
            max-width: 700px;
        }
        .theme-dos .chat-header {
            background-color: #000080; /* Blue Title Bar */
            color: #ffffff; /* White text */
            border-bottom: 2px solid var(--text-color);
            padding: 4px 8px;
            font-size: 1.1rem;
            justify-content: flex-start;
        }
        .theme-dos .user-info, .theme-dos .message img, .theme-dos .verified-badge, .theme-dos .chat-header .text-xl {
            display: none !important;
        }
        .theme-dos .chat-header > .text-xl {
            display: block !important;
            font-size: 1.1rem;
        }
        .theme-dos .chat-messages {
            padding: 8px;
            color: var(--text-color);
            line-height: 1.2;
        }
        .theme-dos .message {
            margin-bottom: 2px; /* Tight spacing */
            align-items: flex-start;
        }
        .theme-dos .message-content {
            background-color: transparent;
            color: var(--text-color);
            padding: 0;
            border-radius: 0;
            max-width: 100%;
        }
        .theme-dos .message.self .message-content {
            background-color: transparent;
            color: var(--message-text-sent);
        }
        .theme-dos .message-content .username {
            font-weight: normal;
            margin-bottom: 0;
            color: var(--accent-blue);
            display: inline;
        }
        .theme-dos .message.self .username {
            color: var(--accent-green);
        }
        .theme-dos .message-content .timestamp {
            display: none;
        }
        .theme-dos .chat-input {
            border-top: 2px solid var(--text-color);
            padding: 8px;
            background-color: var(--input-bg);
        }
        .theme-dos .chat-input textarea {
            border: 1px solid var(--text-color);
            background-color: var(--input-bg);
            color: var(--input-text);
            border-radius: 0;
            padding: 5px;
            box-shadow: none;
        }
        .theme-dos .chat-input button {
            background-color: #000080 !important;
            color: #ffffff !important;
            border-radius: 0 !important;
            padding: 5px 10px !important;
            border: 1px solid #ffffff;
            font-weight: normal;
        }
        .theme-dos .back-button, .theme-dos #theme-selector {
            background-color: #000080 !important;
            color: #ffffff !important;
            border-radius: 0 !important;
            padding: 4px 8px !important;
            border: 1px solid #ffffff;
            font-weight: normal;
            top: 10px;
            left: 10px;
        }
        .theme-dos .mention {
            color: var(--accent-blue);
        }
        
        /* =======================================
           7. WINDOWS XP BLISS THEME OVERRIDES (.theme-xp)
           ======================================= */
        .theme-xp {
            --xp-blue: #3665a3; /* Classic Blue Title Bar */
            --xp-green-bg: #d4e8c3; /* Light Green Message Area */
            --xp-white: #ffffff;
            --xp-button-bg: #e0e9f1;

            --primary-bg: #3a6ea5; /* XP desktop blue */
            --content-bg: var(--xp-white);
            --text-color: #000000;
            --input-bg: var(--xp-white);
            --input-text: #000000;
            --accent-blue: #0055b3; /* Deep XP blue */
            --accent-green: #378e37; /* XP Send button green */
            --radius: 4px;
            --message-bg-received: #e6f1f9; /* Light blue received */
            --message-bg-sent: #d5efc1; /* Light green sent */
            --message-text-received: #000000;
            --message-text-sent: #000000;
            font-family: 'Tahoma', 'Verdana', sans-serif;
        }
        .theme-xp .chat-container {
            border-radius: 8px;
            border: 1px solid #8e8e8e;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .theme-xp .chat-header {
            background: linear-gradient(to right, #4a8df4 0%, #3665a3 100%);
            color: var(--xp-white);
            border-bottom: 1px solid #8e8e8e;
            border-top-left-radius: 7px;
            border-top-right-radius: 7px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
            font-size: 1.25rem;
        }
        .theme-xp .user-info {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc;
            box-shadow: none;
        }
        .theme-xp .user-info span {
            color: var(--xp-blue);
        }
        .theme-xp .chat-messages {
            padding: 12px;
            background-color: var(--xp-green-bg);
        }
        .theme-xp .chat-input {
            border-top: 1px solid #d4d4d4;
            padding: 8px;
            background-color: var(--xp-button-bg);
        }
        .theme-xp .chat-input textarea {
            border: 1px solid #7f9db9;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            background-color: var(--xp-white);
            padding: 6px;
        }
        .theme-xp .chat-input button {
            background: linear-gradient(to top, #7fa9e0 0%, #aed3e8 100%);
            color: #000000;
            border: 1px solid #003c74;
            font-weight: bold;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.7);
            padding: 6px 14px;
        }
        .theme-xp .chat-input button:hover {
            background: linear-gradient(to top, #659be6 0%, #88c8f0 100%);
        }
        
        .theme-xp .message-content {
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            padding: 8px 12px;
            border: 1px solid #ccc;
        }
        .theme-xp .message.self .message-content {
            border-radius: 12px;
            border: 1px solid #99b685;
        }
        .theme-xp .message-content .username {
            font-weight: bold;
            color: var(--accent-blue);
        }
        .theme-xp .message.self .username {
            color: var(--accent-green);
        }
        .theme-xp .message-content .timestamp {
            color: #6a6a6a;
            font-size: 0.7rem;
        }
        .theme-xp .back-button {
            background: linear-gradient(to top, #7fa9e0 0%, #aed3e8 100%);
            color: #000000;
            border: 1px solid #003c74;
            font-weight: bold;
        }


    
.message.self:hover .delete-icon {
  display: inline-block;
}
.delete-icon {
  display: none;
  cursor: pointer;
  margin-left: 8px;
  color: var(--accent-red);
}

</style>
<script>
    // A check to ensure the user is logged in before allowing them to view the chat.
    if (sessionStorage.getItem("loggedIn") !== "true") {
      window.location.href = "auth.html";
    }
</script>
<body class="theme-dark">
<a class="back-button" href="index.html">← Back to Home</a>
<div class="chat-container">
<div class="chat-header">
<div class="text-xl">Crooms Connect Chat</div>
<select class="p-2 rounded-md bg-gray-700 text-white text-sm font-semibold transition duration-150" id="theme-selector">
<option value="dark">Modern Dark</option>
<option value="light">Light</option>
<option value="win98">Windows 98</option>
<option value="win7">Windows 7 Aero</option>
<option value="ios">iOS iMessage</option>
<option value="msn">MSN Messenger</option>
<option value="dos">DOS Terminal</option>
<option value="xp">Windows XP Bliss</option>
</select>
<div class="user-info" id="user-info" style="display: none;">
<img alt="avatar" id="user-avatar" src="https://api.dicebear.com/6.x/thumbs/svg?seed=Anonymous"/>
<span id="user-name">Loading...</span>
<img alt="verified" class="verified-badge" id="user-verified" src="verify.png" style="display:none;" title="Verified"/>
</div>
</div>
<div class="chat-messages" id="chat-box">
<div id="loading-older" style="display:none">Loading...</div>
</div>
<div class="chat-input">
<textarea id="chat-input" placeholder="Type your message..." rows="2"></textarea>
<button id="send-button" onclick="handleSendClick()">Send</button>
</div>
</div>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // === THEME MANAGEMENT FUNCTIONS ===
    const themeSelector = document.getElementById('theme-selector');
    const themeKey = 'chatTheme';

    function setSavedTheme() {
        // Default changed to 'dark' for consistency
        const savedTheme = localStorage.getItem(themeKey) || 'dark'; 
        document.body.className = ''; 
        
        // Add the theme class
        if (savedTheme === 'win98') document.body.classList.add('theme-win98');
        else if (savedTheme === 'light') document.body.classList.add('theme-light');
        else if (savedTheme === 'win7') document.body.classList.add('theme-win7');
        else if (savedTheme === 'ios') document.body.classList.add('theme-ios');
        else if (savedTheme === 'msn') document.body.classList.add('theme-msn');
        else if (savedTheme === 'dos') document.body.classList.add('theme-dos'); // Added DOS theme check
        else if (savedTheme === 'xp') document.body.classList.add('theme-xp'); // Added XP theme check
        else document.body.classList.add('theme-dark');

        // Update the selector value
        if (themeSelector.querySelector(`option[value="${savedTheme}"]`)) {
             themeSelector.value = savedTheme;
        } else {
             themeSelector.value = 'dark'; // Fallback
        }
    }

    function handleThemeChange() {
        const newTheme = themeSelector.value;
        localStorage.setItem(themeKey, newTheme);
        setSavedTheme();
        fullRefreshMessages(); 
    }
    // ===================================

    // === REPLACED DEBUG LOGGING FUNCTION ===
    function debugLog(...args) {
        console.log('DEBUG:', ...args);
    }

    // Supabase Configuration 
    const SUPABASE_URL = 'https://jxxnfsydjrflnephmfjm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const chatBox = document.getElementById('chat-box');
    const loadingOlderDiv = document.getElementById('loading-older');
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-button');
    const userInfoDiv = document.getElementById('user-info');
    const userAvatarImg = document.getElementById('user-avatar');
    const userNameSpan = document.getElementById('user-name');
    const userVerifiedImg = document.getElementById('user-verified');

    // Make currentUser accessible globally to the handleSendClick function
    window.currentUser = null; 
    let currentUsername = 'Anonymous';
    let currentUserIsVerified = false;

    // Infinite scroll state
    const PAGE_SIZE = 20;
    let loadedMessages = []; 
    let loadingOlder = false;
    let allOlderLoaded = false;
    let totalMessageCount = null; 

    // --- CACHE FOR PROFILE VERIFICATION ---
    const verifiedCache = {};
    function clearVerifiedCache() {
        for (const key in verifiedCache) {
            delete verifiedCache[key];
        }
    }

    // Clean username helper
    function cleanUsername(name) {
        if (!name) return "Anonymous";
        if (typeof name !== 'string') return name;
        return name.replace(/@croomsconnect\.local$/i, '');
    }

    // Async check if a username is verified (with caching)
    async function isUserVerified(username) {
        if (verifiedCache.hasOwnProperty(username)) return verifiedCache[username];
        const { data, error } = await supabase
            .from('profiles')
            .select('is_verified')
            .eq('username', username)
            .single();
        const verified = !!(data && data.is_verified);
        verifiedCache[username] = verified;
        return verified;
    }

    async function updateGlobalAvatarAndName() {
        const { data: authData, error: authErr } = await supabase.auth.getUser();
        
        if (!authData?.user) {
            // Update global state and redirect (redundant, but safety net for page load)
            window.currentUser = null;
            window.location.href = "auth.html";
            return;
        }

        const userId = authData.user.id;
        const { data: profile } = await supabase
            .from("profiles")
            .select("username, is_verified")
            .eq("id", userId)
            .single();

        // Update global state
        window.currentUser = authData.user;
        currentUsername = cleanUsername(profile?.username) || "Anonymous";
        currentUserIsVerified = !!profile?.is_verified;
        
        const customAvatar = authData.user.user_metadata?.avatar_url;
        userAvatarImg.src = customAvatar && customAvatar.trim() !== ""
            ? customAvatar
            : `https://api.dicebear.com/6.x/thumbs/svg?seed=${encodeURIComponent(currentUsername)}`;
        userNameSpan.textContent = currentUsername;
        userVerifiedImg.style.display = currentUserIsVerified ? "" : "none";
        userInfoDiv.style.display = 'flex';
    }

    function cleanMessageMentions(text) {
        return text.replace(/@([a-zA-Z0-9_@.]+)/g, (match, mentionName) => {
            let clean = mentionName;
            if (clean.toLowerCase().endsWith('@croomsconnect.local')) {
                clean = clean.slice(0, -'@croomsconnect.local'.length);
            }
            return `<span class="mention">@${clean}</span>`;
        });
    }

    // async displayMessage to allow for verified badge lookup and theme-based styling
    async function displayMessage(msg) {
        // Use the globally exposed currentUser for checks
        const isSelf = window.currentUser && msg.user_id === window.currentUser.id; 
        const username = cleanUsername(msg.username) || "Anonymous";
        const avatarSrc = msg.avatar_url && msg.avatar_url.trim() !== ""
            ? msg.avatar_url
            : `https://api.dicebear.com/6.x/thumbs/svg?seed=${encodeURIComponent(username)}`;
        const div = document.createElement('div');
        
        // Determine theme-specific classes
        const theme = localStorage.getItem(themeKey) || 'dark';
        const isDOS = theme === 'dos'; // Check for DOS

        div.className = `message ${isSelf ? 'self' : 'other'}`;
        div.dataset.userId = msg.user_id;
        div.dataset.timestamp = msg.timestamp; 

        const verified = await isUserVerified(msg.username);
        // Only hide avatar inline for DOS, letting CSS rules for other themes apply, or for them to show by default.
        const avatarStyle = (isDOS) ? 'display: none;' : 'display: block;'; 
        const timestampText = new Date(msg.timestamp).toLocaleTimeString();
        
        // In DOS theme, we want a simple [username] message format without bubbles, timestamps, or badges inside the message content div for purity.
        if (isDOS) {
            div.innerHTML = `
                <div class="message-content">
                    <span class="username">${username}</span>: <span class="text">${cleanMessageMentions(msg.message)}</span>
                </div>
            `;
        } else {
            // All other themes use the bubble-style content
            div.innerHTML = `
                <img src="${avatarSrc}" alt="avatar" style="${avatarStyle}">
                <div class="message-content">
                    <div class="username">
                        ${username}
                        ${verified ? `<img src="verify.png" class="verified-badge" alt="verified" title="Verified">` : ""}
                    </div>
                    <div class="text">${cleanMessageMentions(msg.message)}</div>
                    <div class="timestamp">${timestampText}</div>
                </div>
            `;
        }
        
        chatBox.appendChild(div);
    }

    // Render all messages (with enhanced scroll logic for all scenarios)
    async function renderMessages(isInitialLoad = false, isLoadingOlder = false, oldScrollHeight = 0, oldScrollTop = 0) {
        const chatBoxHeight = chatBox.clientHeight;
        
        // 1. Capture Scroll State
        // Determine if user was at the bottom (within 20px tolerance)
        const wasScrolledToBottom = oldScrollTop + chatBoxHeight >= oldScrollHeight - 20;
        
        // Calculate distance from bottom BEFORE clearing content (used for theme refresh restoration)
        let distanceFromBottom = oldScrollHeight - (oldScrollTop + chatBoxHeight);
        if (oldScrollHeight === 0) distanceFromBottom = 0;

        // 2. Clear and Render
        chatBox.innerHTML = '';
        chatBox.appendChild(loadingOlderDiv);

        // Await all message rendering to ensure DOM elements are created
        for (const msg of loadedMessages) {
            await displayMessage(msg);
        }
        
        // 3. Defer Scroll Adjustment (Fix for Glitches)
        // Use setTimeout for all scroll adjustments to ensure they happen *after* the DOM reflow is complete.
        setTimeout(() => {
            const currentScrollHeight = chatBox.scrollHeight;
            const currentChatBoxHeight = chatBox.clientHeight;

            if (isInitialLoad || (wasScrolledToBottom && !isLoadingOlder)) {
                // Scenario A: Initial Load, New Message (when user was at bottom)
                chatBox.scrollTop = currentScrollHeight;
            } else if (isLoadingOlder) {
                // Scenario B: Loading Older Messages: Keep the visual position steady.
                const diff = currentScrollHeight - oldScrollHeight;
                chatBox.scrollTop = oldScrollTop + diff;
            } else {
                // Scenario C: Theme Change/Refresh when scrolled up: Maintain relative position from the bottom.
                chatBox.scrollTop = currentScrollHeight - currentChatBoxHeight - distanceFromBottom;
            }
        }, 0);
    }


    async function fetchTotalMessageCount() {
        const { count } = await supabase
            .from('messages')
            .select('id', { count: 'exact', head: true });
        return count || 0;
    }

    async function loadInitialMessages() {
        totalMessageCount = await fetchTotalMessageCount();
        const start = Math.max(0, totalMessageCount - PAGE_SIZE);
        const end = totalMessageCount - 1;
        const { data } = await supabase
            .from('messages')
            .select('user_id, username, avatar_url, message, timestamp')
            .order('timestamp', { ascending: true })
            .range(start, end);

        loadedMessages = data || [];
        if (loadedMessages.length < PAGE_SIZE) allOlderLoaded = true;
        
        loadingOlderDiv.style.display = allOlderLoaded ? 'none' : 'block';
        // Call renderMessages for initial load
        await renderMessages(true, false, 0, 0);
    }

    async function loadOlderMessages() {
        if (loadingOlder || allOlderLoaded) return;
        loadingOlder = true;
        loadingOlderDiv.style.display = '';
        
        // Capture scroll state before load
        const oldScrollHeight = chatBox.scrollHeight; 
        const oldScrollTop = chatBox.scrollTop;
        
        const messagesToLoad = PAGE_SIZE;
        const currentlyLoaded = loadedMessages.length;
        const start = Math.max(0, totalMessageCount - currentlyLoaded - messagesToLoad);
        const end = totalMessageCount - currentlyLoaded - 1;
        
        if (end < start) {
            loadingOlder = false;
            loadingOlderDiv.style.display = 'none';
            allOlderLoaded = true;
            return;
        }
        
        const { data } = await supabase
            .from('messages')
            .select('user_id, username, avatar_url, message, timestamp')
            .order('timestamp', { ascending: true })
            .range(start, end);
        
        if (data && data.length > 0) {
            loadedMessages = [...data, ...loadedMessages];
            if (data.length < PAGE_SIZE) allOlderLoaded = true;
            
            // Call renderMessages with loadingOlder=true and captured scroll state
            await renderMessages(false, true, oldScrollHeight, oldScrollTop);
            
        } else {
            allOlderLoaded = true;
        }
        loadingOlder = false;
        loadingOlderDiv.style.display = 'none';
    }

    function handleScroll() {
        if (chatBox.scrollTop < 100 && !loadingOlder && !allOlderLoaded) {
            loadOlderMessages();
        }
    }
    
    // --- UPDATED sendMessage: THROWS ON ERROR ---
    async function sendMessage() {
        const message = input.value.trim();
        // Check for empty message
        if (!message) {
            return;
        }

        // 1. Fetch profile
        const { data: profile, error: profileErr } = await supabase
            .from('profiles')
            .select('username')
            .eq('id', window.currentUser.id)
            .single();
        
        if (profileErr) throw new Error("Could not fetch profile for message.");

        const username = profile?.username || 'Anonymous'; 
        const avatar_url = window.currentUser.user_metadata?.avatar_url || '';
        
        // 2. Insert message
        const { error: insertErr } = await supabase.from('messages').insert([{
            user_id: window.currentUser.id,
            username,
            avatar_url,
            message,
            timestamp: new Date().toISOString()
        }]);

        if (insertErr) {
            throw new Error("Failed to insert message into database.");
        }

        // 3. Clear input only on success
        input.value = '';
    }

    function subscribeToMessages() {
        supabase
            .channel('messages-channel')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
                const oldScrollHeight = chatBox.scrollHeight;
                const oldScrollTop = chatBox.scrollTop;
                
                if (!loadedMessages.some(m => m.timestamp === payload.new.timestamp && m.user_id === payload.new.user_id)) {
                    loadedMessages.push(payload.new);
                    // Use robust scroll logic for new messages
                    totalMessageCount += 1;
                    await renderMessages(false, false, oldScrollHeight, oldScrollTop);
                }
            })
            .subscribe();
    }

    async function fullRefreshMessages() {
        if (loadingOlder) return; 
        
        clearVerifiedCache();

        // Capture scroll state before refresh
        const oldScrollHeight = chatBox.scrollHeight;
        const oldScrollTop = chatBox.scrollTop;

        // Ensure we load enough messages to cover the current view plus the page size
        const messagesToLoad = loadedMessages.length + PAGE_SIZE; 
        totalMessageCount = await fetchTotalMessageCount(); 
        
        const start = Math.max(0, totalMessageCount - messagesToLoad);
        const end = totalMessageCount - 1;

        const { data, error } = await supabase
            .from('messages')
            .select('user_id, username, avatar_url, message, timestamp')
            .order('timestamp', { ascending: true })
            .range(start, end);

        if (error) {
            console.error("Error during refresh fetch:", error);
            return;
        }

        loadedMessages = data || [];
        allOlderLoaded = (totalMessageCount - loadedMessages.length) <= 0;
        loadingOlderDiv.style.display = allOlderLoaded ? 'none' : 'block';

        // Call renderMessages with captured state for theme refresh
        await renderMessages(false, false, oldScrollHeight, oldScrollTop); 
        await updateGlobalAvatarAndName();
    }

    // === GLOBAL HANDLER: UPDATED WITH RELIABILITY LOCK ===
    window.handleSendClick = async function() {
        if (!window.currentUser) { 
            alert("You must be signed in to send messages.");
            window.location.href = "auth.html";
            return false;
        }

        // 1. Check for empty message early
        if (input.value.trim() === "") {
            return false;
        }
        
        // 2. Disable controls to prevent double submission
        input.disabled = true;
        sendBtn.disabled = true;

        try {
            await sendMessage(); // Calls the module's Supabase-enabled sendMessage
            return true;
        } catch (e) {
            console.error("Send error:", e);
            alert("Failed to send message: " + e.message);
            return false;
        } finally {
            // 3. Re-enable controls and focus the input regardless of success/failure
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus(); 
        }
    }
    // ===============================================

    // Event listeners
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            // Enter key also calls the robust global handler
            window.handleSendClick();
        }
    });

    chatBox.addEventListener('scroll', handleScroll);
    themeSelector.addEventListener('change', handleThemeChange);

    document.addEventListener('DOMContentLoaded', async () => {
        setSavedTheme(); 
        await updateGlobalAvatarAndName();
        await loadInitialMessages();
        subscribeToMessages();
        supabase.auth.onAuthStateChange(() => updateGlobalAvatarAndName());

        // FIX: The periodic refresh has been removed to stop non-user-initiated scroll jumps.
        // Theme changes will still trigger a refresh via handleThemeChange.
    });

    // --- DEMO: Ensure AJTech@croomsconnect.local is verified for badge demo
    (async function ensureAJTechVerified() {
        // This function ensures the demo badge works by setting the verification status.
        const { data } = await supabase
            .from('profiles')
            .select('is_verified')
            .eq('username', 'AJTech@croomsconnect.local')
            .single();
        if (data && !data.is_verified) {
            await supabase
                .from('profiles')
                .update({ is_verified: true })
                .eq('username', 'AJTech@croomsconnect.local');
        }
    })();
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("chat-box").addEventListener("click", function(e) {
    if (e.target.classList.contains("delete-icon")) {
      const messageDiv = e.target.closest(".message");
      if (messageDiv && messageDiv.classList.contains("self")) {
        messageDiv.remove();
      }
    }
  });
});
</script>
</body>
</html>
