<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Connect Chat (Multi-Theme Demo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        /* =======================================
           0. CORE VARIABLES (Base for Dark Theme)
           ======================================= */
        :root {
            --primary-bg: #1a1b2f;
            --content-bg: #2b2d42;
            --text-color: #f8f9fa;
            --accent-blue: #4cc9f0;
            --accent-green: #80ed99;
            --radius: 12px;
            --input-bg: #f8f9fa;
            --input-text: #1a1b2f;
            --message-bg-received: #3a3b5a;
            --message-bg-sent: #4cc9f0;
            --message-text-received: var(--text-color);
            --message-text-sent: #1a1b2f;
        }
        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s;
        }
        .chat-container {
            max-width: 800px;
            margin: 40px auto;
            background-color: var(--content-bg);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            height: 80vh;
            position: relative;
            transition: all 0.3s;
        }
        .chat-header {
            padding: 16px;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid #444;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(44, 46, 72, 0.8);
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .user-info img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-info span {
            font-weight: bold;
            color: var(--accent-blue);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .chat-input {
            border-top: 1px solid #444;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-input textarea {
            flex: 1;
            resize: none;
            border-radius: 8px;
            padding: 10px;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--input-text);
        }
        .chat-input button {
            background-color: var(--accent-blue);
            color: var(--input-text);
            font-weight: bold;
            padding: 10px 16px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        .chat-input button:hover {
            background-color: #6ce0ff;
        }
        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .message.self {
            justify-content: flex-end;
        }
        .message img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .message.self img {
            order: 2;
            margin-left: 12px;
            margin-right: 0;
        }
        .message-content {
            background-color: var(--message-bg-received);
            color: var(--message-text-received);
            padding: 10px 14px;
            border-radius: 10px;
            max-width: 70%;
        }
        .message.self .message-content {
            background-color: var(--message-bg-sent);
            color: var(--message-text-sent);
            border-top-right-radius: 2px;
        }
        .message-content .username {
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
        }
        .message.self .username {
            justify-content: flex-end;
        }
        .message-content .timestamp {
            font-size: 0.75rem;
            color: #ccc;
            margin-top: 4px;
            display: block;
        }
        .message.self .timestamp {
            text-align: right;
            color: rgba(0,0,0,0.6); /* Dark text color for readability on light blue bubble */
        }
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--accent-green);
            color: #1a1b2f;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s ease;
            z-index: 20;
        }
        .back-button:hover {
            background-color: #a0f0b0;
        }
        .mention {
            color: var(--accent-blue);
            font-weight: bold;
        }
        .verified-badge {
            width: 18px;
            height: 18px;
            margin-left: 2px;
            vertical-align: middle;
            display: inline-block;
        }
        #loading-older {
            color: #aaa;
            font-size: 0.95em;
            text-align: center;
            margin-bottom: 12px;
            margin-top: 2px;
        }

        /* =======================================
           1. LIGHT THEME OVERRIDES (.theme-light)
           ======================================= */
        .theme-light {
            --primary-bg: #f0f2f5;
            --content-bg: #ffffff;
            --text-color: #212529;
            --input-bg: #eeeeee;
            --input-text: #212529;
            --accent-blue: #007bff;
            --accent-green: #28a745;
            --message-bg-received: #e9ecef;
            --message-bg-sent: #007bff;
            --message-text-received: var(--text-color);
            --message-text-sent: #ffffff;
        }
        .theme-light .chat-container {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .theme-light .chat-header {
            border-bottom: 1px solid #dee2e6;
            color: var(--text-color);
        }
        .theme-light .user-info {
            background: rgba(230, 230, 230, 0.8);
        }
        .theme-light .chat-input {
            border-top: 1px solid #dee2e6;
        }
        .theme-light .message.self .message-content {
            border-top-right-radius: 10px; /* Reset modern corner */
        }

        /* =======================================
           2. WINDOWS 98 THEME OVERRIDES (.theme-win98)
           ======================================= */
        .theme-win98 {
            --win98-gray: #c0c0c0;
            --win98-dark-gray: #808080;
            --win98-white: #ffffff;
            --win98-blue: #000080;
            --win98-black: #000000;
            --win98-highlight: #fefefe;
            --win98-dark-shadow: #000000;

            --primary-bg: #008080; /* Teal desktop */
            --content-bg: var(--win98-gray);
            --text-color: var(--win98-black);
            --input-bg: var(--win98-white);
            --input-text: var(--win98-black);
            --message-bg-received: var(--win98-gray);
            --message-bg-sent: #008080; /* Teal for sent */
            --message-text-received: var(--win98-black);
            --message-text-sent: var(--win98-white);
            
            font-family: 'MS Sans Serif', 'Tahoma', sans-serif;
            font-size: 11px;
        }
        .theme-win98 .chat-container {
            border-radius: 0;
            border: 1px solid var(--win98-black);
            box-shadow: 4px 4px 0 0 var(--win98-dark-shadow);
        }
        .theme-win98 .chat-header {
            background-color: var(--win98-blue);
            color: var(--win98-white);
            border-bottom: none;
            padding: 3px 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .theme-win98 .user-info {
            background: none;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            color: var(--win98-white);
        }
        .theme-win98 .user-info span, .theme-win98 .user-info img {
            display: none; /* Hide in Win98 title bar */
        }
        .theme-win98 .chat-messages {
            padding: 8px;
            /* Sunken box for chat history */
            border-top: 1px solid var(--win98-dark-gray);
            border-left: 1px solid var(--win98-dark-gray);
            border-right: 1px solid var(--win98-highlight);
            border-bottom: 1px solid var(--win98-highlight);
            margin: 4px;
        }
        .theme-win98 .chat-input {
            border-top: none;
            padding: 4px;
        }
        .theme-win98 .chat-input textarea {
            border-radius: 0;
            border-top: 1px solid var(--win98-dark-gray);
            border-left: 1px solid var(--win98-dark-gray);
            border-right: 1px solid var(--win98-highlight);
            border-bottom: 1px solid var(--win98-highlight);
            padding: 3px;
        }
        .theme-win98 button, .theme-win98 .back-button, .theme-win98 #theme-selector {
            background-color: var(--win98-gray) !important;
            color: var(--win98-black) !important;
            border-radius: 0 !important;
            padding: 3px 8px !important;
            font-weight: normal !important;
            border: 1px solid var(--win98-dark-gray);
            box-shadow: none !important;
            transition: none;
            border-top: 1px solid var(--win98-highlight);
            border-left: 1px solid var(--win98-highlight);
            border-right: 1px solid var(--win98-dark-gray);
            border-bottom: 1px solid var(--win98-dark-gray);
        }
        .theme-win98 button:active, .theme-win98 .back-button:active {
            border-top: 1px solid var(--win98-dark-gray) !important;
            border-left: 1px solid var(--win98-dark-gray) !important;
            border-right: 1px solid var(--win98-highlight) !important;
            border-bottom: 1px solid var(--win98-highlight) !important;
            padding: 4px 7px 2px 9px !important; 
        }
        .theme-win98 .back-button { top: 10px; left: 10px; }
        .theme-win98 .message img { display: none; }
        .theme-win98 .message-content { border-radius: 0; padding: 2px 5px; }
        .theme-win98 .message.self .message-content { border-top-right-radius: 0; }
        .theme-win98 .message-content .username { color: var(--win98-blue); margin-bottom: 2px; }
        .theme-win98 .message-content .timestamp { color: var(--win98-dark-gray); font-size: 9px; }
        .theme-win98 .verified-badge { filter: grayscale(1); }

        /* =======================================
           3. WINDOWS 7 AERO THEME OVERRIDES (.theme-win7)
           ======================================= */
        .theme-win7 {
            --win7-blue: #0078D7;
            --win7-light-blue: #D9E8F6;
            --win7-dark-blue: #003761;
            --win7-glass-bg: rgba(255, 255, 255, 0.3);
            --win7-glow: rgba(0, 110, 192, 0.7);

            --primary-bg: #80c0ff; /* Light, bright desktop color */
            --content-bg: var(--win7-glass-bg);
            --text-color: var(--win7-dark-blue);
            --input-bg: #ffffff;
            --input-text: #000000;
            --accent-blue: var(--win7-blue);
            --accent-green: #38a938;
            --radius: 8px;
            --message-bg-received: #E6E8E9;
            --message-bg-sent: var(--win7-light-blue);
            --message-text-received: #000000;
            --message-text-sent: #000000;
            font-family: 'Segoe UI', 'Tahoma', sans-serif;
        }
        .theme-win7 .chat-container {
            background-color: var(--win7-glass-bg);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); /* Big shadow effect */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .theme-win7 .chat-header {
            background: linear-gradient(to bottom, var(--win7-blue) 0%, #005aa0 100%);
            color: #ffffff;
            border-bottom: 1px solid var(--win7-dark-blue);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            border-top-left-radius: 7px;
            border-top-right-radius: 7px;
        }
        .theme-win7 .user-info {
            background: none;
            color: #fff;
            box-shadow: none;
        }
        .theme-win7 .user-info span {
            color: #ffffff;
            text-shadow: 1px 1px 1px var(--win7-dark-blue);
        }
        .theme-win7 .chat-input {
            border-top: 1px solid var(--win7-blue);
        }
        .theme-win7 .chat-input button {
            background-color: var(--win7-blue);
            color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 1px solid var(--win7-dark-blue);
        }
        .theme-win7 .chat-input button:hover {
            background-color: #005aa0;
        }
        .theme-win7 .message-content .timestamp {
            color: #555;
        }
        .theme-win7 .message.self .message-content {
            border-top-right-radius: 8px;
            border-top-left-radius: 8px; /* Standard rounding */
            border-bottom-right-radius: 8px;
        }

        /* =======================================
           4. iOS IMESSAGE THEME OVERRIDES (.theme-ios)
           ======================================= */
        .theme-ios {
            --primary-bg: #f8f8f8;
            --content-bg: #ffffff;
            --text-color: #000000;
            --input-bg: #ffffff;
            --input-text: #000000;
            --accent-blue: #007aff; /* Apple Blue */
            --accent-green: #34c759; /* Apple Green */
            --radius: 20px;
            --message-bg-received: #e5e5ea;
            --message-bg-sent: var(--accent-green);
            --message-text-received: #000000;
            --message-text-sent: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji';
        }
        .theme-ios .chat-container {
            box-shadow: none;
            border: none;
            background-color: transparent;
            margin-top: 0;
            height: 100vh;
        }
        .theme-ios .chat-header {
            background-color: var(--content-bg);
            border-bottom: 1px solid #c8c7cc;
            font-size: 1.1rem;
            text-align: center;
            justify-content: center;
        }
        .theme-ios .user-info {
            display: none !important; /* Hide user status in iOS header style */
        }
        .theme-ios .chat-messages {
            padding: 10px;
            background-color: var(--primary-bg);
        }
        .theme-ios .chat-input {
            background-color: #f6f6f6;
            border-top: 1px solid #c8c7cc;
            padding: 8px 10px;
        }
        .theme-ios .chat-input textarea {
            border-radius: 20px;
            border: 1px solid #d1d1d6;
            background-color: #ffffff;
            padding: 8px 15px;
            font-size: 0.95rem;
            min-height: 20px;
            line-height: normal;
        }
        .theme-ios .chat-input button {
            background-color: var(--accent-blue);
            color: #ffffff;
            border-radius: 20px;
            padding: 8px 12px;
        }
        .theme-ios .message {
            margin-bottom: 6px;
            align-items: flex-end;
        }
        .theme-ios .message img {
            display: none; /* iOS hides avatars in chat view */
        }
        .theme-ios .message-content {
            padding: 8px 12px;
            max-width: 80%;
            font-size: 0.95rem;
            color: var(--message-text-received);
            background-color: var(--message-bg-received);
            /* Standard Bubble shape */
            border-radius: 20px 20px 20px 5px; 
            box-shadow: 0 1px 0 rgba(0,0,0,0.08);
        }
        .theme-ios .message.self .message-content {
            color: var(--message-text-sent);
            background-color: var(--message-bg-sent);
            /* Sent Bubble shape (Green/Blue) */
            border-radius: 20px 20px 5px 20px;
        }
        .theme-ios .message-content .username {
            display: none; /* No usernames in iMessage bubbles */
        }
        .theme-ios .message-content .timestamp {
            display: none; /* Timestamps usually appear on scroll/tap */
        }
        .theme-ios .back-button {
            top: 10px;
            left: 10px;
            background-color: transparent;
            color: var(--accent-blue);
            font-weight: normal;
            box-shadow: none;
            padding: 5px 10px;
        }
        .theme-ios .back-button:hover {
            background-color: transparent;
            color: var(--accent-blue);
        }

        /* =======================================
           5. MSN MESSENGER THEME OVERRIDES (.theme-msn)
           ======================================= */
        .theme-msn {
            --msn-green: #5eb604;
            --msn-blue: #0087cb;
            --msn-light-bg: #e6f7ff;
            --msn-window-bg: #ffffff;
            --msn-text: #000000;
            --msn-input-border: #99c9ed;
            --msn-header-bg: linear-gradient(to top, #c7e5fc 0%, #e8f5ff 100%);
            --msn-message-bg-received: #e0f2ff;
            --msn-message-bg-sent: var(--msn-green);

            --primary-bg: var(--msn-light-bg); /* Background desktop */
            --content-bg: var(--msn-window-bg);
            --text-color: var(--msn-text);
            --input-bg: var(--msn-window-bg);
            --input-text: var(--msn-text);
            --accent-blue: var(--msn-blue);
            --accent-green: var(--msn-green);
            --radius: 4px; /* Slightly boxier, but still rounded */
            --message-bg-received: var(--msn-message-bg-received);
            --message-bg-sent: var(--msn-message-bg-sent);
            --message-text-received: var(--msn-text);
            --message-text-sent: #ffffff;
            font-family: 'Tahoma', 'Arial', sans-serif;
        }

        .theme-msn .chat-container {
            border-radius: 6px;
            border: 1px solid #7cb1df;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-height: 80vh; /* Fixed height for classic look */
        }
        .theme-msn .chat-header {
            background: var(--msn-header-bg);
            color: var(--msn-blue);
            font-size: 1.2rem;
            border-bottom: 1px solid #c7e5fc;
            padding: 8px 16px;
            justify-content: flex-start;
            gap: 16px;
        }
        .theme-msn .chat-header .text-xl {
            flex-grow: 1;
        }
        .theme-msn .user-info {
            background: #fff;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            order: -1; /* Place user info first */
        }
        .theme-msn .user-info img {
            width: 24px;
            height: 24px;
            border: 1px solid #ccc;
        }
        .theme-msn .user-info span {
            color: var(--msn-blue);
        }
        .theme-msn #theme-selector {
            background-color: var(--msn-window-bg);
            color: var(--msn-text);
            border: 1px solid var(--msn-input-border);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .theme-msn .chat-messages {
            padding: 10px;
            background-color: var(--msn-window-bg);
        }
        .theme-msn .message {
            margin-bottom: 8px;
            align-items: flex-end; /* MSN style often has avatar on bottom of bubble stack */
        }
        .theme-msn .message img {
            width: 32px;
            height: 32px;
            margin-right: 8px;
        }
        .theme-msn .message.self img {
            margin-left: 8px;
            margin-right: 0;
        }

        /* Message Bubbles */
        .theme-msn .message-content {
            padding: 6px 10px;
            max-width: 80%;
            font-size: 0.85rem;
            border-radius: 12px 12px 12px 4px; /* MSN has rounded ends, pointy corner on opposite bottom */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .theme-msn .message.self .message-content {
            background-color: var(--msn-message-bg-sent);
            color: var(--message-text-sent);
            border-radius: 12px 12px 4px 12px; /* Pointy corner on self side */
            border: 1px solid #458d03;
        }
        .theme-msn .message-content .username {
            font-size: 0.8rem;
            margin-bottom: 2px;
            color: var(--msn-blue);
        }
        .theme-msn .message.self .username {
            color: #ffffff; /* User name blends into green background */
        }
        .theme-msn .message-content .timestamp {
            font-size: 0.65rem;
            color: #666;
        }
        .theme-msn .message.self .timestamp {
            color: rgba(255,255,255,0.7);
        }

        .theme-msn .chat-input {
            border-top: 1px solid #ccc;
            background-color: #f0f0f0;
            padding: 8px;
        }
        .theme-msn .chat-input textarea {
            border-radius: 4px;
            border: 1px solid var(--msn-input-border);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            background-color: #fff;
            padding: 5px;
        }
        .theme-msn .chat-input button {
            background: linear-gradient(to bottom, #fcfcfc 0%, #e0e0e0 100%);
            color: var(--msn-blue);
            font-weight: bold;
            border: 1px solid #8ba8c3;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            padding: 6px 12px;
            border-radius: 4px;
        }
        .theme-msn .chat-input button:hover {
             background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
        }
        .theme-msn .back-button {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #8ba8c3;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .theme-msn .back-button:hover {
            background-color: #ffffff;
        }

    </style>
</head>
<body>
<script>
  if (sessionStorage.getItem("loggedIn") !== "true") {
    window.location.href = "auth.html";
  }
</script>
 class="theme-dark">
<a class="back-button" href="index.html">← Back to Home</a>
<div class="chat-container">
    <div class="chat-header">
        <div class="text-xl">Crooms Connect Chat</div>
        
        <!-- THEME SELECT DROPDOWN -->
        <select id="theme-selector" class="p-2 rounded-md bg-gray-700 text-white text-sm font-semibold transition duration-150">
            <option value="dark">Modern Dark</option>
            <option value="light">Light</option>
            <option value="win98">Windows 98</option>
            <option value="win7">Windows 7 Aero</option>
            <option value="ios">iOS iMessage</option>
            <option value="msn">MSN Messenger</option>
        </select>
        
        <div class="user-info" id="user-info" style="display: none;">
            <img id="user-avatar" src="https://api.dicebear.com/6.x/thumbs/svg?seed=Anonymous" alt="avatar">
            <span id="user-name">Loading...</span>
            <img id="user-verified" src="verify.png" class="verified-badge" alt="verified" title="Verified" style="display:none;">
        </div>
    </div>
    <div class="chat-messages" id="chat-box">
        <div id="loading-older" style="display:none">Loading...</div>
    </div>
    <div class="chat-input">
        <textarea id="chat-input" placeholder="Type your message..." rows="2"></textarea>
        <button id="send-button">Send</button>
    </div>
</div>
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // === THEME MANAGEMENT FUNCTIONS ===
    const themeSelector = document.getElementById('theme-selector');
    const themeKey = 'chatTheme';

    function setSavedTheme() {
        // Default changed to 'dark' for consistency
        const savedTheme = localStorage.getItem(themeKey) || 'dark'; 
        document.body.className = ''; 
        
        // Add the theme class
        if (savedTheme === 'win98') document.body.classList.add('theme-win98');
        else if (savedTheme === 'light') document.body.classList.add('theme-light');
        else if (savedTheme === 'win7') document.body.classList.add('theme-win7');
        else if (savedTheme === 'ios') document.body.classList.add('theme-ios');
        else if (savedTheme === 'msn') document.body.classList.add('theme-msn'); // Added MSN theme check
        else document.body.classList.add('theme-dark');

        // Update the selector value
        if (themeSelector.querySelector(`option[value="${savedTheme}"]`)) {
             themeSelector.value = savedTheme;
        } else {
             themeSelector.value = 'dark'; // Fallback
        }
    }

    function handleThemeChange() {
        const newTheme = themeSelector.value;
        localStorage.setItem(themeKey, newTheme);
        setSavedTheme();
        fullRefreshMessages(); 
    }
    // ===================================

    // === REPLACED DEBUG LOGGING FUNCTION ===
    function debugLog(...args) {
        console.log('DEBUG:', ...args);
    }

    // Supabase Configuration 
    const SUPABASE_URL = 'https://jxxnfsydjrflnephmfjm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const chatBox = document.getElementById('chat-box');
    const loadingOlderDiv = document.getElementById('loading-older');
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-button');
    const userInfoDiv = document.getElementById('user-info');
    const userAvatarImg = document.getElementById('user-avatar');
    const userNameSpan = document.getElementById('user-name');
    const userVerifiedImg = document.getElementById('user-verified');

    let currentUser = null;
    let currentUsername = 'Anonymous';
    let currentUserIsVerified = false;

    // Infinite scroll state
    const PAGE_SIZE = 20;
    let loadedMessages = []; 
    let loadingOlder = false;
    let allOlderLoaded = false;
    let totalMessageCount = null; 

    // --- CACHE FOR PROFILE VERIFICATION ---
    const verifiedCache = {};
    function clearVerifiedCache() {
        for (const key in verifiedCache) {
            delete verifiedCache[key];
        }
    }

    // Clean username helper
    function cleanUsername(name) {
        if (!name) return "Anonymous";
        if (typeof name !== 'string') return name;
        return name.replace(/@croomsconnect\.local$/i, '');
    }

    // Async check if a username is verified (with caching)
    async function isUserVerified(username) {
        if (verifiedCache.hasOwnProperty(username)) return verifiedCache[username];
        const { data, error } = await supabase
            .from('profiles')
            .select('is_verified')
            .eq('username', username)
            .single();
        const verified = !!(data && data.is_verified);
        verifiedCache[username] = verified;
        return verified;
    }

    async function updateGlobalAvatarAndName() {
        const { data: authData, error: authErr } = await supabase.auth.getUser();
        
        if (!authData?.user) {
            window.location.href = "auth.html";
            return;
        }

        const userId = authData.user.id;
        const { data: profile } = await supabase
            .from("profiles")
            .select("username, is_verified")
            .eq("id", userId)
            .single();

        currentUser = authData.user;
        currentUsername = cleanUsername(profile?.username) || "Anonymous";
        currentUserIsVerified = !!profile?.is_verified;
        
        const customAvatar = authData.user.user_metadata?.avatar_url;
        userAvatarImg.src = customAvatar && customAvatar.trim() !== ""
            ? customAvatar
            : `https://api.dicebear.com/6.x/thumbs/svg?seed=${encodeURIComponent(currentUsername)}`;
        userNameSpan.textContent = currentUsername;
        userVerifiedImg.style.display = currentUserIsVerified ? "" : "none";
        userInfoDiv.style.display = 'flex';
    }

    function cleanMessageMentions(text) {
        return text.replace(/@([a-zA-Z0-9_@.]+)/g, (match, mentionName) => {
            let clean = mentionName;
            if (clean.toLowerCase().endsWith('@croomsconnect.local')) {
                clean = clean.slice(0, -'@croomsconnect.local'.length);
            }
            return `<span class="mention">@${clean}</span>`;
        });
    }

    // async displayMessage to allow for verified badge lookup and theme-based styling
    async function displayMessage(msg) {
        const isSelf = currentUser && msg.user_id === currentUser.id;
        const username = cleanUsername(msg.username) || "Anonymous";
        const avatarSrc = msg.avatar_url && msg.avatar_url.trim() !== ""
            ? msg.avatar_url
            : `https://api.dicebear.com/6.x/thumbs/svg?seed=${encodeURIComponent(username)}`;
        const div = document.createElement('div');
        
        // Determine theme-specific classes
        const theme = localStorage.getItem(themeKey) || 'dark';
        const isIOS = theme === 'ios';
        const isWin98 = theme === 'win98';
        const isMSN = theme === 'msn';

        div.className = `message ${isSelf ? 'self' : 'other'}`;
        div.dataset.userId = msg.user_id;
        div.dataset.timestamp = msg.timestamp; 

        const verified = await isUserVerified(msg.username);
        const avatarStyle = (isIOS || isWin98) ? 'display: none;' : 'display: block;';
        const timestampText = new Date(msg.timestamp).toLocaleTimeString();
        
        // MSN theme shows the username (often with color) and message on one line, so we need the username/badge inside the bubble content.
        // We ensure avatars are hidden for Win98 and iOS, and visible for others (including MSN).

        div.innerHTML = `
            <img src="${avatarSrc}" alt="avatar" style="${avatarStyle}">
            <div class="message-content">
                <div class="username">
                    ${username}
                    ${verified ? `<img src="verify.png" class="verified-badge" alt="verified" title="Verified">` : ""}
                </div>
                <div class="text">${cleanMessageMentions(msg.message)}</div>
                <div class="timestamp">${timestampText}</div>
            </div>
        `;
        
        chatBox.appendChild(div);
    }

    // Render all messages (infinite scroll compatible)
    async function renderMessages(isInitialLoad = false) {
        const oldScrollHeight = chatBox.scrollHeight;
        const oldScrollTop = chatBox.scrollTop;
        const shouldScrollToBottom = isInitialLoad || oldScrollTop + chatBox.clientHeight >= oldScrollHeight - 20;

        chatBox.innerHTML = '';
        chatBox.appendChild(loadingOlderDiv);
        
        for (const msg of loadedMessages) {
            await displayMessage(msg);
        }

        if (shouldScrollToBottom) {
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 0);
        } else if (!isInitialLoad && !loadingOlder) {
            const newScrollHeight = chatBox.scrollHeight;
            const diff = newScrollHeight - oldScrollHeight;
            chatBox.scrollTop = oldScrollTop + diff;
        }
    }

    async function fetchTotalMessageCount() {
        const { count } = await supabase
            .from('messages')
            .select('id', { count: 'exact', head: true });
        return count || 0;
    }

    async function loadInitialMessages() {
        totalMessageCount = await fetchTotalMessageCount();
        const start = Math.max(0, totalMessageCount - PAGE_SIZE);
        const end = totalMessageCount - 1;
        const { data } = await supabase
            .from('messages')
            .select('user_id, username, avatar_url, message, timestamp')
            .order('timestamp', { ascending: true })
            .range(start, end);

        loadedMessages = data || [];
        if (loadedMessages.length < PAGE_SIZE) allOlderLoaded = true;
        
        loadingOlderDiv.style.display = allOlderLoaded ? 'none' : 'block';
        await renderMessages(true);
    }

    async function loadOlderMessages() {
        if (loadingOlder || allOlderLoaded) return;
        loadingOlder = true;
        loadingOlderDiv.style.display = '';
        
        const oldScrollHeight = chatBox.scrollHeight; 
        
        const messagesToLoad = PAGE_SIZE;
        const currentlyLoaded = loadedMessages.length;
        const start = Math.max(0, totalMessageCount - currentlyLoaded - messagesToLoad);
        const end = totalMessageCount - currentlyLoaded - 1;
        
        if (end < start) {
            loadingOlder = false;
            loadingOlderDiv.style.display = 'none';
            allOlderLoaded = true;
            return;
        }
        
        const { data } = await supabase
            .from('messages')
            .select('user_id, username, avatar_url, message, timestamp')
            .order('timestamp', { ascending: true })
            .range(start, end);
        
        if (data && data.length > 0) {
            loadedMessages = [...data, ...loadedMessages];
            if (data.length < PAGE_SIZE) allOlderLoaded = true;
            
            await renderMessages();

            const newScrollHeight = chatBox.scrollHeight;
            const diff = newScrollHeight - oldScrollHeight;
            chatBox.scrollTop = diff;

        } else {
            allOlderLoaded = true;
        }
        loadingOlder = false;
        loadingOlderDiv.style.display = 'none';
    }

    function handleScroll() {
        if (chatBox.scrollTop < 100 && !loadingOlder && !allOlderLoaded) {
            loadOlderMessages();
        }
    }

    async function sendMessage() {
        const message = input.value.trim();
        if (!message || !currentUser) {
            return;
        }

        const { data: profile } = await supabase
            .from('profiles')
            .select('username')
            .eq('id', currentUser.id)
            .single();

        const username = profile?.username || 'Anonymous'; 
        const avatar_url = currentUser.user_metadata?.avatar_url || '';

        const { error: insertErr } = await supabase.from('messages').insert([{
            user_id: currentUser.id,
            username,
            avatar_url,
            message,
            timestamp: new Date().toISOString()
        }]);

        if (insertErr) {
            console.error("Failed to insert message!", insertErr);
            // Non-alert message box would be preferred here if this were a production app
        }

        input.value = '';
    }

    function subscribeToMessages() {
        supabase
            .channel('messages-channel')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
                if (!loadedMessages.some(m => m.timestamp === payload.new.timestamp && m.user_id === payload.new.user_id)) {
                    loadedMessages.push(payload.new);
                    await displayMessage(payload.new); 
                    totalMessageCount += 1;
                    setTimeout(() => {
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }, 0);
                }
            })
            .subscribe();
    }

    async function fullRefreshMessages() {
        if (loadingOlder) return; 
        
        clearVerifiedCache();

        const messagesToLoad = loadedMessages.length + PAGE_SIZE; 
        totalMessageCount = await fetchTotalMessageCount(); 
        
        const start = Math.max(0, totalMessageCount - messagesToLoad);
        const end = totalMessageCount - 1;

        const { data, error } = await supabase
            .from('messages')
            .select('user_id, username, avatar_url, message, timestamp')
            .order('timestamp', { ascending: true })
            .range(start, end);

        if (error) {
            console.error("Error during refresh fetch:", error);
            return;
        }

        loadedMessages = data || [];
        allOlderLoaded = (totalMessageCount - loadedMessages.length) <= 0;
        loadingOlderDiv.style.display = allOlderLoaded ? 'none' : 'block';

        await renderMessages(); 
        await updateGlobalAvatarAndName();
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    chatBox.addEventListener('scroll', handleScroll);
    themeSelector.addEventListener('change', handleThemeChange);

    document.addEventListener('DOMContentLoaded', async () => {
        setSavedTheme(); 
        await updateGlobalAvatarAndName();
        await loadInitialMessages();
        subscribeToMessages();
        supabase.auth.onAuthStateChange(() => updateGlobalAvatarAndName());

        // Refresh messages every 5 seconds to pick up new styling when theme changes
        setInterval(fullRefreshMessages, 5000); 
    });

    // --- DEMO: Ensure AJTech@croomsconnect.local is verified for badge demo
    (async function ensureAJTechVerified() {
        // This function ensures the demo badge works by setting the verification status.
        const { data } = await supabase
            .from('profiles')
            .select('is_verified')
            .eq('username', 'AJTech@croomsconnect.local')
            .single();
        if (data && !data.is_verified) {
            await supabase
                .from('profiles')
                .update({ is_verified: true })
                .eq('username', 'AJTech@croomsconnect.local');
        }
    })();
</script>
</body>
</html>
