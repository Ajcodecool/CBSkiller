<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
    <h2 class="text-2xl font-bold mb-4 text-center">Account Settings</h2>
    <div id="user-info" class="flex flex-col items-center space-y-4">
      <img id="user-avatar" src="" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-gray-300 dark:border-gray-600" />
      <p id="user-name" class="text-lg font-semibold"></p>
    </div>
    <form id="upload-form" class="mt-6 space-y-4">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Upload New Profile Picture</label>
      <input type="file" id="file-input" accept=".jpg,.jpeg,.png,.bmp,.webp" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-100 dark:bg-gray-700 dark:border-gray-600" />
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">Upload</button>
    </form>
    <div id="message" class="mt-4 text-center text-sm font-medium"></div>
    <a href="index.html" class="block mt-6 text-center text-blue-600 hover:underline">‚Üê Back to Home</a>
  </div>

  <script>
    const supabase = supabase.createClient(
      'https://jxxnfsydjrflnephmfjm.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w'
    );

    document.addEventListener('DOMContentLoaded', async () => {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        document.getElementById('message').textContent = 'User not logged in.';
        return;
      }

      const username = user.user_metadata?.username || user.email;
      const avatarUrl = user.user_metadata?.avatar_url || 'default-avatar.png';

      document.getElementById('user-name').textContent = username;
      document.getElementById('user-avatar').src = avatarUrl;

      document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        const message = document.getElementById('message');

        if (!file) {
          message.textContent = 'Please select a file.';
          return;
        }

        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          message.textContent = 'Invalid file type. Please upload JPEG, JPG, PNG, BMP, or WEBP.';
          return;
        }

        const fileName = `${user.id}/${Date.now()}_${file.name}`;
        const { data, error: uploadError } = await supabase.storage
          .from('profile-pictures')
          .upload(fileName, file, { upsert: true });

        if (uploadError) {
          message.textContent = 'Upload failed. Please try again.';
          return;
        }

        const { data: urlData } = supabase.storage
          .from('profile-pictures')
          .getPublicUrl(fileName);

        const { error: updateError } = await supabase.auth.updateUser({
          data: { avatar_url: urlData.publicUrl }
        });

        if (updateError) {
          message.textContent = 'Failed to update profile picture.';
        } else {
          document.getElementById('user-avatar').src = urlData.publicUrl;
          message.textContent = 'Profile picture updated successfully!';
        }
      });
    });
  </script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  console.log("‚úÖ DOM fully loaded");

  const supabaseUrl = "https://jxxnfsydjrflnephmfjm.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w";
  console.log("üîß Creating Supabase client...");
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  console.log("üîç Checking session...");
  try {
    const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
    console.log("üì¶ Session data:", sessionData);
    console.log("‚ö†Ô∏è Session error:", sessionError);

    if (sessionError || !sessionData.session) {
      console.warn("üîí No active session found. Redirecting to auth.html...");
      window.location.href = "auth.html";
    } else {
      console.log("‚úÖ User is signed in.");
    }
  } catch (err) {
    console.error("‚ùå Error during session check:", err);
    window.location.href = "auth.html";
  }
});
</script>

</body>
</html>
