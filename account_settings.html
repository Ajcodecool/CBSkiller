<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account Settings - Profile Picture</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <style>
    .cropper-container {
      border-radius: 9999px !important; /* fully rounded */
      overflow: hidden;
      border: 2px solid #e5e7eb;
      box-shadow: 0 3px 8px 0 rgba(0,0,0,0.07);
      margin: 0 auto;
      width: 260px;
      height: 260px;
      background: #f9fafb;
    }
    .cropper-view-box, .cropper-face {
      border-radius: 50% !important;
    }
    .avatar-preview {
      width: 96px;
      height: 96px;
      border-radius: 9999px;
      border: 3px solid #4ade80;
      object-fit: cover;
      margin: 0 auto;
    }
    .faded {
      opacity: 0.6;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <header class="max-w-xl mx-auto mt-10 mb-6 flex items-center">
    <a href="index.html" class="inline-flex items-center px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"/></svg>
      Home
    </a>
    <h1 class="flex-1 text-center text-3xl font-bold tracking-tight">Account Settings</h1>
  </header>
  <main class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow">
    <h2 class="text-xl font-semibold mb-4 text-center">Profile Picture</h2>

    <div class="flex flex-col items-center gap-4">
      <div id="current-avatar-section" class="mb-2">
        <img id="current-avatar" class="avatar-preview faded" src="" alt="Current Avatar" style="display:none;"/>
        <p id="no-avatar-text" class="text-gray-400 text-sm">No profile picture set</p>
      </div>
      <input id="fileInput" type="file" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <div id="cropper-wrapper" class="cropper-container mt-3 mb-2" style="display:none;">
        <img id="cropper-image" alt="Crop Preview" style="max-width:100%;display:block;" />
      </div>
      <button id="uploadBtn" class="bg-blue-600 text-white px-8 py-2 rounded-full font-semibold transition hover:bg-blue-700 disabled:opacity-60 mb-1" disabled>Save / Upload</button>
      <p id="status" class="text-center text-sm mt-2 h-5"></p>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // ---- SUPABASE CONFIG ----
    const SUPABASE_URL = "https://jxxnfsydjrflnephmfjm.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ---- DOM ----
    const fileInput = document.getElementById('fileInput');
    const cropperWrapper = document.getElementById('cropper-wrapper');
    const cropperImg = document.getElementById('cropper-image');
    const uploadBtn = document.getElementById('uploadBtn');
    const currentAvatar = document.getElementById('current-avatar');
    const noAvatarText = document.getElementById('no-avatar-text');
    const status = document.getElementById('status');

    let cropper = null;
    let user = null;

    // ---- INITIALIZATION ----
    async function init() {
      const { data: sessionData } = await supabase.auth.getSession();
      if (!sessionData?.session?.user) {
        window.location.href = "auth.html";
        return;
      }
      user = sessionData.session.user;

      // Load existing avatar
      const { data: userData } = await supabase
        .from("users")
        .select("avatar_url")
        .eq("id", user.id)
        .single();

      if (userData?.avatar_url) {
        currentAvatar.src = userData.avatar_url;
        currentAvatar.style.display = '';
        noAvatarText.style.display = 'none';
      } else {
        currentAvatar.style.display = 'none';
        noAvatarText.style.display = '';
      }

      uploadBtn.disabled = true;
    }

    init();

    // ---- FILE INPUT & CROPPER ----
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) {
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
      }
      if (!file.type.startsWith("image/")) {
        status.textContent = "Only image files are allowed.";
        fileInput.value = "";
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
      }
      if (file.size > 5 * 1024 * 1024) {
        status.textContent = "File too large (max 5 MB).";
        fileInput.value = "";
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
      }
      status.textContent = "";

      const url = URL.createObjectURL(file);
      cropperImg.src = url;
      cropperWrapper.style.display = '';
      uploadBtn.disabled = false;

      cropperImg.onload = () => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropperImg, {
          aspectRatio: 1,
          viewMode: 1,
          dragMode: 'move',
          background: false,
          guides: false,
          autoCropArea: 1,
          cropBoxResizable: false,
          cropBoxMovable: false,
          movable: true,
          zoomable: true,
          minContainerWidth: 260,
          minContainerHeight: 260,
        });
      };
    });

    // ---- UPLOAD CROPPED ----
    uploadBtn.addEventListener('click', async () => {
      if (!cropper) return;
      status.textContent = "Processing image...";
      uploadBtn.disabled = true;

      cropper.getCroppedCanvas({ width: 300, height: 300, imageSmoothingQuality: 'high' })
        .toBlob(async (blob) => {
          if (!blob) {
            status.textContent = "Failed to crop image.";
            uploadBtn.disabled = false;
            return;
          }

          // Compose file name and upload to Supabase
          const fileName = `profile-${user.id}-${Date.now()}.png`;
          status.textContent = "Uploading...";
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from("profile-pictures")
            .upload(fileName, blob, { upsert: true });

          if (uploadError) {
            status.textContent = "Upload failed: " + uploadError.message;
            uploadBtn.disabled = false;
            return;
          }

          // Get public URL
          const { data: publicUrlData } = await supabase.storage
            .from("profile-pictures")
            .getPublicUrl(fileName);

          const publicUrl = publicUrlData?.publicUrl;
          if (!publicUrl) {
            status.textContent = "Could not retrieve image URL.";
            uploadBtn.disabled = false;
            return;
          }

          // Save to user table and auth user metadata
          const { error: updateError } = await supabase
            .from("users")
            .update({ avatar_url: publicUrl })
            .eq("id", user.id);

          await supabase.auth.updateUser({
            data: { avatar_url: publicUrl }
          });

          if (updateError) {
            status.textContent = "Upload succeeded, but failed to save to profile: " + updateError.message;
          } else {
            status.textContent = "Profile picture updated!";
          }

          // Update preview
          currentAvatar.src = publicUrl;
          currentAvatar.style.display = '';
          noAvatarText.style.display = 'none';
          cropperWrapper.style.display = 'none';
          fileInput.value = "";
          uploadBtn.disabled = true;
        }, "image/png", 0.95);
    });

    // ---- AUTH STATE HANDLING ----
    supabase.auth.onAuthStateChange((event, session) => {
      if (!session) window.location.href = "auth.html";
    });
  </script>
</body>
</html>
