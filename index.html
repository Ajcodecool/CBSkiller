<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Crooms Connect</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
/* ------------------------------------------------------------------- */
/* ROOT THEME VARIABLES (Default: DARK MODE)                           */
/* ----------------------------------------------------------efihvfehivegrerfgufewk2efbwqdedvjewgfrwer2ihererewfjwehiewiherilrfwfowfhrfrh;--------- */
:root {
/* Dynamic Theme Variables */
--primary-bg: #1a1b2f; /* Main App Background (Dark Blue/Gray) */
--content-bg: #2b2d42; /* Card/Section Background */
--text-color: #f8f9fa; /* Light Text Color */
--shadow: 0 4px 12px rgba(0,0,0,0.4);
--border-color: rgba(248, 249, 250, 0.1);
--card-bg-subtle: rgba(248, 249, 250, 0.05);
/* Fixed Accent Colors */
--accent-blue: #4cc9f0;
--accent-green: #80ed99;
--accent-red: #ef476f;
--accent-yellow: #ffd166;
--radius: 15px;
}

/* ------------------------------------------------------------------- */
/* LIGHT MODE OVERRIDES                                                */
/* ------------------------------------------------------------------- */
.light-mode {
--primary-bg: #f0f4f8; /* Very Light Gray/Blue */
--content-bg: #ffffff; /* White Cards */
--text-color: #000000; /* Black Text */
--shadow: 0 4px 12px rgba(0,0,0,0.15);
--border-color: rgba(26, 27, 47, 0.1);
--card-bg-subtle: #f8f9fa; /* Off-white for subtle card areas */
}
/* ------------------------------------------------------------------- */
/* BASE STYLES                                                         */
/* ------------------------------------------------------------------- */
body {
margin: 0;
font-family: "Segoe UI", Arial, sans-serif;
background: var(--primary-bg);
color: var(--text-color);
padding: 65px 280px 0 200px;
overflow-x: hidden;
transition: background-color 0.3s, color 0.3s;
}

/* SQUIGGLY BACKGROUND LINES (Adapt to current text color for visibility) */
body::before {
content: "";
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
/* SVG stroke color references the dynamic --text-color variable */
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M0 50 Q50 0 100 50 T200 50 V200 H0 Z" fill="none" stroke="var(--text-color, rgba(255,255,255,0.05))" stroke-width="2"/></svg>');
background-size: 200px 200px;
z-index: -1;
/* Opacity is adjusted dynamically based on theme contrast */
opacity: 0.05;
}
.light-mode::before {
opacity: 0.1; /* Make squiggles visible on light background */
}
/* HEADER */
.header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 15px;
/* Use a semi-transparent primary background for the header */
background: color-mix(in srgb, var(--primary-bg) 90%, transparent);
backdrop-filter: blur(10px);
box-shadow: var(--shadow);
position: fixed;
top: 0;
left: 0;
width: 100%;
z-index: 100;
transition: top 0.3s, background 0.3s;
}
.header .title-text {
font-weight: bold;
font-size: clamp(16px, 4vw, 20px);
color: var(--accent-blue);
flex-shrink: 0;
}
.header .user-id-display {
font-size: 10px;
color: var(--text-color);
opacity: 0.6;
padding-left: 10px;
max-width: 40%;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}
/* NAVIGATION BUTTONS */
.left-box {
position: fixed;
left: 0;
top: 65px;
width: 200px;
height: calc(100vh - 65px);
display: flex;
flex-direction: column;
gap: 15px;
padding: 20px;
background: var(--content-bg);
border-right: 1px solid var(--border-color);
overflow-y: auto;
}
.left-box button {
background: var(--content-bg);
color: var(--text-color);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 12px 20px;
cursor: pointer;
font-size: 16px;
font-weight: bold;
/* Adding a subtle glowing transition effect */
transition: 0.3s ease-in-out;
/* Subtle shadow/border effect */
box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.1);
}
.left-box button:hover {
/* Using a radial gradient effect for the 'light' feel */
background: radial-gradient(circle at top left, var(--accent-blue) 10%, var(--content-bg) 100%);
color: var(--primary-bg);
transform: translateY(-3px);
/* More pronounced shadow with a subtle blue glow */
box-shadow: 0 8px 20px rgba(76, 201, 240, 0.4), 0 0 15px rgba(76, 201, 240, 0.3);
}
.left-box button.active {
/* Active state uses a strong blue gradient */
background: linear-gradient(45deg, var(--accent-blue), #2a8dff);
color: var(--primary-bg);
/* Added stronger shadow for active state */
box-shadow: 0 4px 10px rgba(76, 201, 240, 0.6);
transform: none; /* No lift when active */
}
/* TIMER STYLES (Pulse/Blink removed, replaced with color logic in JS) */
.timer-text.timer-active {
/* No animation */
display: inline-block;
font-weight: bolder;
transition: color 0.3s;
/* Default active color (will be overridden by JS for green/red) */
color: var(--accent-red); /* Placeholder color, JS overrides this for green/red based on time left */
}
/* TAB CONTENT */
.tab-content {
display: none;
animation: fadeInUp 0.7s ease;
}
.tab-content.active {
display: block;
}
/* SECTION CONTAINER (Uses Content BG) */
section, .right-box {
background: var(--content-bg);
border-radius: var(--radius);
padding: 30px;
margin: 0 auto;
max-width: 900px;
box-shadow: var(--shadow);
border: 1px solid var(--border-color);
position: relative;
overflow: hidden;
transition: all 0.3s ease;
}
/* SQUIGGLES INSIDE CARDS (Less visible) */
section::before {
content: "";
position: absolute;
top: 0; left: 0; right: 0; bottom: 0;
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M0 100 Q50 50 100 100 T200 100 V200 H0 Z" fill="none" stroke="var(--text-color, rgba(255,255,255,0.05))" stroke-width="2"/></svg>');
background-size: 200px 200px;
opacity: 0.1;
z-index: 0;
}
section h1, section h2, section p, section .disclaimer-point {
position: relative;
z-index: 1;
}
section h1 { color: var(--accent-blue); }
section h2 { color: var(--accent-green); }
/* CARDS INSIDE SECTIONS */
.card-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-top: 20px;
}
.card {
background: var(--card-bg-subtle);
border: 1px solid var(--border-color);
padding: 20px;
border-radius: var(--radius);
box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* Slightly weaker card shadow */
transition: all 0.3s ease;
position: relative;
overflow: hidden;
text-align: center;
}
.card:hover {
transform: translateY(-8px) scale(1.05);
box-shadow: 0 8px 25px rgba(0,0,0,0.3);
background: linear-gradient(135deg, var(--card-bg-subtle), rgba(76, 201, 240, 0.05));
}
.card .icon {
font-size: 35px;
margin-bottom: 10px;
display: block;
}

/* TRIVIA STYLES */
.trivia-option {
background: var(--content-bg);
color: var(--text-color);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 10px 20px;
margin: 5px;
cursor: pointer;
transition: all 0.3s;
}
.trivia-option:hover {
background: var(--accent-blue);
color: var(--primary-bg);
}
/* RIGHT BOX */
.right-box {
position: fixed;
right: 0;
top: 65px;
width: 280px;
height: calc(100vh - 65px);
display: flex;
flex-direction: column;
gap: 15px;
padding: 20px;
background: var(--content-bg);
border-left: 1px solid var(--border-color);
overflow-y: auto;
}
.right-box h2 {
text-align: center;
color: var(--accent-yellow);
}
.right-box .section {
margin-top: 0;
background: var(--card-bg-subtle);
padding: 10px;
border-radius: var(--radius);
text-align: center;
font-weight: bold;
border: 1px solid var(--border-color);
transition: background-color 0.3s;
}
.right-box .info p {
margin: 8px 0;
cursor: pointer;
transition: color 0.2s;
}

/* FOOTER */
footer {
text-align: center;
padding: 20px;
background: var(--primary-bg);
margin-top: 40px;
color: var(--text-color);
font-size: 14px;
transition: background-color 0.3s, color 0.3s;
}
footer a {
color: var(--accent-blue);
text-decoration: none;
cursor: pointer;
}

/* THEME BUTTON STYLES (Restored Gradients/Lighting) */
.theme-button {
width: 100%;
padding: 15px;
margin-top: 10px;
font-weight: bold;
border: none;
border-radius: 10px;
cursor: pointer;
transition: transform 0.2s, opacity 0.3s, background-color 0.3s, box-shadow 0.3s;
box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}
#dark-mode-button {
background-color: var(--content-bg);
color: var(--text-color);
border: 2px solid var(--accent-blue);
background-image: linear-gradient(135deg, var(--content-bg), var(--content-bg) 80%, rgba(76, 201, 240, 0.1));
}
#dark-mode-button.active, #dark-mode-button:hover {
background-image: linear-gradient(135deg, var(--accent-blue), #2a8dff); /* Blue Gradient */
color: var(--primary-bg);
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(76, 201, 240, 0.6);
}
#light-mode-button {
background-color: var(--content-bg);
color: var(--text-color);
border: 2px solid var(--accent-yellow);
background-image: linear-gradient(135deg, var(--content-bg), var(--content-bg) 80%, rgba(255, 209, 102, 0.1));
}
#light-mode-button.active, #light-mode-button:hover {
background-image: linear-gradient(135deg, var(--accent-yellow), #ffc34d); /* Yellow Gradient */
color: var(--primary-bg);
transform: translateY(-2px);
box-shadow: 0 4px 15px rgba(255, 209, 102, 0.6);
}
/* ANIMATIONS AND MODALS (Kept for completeness) */
@keyframes fadeInUp {
from {opacity: 0; transform: translateY(20px);}
to {opacity: 1; transform: translateY(0);}
}
@keyframes fadeIn {
from {opacity: 0;}
to {opacity: 1;}
}

.modal-overlay {
position: fixed; top: 0; left: 0; width: 100%; height: 100%;
background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
z-index: 1000; display: none; justify-content: center; align-items: center;
opacity: 0; transition: opacity 0.3s ease;
}
.modal-overlay.show { display: flex; opacity: 1; }
.modal-content {
background: var(--content-bg); border-radius: var(--radius);
padding: 40px 30px; max-width: 600px; width: 90%; max-height: 80vh;
overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
border: 2px solid var(--accent-red); position: relative;
transform: scale(0.9); transition: transform 0.3s ease, background-color 0.3s, color 0.3s, background-image 0.3s;
}
.modal-overlay.show .modal-content { transform: scale(1); }
.close-button {
position: absolute; top: 15px; right: 15px; background: none; border: none;
color: var(--text-color); font-size: 24px; cursor: pointer; line-height: 1;
padding: 5px; opacity: 0.7; transition: opacity 0.2s, color 0.2s;
}
.close-button:hover { opacity: 1; color: var(--accent-red); }

/* CALENDAR MODAL STYLES */
.calendar-grid {
display: grid;
grid-template-columns: repeat(4, 1fr);
gap: 20px;
margin-top: 20px;
}
.calendar-month {
background: var(--card-bg-subtle);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 10px;
text-align: center;
}
.calendar-month h3 {
color: var(--accent-blue);
margin-bottom: 10px;
font-size: 18px;
}
.calendar-month .days {
display: grid;
grid-template-columns: repeat(7, 1fr);
gap: 5px;
}
.calendar-month .day {
padding: 5px;
font-size: 14px;
border-radius: 3px;
}
.calendar-month .day.today {
background: var(--accent-yellow);
color: var(--primary-bg);
font-weight: bold;
}
.calendar-month .day.holiday {
background: var(--accent-red);
color: var(--primary-bg);
}
.calendar-month .day-header {
font-weight: bold;
color: var(--accent-green);
}

/* CALENDAR TOOLTIP STYLES */
.calendar-tooltip {
position: absolute;
background: var(--content-bg);
color: var(--text-color);
border: 1px solid var(--border-color);
border-radius: var(--radius);
padding: 8px 12px;
font-size: 14px;
font-weight: bold;
box-shadow: 0 4px 12px rgba(0,0,0,0.3);
z-index: 1001;
pointer-events: none;
display: none;
max-width: 200px;
word-wrap: break-word;
}

/* Close Tab Button */
.close-tab-button {
position: absolute;
top: 15px;
right: 15px;
background: none;
border: none;
color: var(--text-color);
font-size: 24px;
cursor: pointer;
line-height: 1;
padding: 5px;
opacity: 0.7;
transition: opacity 0.2s, color 0.2s;
z-index: 2;
}
.close-tab-button:hover {
opacity: 1;
color: var(--accent-red);
}

/* Settings Form Styles */
.settings-form {
text-align: left;
margin-top: 15px;
}
.settings-form label {
display: block;
margin-top: 10px;
margin-bottom: 5px;
font-size: 14px;
font-weight: bold;
color: var(--accent-green); /* Use accent color for label */
}
.settings-form input {
width: 100%;
padding: 8px;
border-radius: 5px;
border: 1px solid var(--border-color);
background: var(--primary-bg);
color: var(--text-color);
font-size: 14px;
transition: border-color 0.3s;
}
.settings-form input:focus {
outline: none;
border-color: var(--accent-blue);
}
.save-settings-button {
margin-top: 20px;
width: 100%;
padding: 10px;
border: none;
border-radius: 10px;
background: linear-gradient(45deg, var(--accent-green), #4CAF50);
color: var(--primary-bg);
font-weight: bold;
cursor: pointer;
transition: transform 0.2s, box-shadow 0.3s;
box-shadow: 0 4px 8px rgba(128, 237, 153, 0.4);
}
.save-settings-button:hover {
transform: translateY(-2px);
box-shadow: 0 6px 12px rgba(128, 237, 153, 0.6);
}

/* Reminder list styles */
#active-reminders-list {
list-style: none;
padding: 0;
}
#active-reminders-list li {
padding: 8px 0;
border-bottom: 1px dashed var(--border-color);
display: flex;
justify-content: space-between;
align-items: center;
font-size: 15px;
}
#active-reminders-list li:last-child {
border-bottom: none;
}

/* NEW: In-App Notification Styling for slide-in effect */
#in-app-notification {
position: fixed;
top: 20px;
right: 20px;
width: 300px;
background: var(--accent-blue);
color: var(--primary-bg);
padding: 15px;
border-radius: var(--radius);
box-shadow: 0 6px 20px rgba(0,0,0,0.5);
z-index: 1100; /* Above modals */
transform: translateX(120%); /* Start off-screen to the right */
/* Springy slide-in animation */
transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

#in-app-notification.show {
transform: translateX(0); /* Slide into view */
}

#in-app-notification h4 {
margin: 0 0 5px 0;
font-weight: bold;
font-size: 16px;
color: var(--primary-bg);
display: flex;
align-items: center;
}
#in-app-notification h4 span {
margin-right: 8px;
font-size: 20px;
}

#in-app-notification p {
margin: 0;
font-size: 14px;
}

/* NEW: Added Cropper and Avatar Preview CSS from ACcountSetings.html */
.cropper-container {
  border-radius: 9999px !important; /* fully rounded */
  overflow: hidden;
  border: 2px solid var(--border-color); /* Use theme variable */
  box-shadow: 0 3px 8px 0 rgba(0,0,0,0.07);
  margin: 0 auto;
  width: 260px;
  height: 260px;
  background: var(--primary-bg); /* Use theme variable */
}
.cropper-view-box, .cropper-face {
  border-radius: 50% !important;
}
.avatar-preview {
  width: 96px;
  height: 96px;
  border-radius: 9999px;
  border: 3px solid var(--accent-green); /* Use theme variable */
  object-fit: cover;
  margin: 0 auto;
}
.faded {
  opacity: 0.6;
}
</style>
</head>
<body id="app-body">
<div class="header">
<div class="flex items-center">
<span class="title-text">CROOMS CONNECT</span>
<span class="user-id-display" id="userIdDisplay">Local Theme Storage Active</span>
</div>
<div class="flex items-center space-x-2">
<img id="header-profile-picture" src="https://api.dicebear.com/6.x/thumbs/svg?seed=Anonymous" alt="Profile" 
     style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer; object-fit: cover; border: 2px solid var(--accent-blue);"
     title="View My Posts">
<a id="header-signin-button" href="auth.html" 
   style="display: none; background-color: var(--accent-blue); color: var(--primary-bg); font-weight: bold; padding: 8px 16px; border-radius: 10px; text-decoration: none; font-size: 14px; transition: all 0.3s;"
   onmouseover="this.style.backgroundColor='var(--accent-green)'; this.style.transform='translateY(-2px)';" 
   onmouseout="this.style.backgroundColor='var(--accent-blue)'; this.style.transform='none';">
   SIGN IN
</a>
</div>
</div>
<div class="left-box">
<button data-tab="home">Home</button>
<button data-tab="news">News</button>
<button data-tab="study">Study Tools</button>
<button data-tab="weather">Weather</button>
<button data-tab="legal">Legal</button>
<button data-tab="community">Community</button>
<button data-tab="polls">Polls</button>
<button data-tab="games">Games</button>
<button data-tab="settings">Settings</button>
</div>
<div class="right-box">
<div class="section" id="info-section" style="color: var(--accent-yellow); font-weight: bold;">Loading current time and day type...</div>
<div class="section" id="period-timer">Loading Period Timer...</div>
<div class="section" id="current-lunch-display">Loading Lunch...</div>
<div class="info">
<p data-food="Boneless Wings">M – Boneless Wings</p>
<p data-food="Orange Chicken">T – Orange Chicken</p>
<p data-food="Baked Pasta">W – Baked Pasta</p>
<p data-food="Burrito Bowl &gt;T – Burrito Bowl&lt;/p&gt;
&lt;p data-food=" nachos"="">F – Nachos</p>
</div>
</div>
<div class="tab-content active" id="home">
<section>
<button class="close-tab-button">×</button>
<h1>Welcome to Crooms Connect</h1>
<p>Your student hub with resources, schedules, and tools.</p>
<div class="card-grid">
<div class="card" id="events-card">
<span class="icon"> 📅 </span>
<h3>Events</h3>
<p>See what’s happening this week.</p>
</div>
</div>
</section>
</div>
<div class="tab-content" id="news">
<section>
<button class="close-tab-button">×</button>
<h1>News</h1>
<p>Latest campus announcements and updates.</p>
<div id="news-content">Loading news...</div>
</section>
</div>
<div class="tab-content" id="study">
<section>
<button class="close-tab-button">×</button>
<h1>Study Tools</h1>
<p>Helpful tools to keep you learning.</p>
<div class="card-grid">
<div class="card" onclick="window.open('https://quizlet.com/study-guides/upload', '_blank')"><span class="icon"> 📝 </span><h3>Flashcards</h3><p>Review terms quickly.</p></div>
<div class="card" onclick="window.open('https://minitoolai.com/ai-test-generator/', '_blank')"><span class="icon"> ❓ </span><h3>Practice Quizzes</h3><p>Test your knowledge.</p></div>
<div class="card" id="study-timer-card"><span class="icon"> ⏱️ </span><h3>Study Timer</h3><p>Set timers for focused study sessions.</p></div>
</div>
</section>
</div>
<div class="tab-content" id="weather">
<section>
<button class="close-tab-button">×</button>
<h1>Weather</h1>
<p>Current weather forecast for Florida.</p>
<div id="weather-content">Loading weather...</div>
</section>
</div>
<div class="tab-content" id="community">
<section>
<button class="close-tab-button">×</button>
<h1>Community</h1>
<p>Connect with classmates and teachers.</p>
<div class="card-grid">
<div class="card" id="clubs-card"><span class="icon"> 👥 </span><h3>Clubs</h3><p>Find and join school clubs.</p></div>
<div class="card"><span class="icon"> 💬 </span><h3>Forums<p><a href="connect.html">Discuss topics with peers.</a></p></h3></div>
</div>
</section>
</div>
<div class="tab-content" id="polls">
<section>
<button class="close-tab-button">×</button>
<h1>Community Daily Poll</h1>
<p>Vote on important topics.</p>
<div class="space-y-6" id="polls-container">
</div>
<p class="text-center text-gray-500 mt-6" id="no-polls">Loading polls...</p>
</section>
</div>
<div class="tab-content" id="games">
<section>
<button class="close-tab-button">×</button>
<h1>Games</h1>
<p>Fun mini-games to enjoy during breaks.</p>
<div class="card-grid">
<div class="card" id="trivia-card"><span class="icon"> 🎮 </span><h3>Trivia</h3><p>Test your knowledge in quick rounds.</p></div>
<div class="card" id="puzzle-card"><span class="icon"> 🧩 </span><h3>Puzzle</h3><p>Relax and challenge your mind.</p></div>
</div>
</section>
</div>
<div class="tab-content" id="settings">
<section>
<button class="close-tab-button">×</button>
<h1>User Settings &amp; Customization</h1>
<p>Personalize your experience. Your selections are saved locally.</p>
<div class="card-grid">
<div class="card theme-selector-card">
<span class="icon"> 🌓 </span>
<h3>Appearance</h3>
<p style="margin-bottom: 20px; font-size: 14px;">Toggle between Dark and Light mode.</p>
<div class="flex flex-col space-y-4">
<button class="theme-button" id="dark-mode-button">
<span class="icon"> 🌙 </span> Dark Mode
</button>
<button class="theme-button" id="light-mode-button">
<span class="icon"> ☀️ </span> Light Mode
</button>
</div>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="messageBox" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
<div class="card period-names-card">
<span class="icon"> 📚 </span>
<h3>Period Names</h3>
<p style="margin-bottom: 10px; font-size: 14px;">Personalize the names of your classes.</p>
<form class="settings-form" id="period-names-form">
<button class="save-settings-button" type="submit">Save Period Names</button>
</form>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="periodMessage" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
<div class="card lunch-names-card">
<span class="icon"> 🍔 </span>
<h3>Lunch Periods</h3>
<p style="margin-bottom: 10px; font-size: 14px;">Set which lunch you have for each schedule type.</p>
<form class="settings-form" id="lunch-names-form">
<label for="lunch-5th_Period_A">5th Period Lunch (Usually A Lunch)</label>
<input id="lunch-5th_Period_A" name="5th Period A" placeholder="A Lunch" type="text" value="A Lunch"/>
<label for="lunch-5th_Period_B">5th Period Lunch (Usually B Lunch)</label>
<input id="lunch-5th_Period_B" name="5th Period B" placeholder="B Lunch" type="text" value="B Lunch"/>
<label for="lunch-Homeroom_A">Homeroom Lunch (Wednesday A Lunch)</label>
<input id="lunch-Homeroom_A" name="Homeroom A" placeholder="A Lunch" type="text" value="A Lunch"/>
<label for="lunch-Homeroom_B">Homeroom Lunch (Wednesday B Lunch)</label>
<input id="lunch-Homeroom_B" name="Homeroom B" placeholder="B Lunch" type="text" value="B Lunch"/>
<button class="save-settings-button" type="submit">Save Lunch Periods</button>
</form>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="lunchMessage" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
<div class="card" id="notifications-card" style="cursor: pointer;">
<span class="icon"> 🔔 </span>
<h3>Reminders</h3>
<p>Set up alerts for important events.</p>
<button id="test-notification-button" style="margin-top: 10px; background: var(--accent-blue); color: var(--primary-bg); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;">Test Slide-in</button>
</div>
<div class="card" id="account-card"><span class="icon"> 🔑 </span><h3>Account</h3><p>Privacy and security options.</p></div>
<div class="card" id="display-card" style="cursor: pointer;"><span class="icon"> ⚙️ </span><h3>Display</h3><p>Adjust font size and layout.</p></div>
</div>
</section>
</div>
<div class="tab-content" id="legal">
<section>
<button class="close-tab-button">×</button>
<h1>Legal Disclaimer <span style="font-size: 14px; color: var(--text-color);"> (Last Updated: October 2nd, 2025)</span></h1>
<div class="disclaimer-point">
<strong>1. General Information &amp; Accuracy</strong>
<p>The information provided by Crooms Connect is for general informational purposes only. All information is provided in good faith;
however, we make no representation or warranty of any kind regarding the accuracy, adequacy, validity, reliability, availability, or completeness of any information, including schedules or event times.</p>
</div>
<div class="disclaimer-point">
<strong>2. Educational Purpose Only</strong>
<p>This platform is intended solely as an educational and communication tool for students.
It is not an official source for administrative, financial, or legal decisions.
Always refer to official school publications and staff for critical information.</p>
</div>
<div class="disclaimer-point">
<strong>3. External Links Disclaimer</strong>
<p>The platform may contain links to external websites that are not provided or maintained by or in any way affiliated with Crooms Connect.
Please note that we do not guarantee the accuracy, relevance, timeliness, or completeness of any information on these external websites.</p>
</div>
<div class="disclaimer-point">
<strong>4. "AS IS" and "AS AVAILABLE" Disclaimer</strong>
<p>The platform is provided "AS IS" and "AS AVAILABLE" and with all faults and defects without warranty of any kind.</p>
</div>
<div class="disclaimer-point">
<strong>5. User-Generated Content</strong>
<p>Users are responsible for any content they post. We are not responsible for user-generated content, but we reserve the right to remove any content we deem inappropriate or harmful.</p></div>
<div class="disclaimer-point">
<strong>6. Limitation of Liability</strong>
<p>Under no circumstance shall we be liable for any loss or damage of any kind incurred as a result of the use of the platform or reliance on any information provided.
Your use of the platform and your reliance on any information is solely at your own risk.</p>
</div>
<div class="disclaimer-point">
<strong>7. Indemnification Clause</strong>
<p>You agree to defend, indemnify, and hold harmless Crooms Connect, its developers, and affiliates from and against any claims, damages, obligations, losses, liabilities, costs, or debt arising from: (a) your use of and access to the platform;
(b) your violation of any term of this Disclaimer; or (c) any content you post on the platform.</p>
</div>
<div class="disclaimer-point">
<strong>8. Intellectual Property (IP)</strong>
<p>All original content, features, and functionality (excluding user-generated content) are and will remain the exclusive property of Crooms Connect.
By posting User-Generated Content, you grant Crooms Connect a worldwide, non-exclusive, royalty-free license to use, reproduce, and display that content on the platform.</p>
</div>
<div class="disclaimer-point">
<strong>9. User Conduct &amp; Termination</strong>
<p>We reserve the right, but not the obligation, to monitor and remove any User-Generated Content that we deem inappropriate, illegal, or in violation of these terms.
We may terminate or suspend access to our platform immediately, without prior notice or liability, for any reason, including without limitation if you breach this Disclaimer.</p>
</div>
</section>
</div>
<div class="modal-overlay" id="reminder-modal">
<div class="modal-content">
<button class="close-button" id="close-reminder-modal-button">×</button>
<h1>Set New Reminder</h1>
<form class="settings-form" id="reminder-form">
<label for="reminder-title">Title</label>
<input id="reminder-title" placeholder="e.g., Study for Math Test" required="" type="text"/>
<label for="reminder-date">Date</label>
<input id="reminder-date" required="" type="date"/>
<label for="reminder-time">Time</label>
<input id="reminder-time" required="" type="time"/>
<button class="save-settings-button" style="background: linear-gradient(45deg, var(--accent-blue), #2a8dff);" type="submit">Create Reminder</button>
<div id="reminder-list-container" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
<h3 style="color: var(--accent-yellow); margin-bottom: 10px;">Scheduled Reminders</h3>
<ul id="active-reminders-list"></ul>
</div>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="reminder-message" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</form>
</div>
</div>
<div class="modal-overlay" id="account-modal">
<div class="modal-content">
<button class="close-button" id="close-account-modal-button">×</button>
<h1>Account Settings</h1>
<form class="settings-form" id="account-form">
<label for="username">Username</label>
<input id="username" placeholder="New Username" type="text">
<label for="password">Password</label>
<input id="password" placeholder="New Password" type="password">

<label style="margin-top: 20px;">Profile Picture</label>
<div id="current-avatar-section" class="flex flex-col items-center mb-2">
    <img id="current-avatar" class="avatar-preview faded" src="" alt="Current Avatar" style="display:none;"/>
    <p id="no-avatar-text" class="text-gray-400 text-sm" style="color: var(--text-color); opacity: 0.7;">No profile picture set</p>
</div>

<input id="fileInput" type="file" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" style="color: var(--text-color);">

<div id="cropper-wrapper" class="cropper-container mt-3 mb-2" style="display:none; margin: 20px auto;">
    <img id="cropper-image" alt="Crop Preview" style="max-width:100%;display:block;" />
</div>

<button type="button" id="uploadBtn" class="bg-blue-600 text-white px-8 py-2 rounded-full font-semibold transition hover:bg-blue-700 disabled:opacity-60 mb-1 w-full" style="margin-top: 15px; background-color: var(--accent-blue); color: var(--primary-bg); font-weight: bold; padding: 10px; border-radius: 10px; cursor: pointer;" disabled>Save / Upload Picture</button>

<p id="status" class="text-center text-sm mt-2 h-5" style="color: var(--text-color); height: 1.25rem;"></p>
<div class="confirmation-message" id="confirmation-message" style="display: none;"></div>
<input id="save-changes" type="submit" value="Save Username/Password" class="save-settings-button" style="background: var(--accent-green); margin-top: 10px;">
</input></input></form>
</div>
</div>
<div class="modal-overlay" id="display-modal">
<div class="modal-content">
<button class="close-button" id="close-display-modal-button">×</button>
<h1>Font &amp; Layout Settings</h1>
<div class="settings-form">
<div style="display: flex; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; align-items: flex-end;">
<div style="flex: 1 1 200px;">
<label for="font-size">Font Size:</label>
<select id="font-size">
<option value="14px">Small</option>
<option selected="" value="16px">Medium</option>
<option value="20px">Large</option>
<option value="24px">Extra Large</option>
</select>
</div>
<div style="flex: 1 1 200px;">
<label for="font-color">Font Color:</label>
<input id="font-color" type="color" value="#333333"/>
</div>
<div style="flex: 1 1 200px;">
<label for="bg-upload">Upload Background Image:</label>
<input accept="image/*" id="bg-upload" type="file">
</input></div>
<div style="flex: 1 1 200px;">
<button id="reset-display-settings" style="width: 100%; padding: 10px; font-size: 1rem; margin-top: 5px; cursor: pointer; background: var(--accent-red); color: var(--primary-bg); border: none; border-radius: 5px;">Reset Settings</button>
</div>
</div>
<div style="background: rgba(0,0,0,0.03); padding: 20px; border-radius: 8px;">
<h2>Example Section</h2>
<p>This is sample text to demonstrate font size, font color, and background customization. Use the controls above to modify the appearance.</p>
</div>
</div>
<div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="display-message" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
</div>
</div>
<div class="modal-overlay" id="clubs-modal">
<div class="modal-content">
<button class="close-button" id="close-clubs-modal-button">×</button>
<h1>School Clubs</h1>
<div id="clubs-content">
</div>
</div>
</div>
<div class="modal-overlay" id="trivia-modal">
<div class="modal-content">
<button class="close-button" id="close-trivia-modal-button">×</button>
<h1>Daily Trivia</h1>
<div id="trivia-content">
</div>
</div>
</div>
<div class="modal-overlay" id="puzzle-modal">
<div class="modal-content">
<button class="close-button" id="close-puzzle-modal-button">×</button>
<h1>Sliding Puzzle</h1>
<div id="puzzle-content">
</div>
</div>
</div>
<div class="modal-overlay" id="calendar-modal">
<div class="modal-content">
<button class="close-button" id="close-calendar-modal-button">×</button>
<h1>Yearly Calendar</h1>
<div id="calendar-content">
</div>
</div>
</div>
<div class="modal-overlay" id="study-timer-modal">
<div class="modal-content">
<button class="close-button" id="close-study-timer-modal-button">×</button>
<h1>Study Timer</h1>
<div id="study-timer-content">
<label for="study-minutes">Set Minutes:</label>
<input id="study-minutes" max="120" min="1" type="number" value="25"/>
<br/><br/>
<button id="start-study-timer">Start</button>
<button disabled="" id="pause-study-timer">Pause</button>
<button id="reset-study-timer">Reset</button>
<br/><br/>
<div id="study-timer-display" style="font-size: 48px; text-align: center;">00:00</div>
</div>
</div>
</div>

<div class="modal-overlay" id="my-posts-modal">
    <div class="modal-content">
        <button class="close-button" id="close-my-posts-modal-button">×</button>
        <h1>My Posts</h1>

        <details style="margin-bottom: 20px; background: var(--card-bg-subtle); border-radius: 10px; border: 1px solid var(--border-color);">
            <summary style="padding: 10px 15px; cursor: pointer; font-weight: bold; color: var(--accent-yellow);">
                Customize Appearance
            </summary>
            <form class="settings-form" id="my-posts-display-form" style="padding: 0 15px 15px 15px;">
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1 1 150px;">
                        <label for="my-posts-bg-color">Background Color:</label>
                        <input type="color" id="my-posts-bg-color" value="#2b2d42" style="width: 100%; height: 40px; padding: 5px;">
                    </div>
                    <div style="flex: 1 1 150px;">
                        <label for="my-posts-font-color">Font Color:</label>
                        <input type="color" id="my-posts-font-color" value="#f8f9fa" style="width: 100%; height: 40px; padding: 5px;">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <label for="my-posts-bg-image">Upload Background Image:</label>
                    <input type="file" id="my-posts-bg-image" accept="image/*" style="width: 100%;">
                </div>
                <button type="button" id="my-posts-reset-display" class="save-settings-button" style="background: var(--accent-red); box-shadow: 0 4px 8px rgba(239, 71, 111, 0.4); margin-top: 20px;">Reset Appearance</button>
                <div class="p-3 mt-4 text-center rounded-lg font-medium hidden" id="my-posts-display-message" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
            </form>
        </details>
        <div id="my-posts-content" style="max-height: 50vh; overflow-y: auto; padding-top: 15px; border-top: 1px solid var(--border-color);">
            <p>Loading your posts...</p>
        </div>
    </div>
</div>

<div id="in-app-notification">
<h4><span>🔔</span> Reminder Fired</h4>
<p id="notification-message">Your reminder message goes here.</p>
</div>
<footer>
<p>© 2025 Crooms Connect</p>
</footer>
<img id="preview"/>
<div class="calendar-tooltip" id="calendar-tooltip"></div>
<script>
// --- Supabase Client (NEW) ---
// Using Supabase CDN
const { createClient } = supabase; 
const SUPABASE_URL = 'https://jxxnfsydjrflnephmfjm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w';
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null; // To store the user object

// --- SCHEDULE DATA ---
const defaultSchedules = {
"Monday": [
{ period: "1st Period", start: "07:20", end: "08:13" },
{ period: "2nd Period", start: "08:18", end: "09:10" },
{ period: "3rd Period", start: "09:15", end: "10:05" },
{ period: "4th Period", start: "10:10", end: "11:02" },
{ period: "5th Period A", start: "11:07", end: "11:57" }, // Class
{ period: "5th Period B", start: "11:57", end: "12:27" }, // Lunch
{ period: "6th Period", start: "12:32", end: "13:24" },
{ period: "7th Period", start: "13:29", end: "14:20" }
],
"Tuesday": [
{ period: "1st Period", start: "07:20", end: "08:13" },
{ period: "2nd Period", start: "08:18", end: "09:10" },
{ period: "3rd Period", start: "09:15", end: "10:05" },
{ period: "4th Period", start: "10:10", end: "11:02" },
{ period: "5th Period A", start: "11:07", end: "11:57" }, // Class
{ period: "5th Period B", start: "11:57", end: "12:27" }, // Lunch
{ period: "6th Period", start: "12:32", end: "13:24" },
{ period: "7th Period", start: "13:29", end: "14:20" }
],
"Wednesday": [
{ period: "2nd Period", start: "07:20", end: "08:49" },
{ period: "4th Period", start: "08:55", end: "10:21" },
{ period: "Homeroom B", start: "10:27", end: "11:17" }, // Lunch
{ period: "Homeroom A", start: "11:17", end: "11:47" }, // Class/Homeroom
{ period: "6th Period", start: "11:53", end: "13:20" }
],
"Thursday": [
{ period: "1st Period", start: "07:20", end: "08:55" },
{ period: "3rd Period", start: "09:01", end: "10:33" },
{ period: "5th Period B", start: "10:39", end: "12:11" }, // Class
{ period: "5th Period A", start: "12:11", end: "12:41" }, // Lunch
{ period: "7th Period", start: "12:47", end: "14:20" }
],
"Friday": [
{ period: "1st Period", start: "07:20", end: "08:13" },
{ period: "2nd Period", start: "08:18", end: "09:10" },
{ period: "3rd Period", start: "09:15", end: "10:05" },
{ period: "4th Period", start: "10:10", end: "11:02" },
{ period: "5th Period A", start: "11:07", end: "11:57" }, // Class
{ period: "5th Period B", start: "11:57", end: "12:27" }, // Lunch
{ period: "6th Period", start: "12:32", end: "13:24" },
{ period: "7th Period", start: "13:29", end: "14:20" }
]
};
let schedules = JSON.parse(JSON.stringify(defaultSchedules)); // Working copy of schedules

// --- CONSTANTS ---
const THEME_STORAGE_KEY = 'croomsConnectThemeMode';
const NAMES_STORAGE_KEY = 'croomsConnectPeriodNames';
const LUNCH_STORAGE_KEY = 'croomsConnectLunchNames';
const REMINDER_STORAGE_KEY = 'croomsConnectReminders';
const DISPLAY_STORAGE_KEY = 'croomsConnectDisplaySettings';
const TRIVIA_STORAGE_KEY = 'croomsConnectTrivia';
const DEFAULT_MODE = 'dark'; // Set the default to dark

// Map of period names (keys) to their default associated lunch names (values)
const DEFAULT_LUNCH_MAP = {
"5th Period B": "B Lunch", // Standard Lunch time (M, T, F)
"5th Period A": "A Lunch", // Standard Lunch time (Thur)
"Homeroom B": "B Lunch", // Wednesday Lunch time
"Homeroom A": "A Lunch" // Wednesday Lunch time
};

// --- DOM Elements ---
const appBody = document.getElementById('app-body');
const darkModeButton = document.getElementById('dark-mode-button');
const lightModeButton = document.getElementById('light-mode-button');
const messageBox = document.getElementById('messageBox');
const tabs = document.querySelectorAll(".tab-content");
const homeButton = document.querySelector(".left-box button[data-tab='home']");
const periodNamesForm = document.getElementById('period-names-form');
const periodMessageBox = document.getElementById('periodMessage');
const lunchNamesForm = document.getElementById('lunch-names-form');
const lunchMessageBox = document.getElementById('lunchMessage');
const currentLunchDisplay = document.getElementById('current-lunch-display');
const notificationsCard = document.getElementById('notifications-card');
const reminderModal = document.getElementById('reminder-modal');
const reminderForm = document.getElementById('reminder-form');
const reminderMessageBox = document.getElementById('reminder-message');
const activeRemindersList = document.getElementById('active-reminders-list');
const closeReminderModalButton = document.getElementById('close-reminder-modal-button');
const inAppNotification = document.getElementById('in-app-notification');
const testNotificationButton = document.getElementById('test-notification-button'); // NEW
const accountCard = document.getElementById('account-card');
const accountModal = document.getElementById('account-modal');
const accountForm = document.getElementById('account-form');
const closeAccountModalButton = document.getElementById('close-account-modal-button');
const confirmationMessage = document.getElementById('confirmation-message');
const displayCard = document.getElementById('display-card');
const displayModal = document.getElementById('display-modal');
const closeDisplayModalButton = document.getElementById('close-display-modal-button');
const resetDisplayButton = document.getElementById('reset-display-settings');
const clubsCard = document.getElementById('clubs-card');
const clubsModal = document.getElementById('clubs-modal');
const closeClubsModalButton = document.getElementById('close-clubs-modal-button');
const triviaCard = document.getElementById('trivia-card');
const triviaModal = document.getElementById('trivia-modal');
const closeTriviaModalButton = document.getElementById('close-trivia-modal-button');
const puzzleCard = document.getElementById('puzzle-card');
const puzzleModal = document.getElementById('puzzle-modal');
const closePuzzleModalButton = document.getElementById('close-puzzle-modal-button');
const calendarModal = document.getElementById('calendar-modal');
const closeCalendarModalButton = document.getElementById('close-calendar-modal-button');
const eventsCard = document.getElementById('events-card');
const studyTimerCard = document.getElementById('study-timer-card');
const studyTimerModal = document.getElementById('study-timer-modal');
const closeStudyTimerModalButton = document.getElementById('close-study-timer-modal-button');
const startStudyTimerButton = document.getElementById('start-study-timer');
const pauseStudyTimerButton = document.getElementById('pause-study-timer');
const resetStudyTimerButton = document.getElementById('reset-study-timer');
const studyTimerDisplay = document.getElementById('study-timer-display');
const studyMinutesInput = document.getElementById('study-minutes');

// --- NEW DOM Elements for Auth/Posts ---
const headerProfilePicture = document.getElementById('header-profile-picture');
const headerSignInButton = document.getElementById('header-signin-button'); // <-- ADDED
const myPostsModal = document.getElementById('my-posts-modal');
const closeMyPostsModalButton = document.getElementById('close-my-posts-modal-button');
const myPostsContent = document.getElementById('my-posts-content');

// --- NEW DOM Elements for "My Posts" Customization (Supabase) ---
const myPostsModalContent = myPostsModal.querySelector('.modal-content');
const myPostsBgColorInput = document.getElementById('my-posts-bg-color');
const myPostsFontColorInput = document.getElementById('my-posts-font-color');
const myPostsBgImageInput = document.getElementById('my-posts-bg-image');
const myPostsResetButton = document.getElementById('my-posts-reset-display');
const myPostsDisplayMessage = document.getElementById('my-posts-display-message');


// --- NEW: Profile Picture Uploader Vars ---
let cropper = null;
let oldAvatarPath = null;
// These DOM elements will be selected when the modal is opened
let fileInput, cropperWrapper, cropperImg, uploadBtn, currentAvatar, noAvatarText, status;


// --- MODIFIED AUTH FUNCTION ---
async function loadUserSession() {
    const { data: authData, error: authErr } = await supabaseClient.auth.getUser();

    if (!authData?.user) {
        console.log("No user logged in. Showing Sign In button.");
        headerProfilePicture.style.display = 'none'; // <-- HIDE PIC
        if (headerSignInButton) headerSignInButton.style.display = 'block'; // <-- SHOW BUTTON
        document.getElementById('userIdDisplay').textContent = "Not Logged In";
        currentUser = null;
        return;
    }

    // User is logged in
    headerProfilePicture.style.display = 'block'; // <-- SHOW PIC
    if (headerSignInButton) headerSignInButton.style.display = 'none'; // <-- HIDE BUTTON

    currentUser = authData.user; // Store user globally
    const userId = authData.user.id;
    const { data: profile } = await supabaseClient
        .from("profiles")
        .select("username")
        .eq("id", userId)
        .single();

    const currentUsername = (profile?.username || "Anonymous").replace(/@croomsconnect\.local$/i, '');
    const customAvatar = authData.user.user_metadata?.avatar_url;

    headerProfilePicture.src = customAvatar && customAvatar.trim() !== ""
        ? customAvatar
        : `https://api.dicebear.com/6.x/thumbs/svg?seed=${encodeURIComponent(currentUsername)}`;
    
    document.getElementById('userIdDisplay').textContent = `Logged in as: ${currentUsername}`;
}

// --- NEW "MY POSTS" DISPLAY SETTINGS FUNCTIONS (Supabase) ---
const applyMyPostsDisplaySettings = (settings) => {
    myPostsModalContent.style.backgroundColor = settings.bg_color || '';
    myPostsModalContent.style.color = settings.font_color || '';

    if (settings.bg_image_url) {
        myPostsModalContent.style.backgroundImage = `url(${settings.bg_image_url})`;
        myPostsModalContent.style.backgroundSize = 'cover';
        myPostsModalContent.style.backgroundPosition = 'center';
    } else {
        myPostsModalContent.style.backgroundImage = '';
    }
};

const saveMyPostsDisplaySettings = async (settings) => {
    if (!currentUser) return;

    const { error } = await supabaseClient
        .from('user_post_styles')
        .upsert({ 
            id: currentUser.id, 
            ...settings,
            updated_at: new Date() 
        });

    if (error) {
        console.error('Error saving settings:', error);
        showMessageBox(myPostsDisplayMessage, `Error: ${error.message}`, 'error');
    } else {
        showMessageBox(myPostsDisplayMessage, 'Appearance updated!', 'success');
        const { data } = await supabaseClient.from('user_post_styles').select().single();
        if(data) applyMyPostsDisplaySettings(data);
    }
};

const resetMyPostsDisplaySettings = async () => {
    if (!currentUser) return;

    // First delete the record from Supabase
    const { error } = await supabaseClient
        .from('user_post_styles')
        .delete()
        .eq('id', currentUser.id);

    if (error) {
        console.error('Error resetting settings:', error);
        showMessageBox(myPostsDisplayMessage, `Error: ${error.message}`, 'error');
        return;
    }

    // Then apply empty settings to clear styles
    applyMyPostsDisplaySettings({});
    
    // Reset form inputs to default
    myPostsBgColorInput.value = '#2b2d42';
    myPostsFontColorInput.value = '#f8f9fa';
    myPostsBgImageInput.value = '';
    
    showMessageBox(myPostsDisplayMessage, 'Appearance settings reset!', 'success');
};


// --- MODIFIED "MY POSTS" MODAL FUNCTIONS (Supabase) ---
const showMyPostsModal = async () => {
    if (!currentUser) {
        // This should not be reachable if the button is hidden, but as a fallback:
        alert("Please log in to see your posts.");
        return;
    }
    
    // --- Load and apply custom display settings from Supabase ---
    const { data: settings, error: settingsError } = await supabaseClient
        .from('user_post_styles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

    if (settings) {
        applyMyPostsDisplaySettings(settings);
        // Set form inputs to reflect saved settings or defaults
        myPostsBgColorInput.value = settings.bg_color || '#2b2d42';
        myPostsFontColorInput.value = settings.font_color || '#f8f9fa';
    } else {
         // Apply default styles if no settings found
        applyMyPostsDisplaySettings({});
        myPostsBgColorInput.value = '#2b2d42';
        myPostsFontColorInput.value = '#f8f9fa';
    }
     myPostsBgImageInput.value = ''; // Always clear file input
    

    myPostsContent.innerHTML = "<p>Loading your posts...</p>";
    myPostsModal.classList.add('show');
    document.body.style.overflow = 'hidden';

    const { data: messages, error } = await supabaseClient
        .from('messages')
        .select('message, timestamp')
        .eq('user_id', currentUser.id)
        .order('timestamp', { ascending: false })
        .limit(50);

    if (error) {
        myPostsContent.innerHTML = `<p style="color: var(--accent-red);">Error loading posts: ${error.message}</p>`;
        return;
    }

    if (!messages || messages.length === 0) {
        myPostsContent.innerHTML = "<p>You haven't posted anything yet.</p>";
        return;
    }

    let html = '';
    messages.forEach(msg => {
        const postDate = new Date(msg.timestamp).toLocaleString();
        html += `
            <div style="background: var(--card-bg-subtle); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 10px; word-wrap: break-word;">
                <div style="font-size: 0.85rem; color: var(--accent-yellow); margin-bottom: 5px;">${postDate}</div>
                <div>${msg.message}</div> 
            </div>
        `;
    });
    myPostsContent.innerHTML = html;
};

const hideMyPostsModal = () => {
    myPostsModal.classList.remove('show');
    document.body.style.overflow = '';
    applyMyPostsDisplaySettings({}); 
    myPostsDisplayMessage.classList.add('hidden');
};

// --- STUDY TIMER STATE VARIABLES ---
let studyTimerInterval = null;
let studyTimeLeft = 0;

// Study Timer Functions
function updateStudyTimerDisplay() {
  const minutes = Math.floor(studyTimeLeft / 60);
  const seconds = studyTimeLeft % 60;
  studyTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startStudyTimer() {
  const minutes = parseInt(studyMinutesInput.value) || 25;
  studyTimeLeft = minutes * 60;
  updateStudyTimerDisplay();
  if (studyTimerInterval) clearInterval(studyTimerInterval);
  studyTimerInterval = setInterval(() => {
    studyTimeLeft--;
    updateStudyTimerDisplay();
    if (studyTimeLeft <= 0) {
      clearInterval(studyTimerInterval);
      studyTimerInterval = null;
      alert("Time's up! Take a break.");
      studyTimeLeft = 0;
      updateStudyTimerDisplay();
      startStudyTimerButton.disabled = false;
      pauseStudyTimerButton.disabled = true;
      resetStudyTimerButton.disabled = true;
    }
  }, 1000);
  startStudyTimerButton.disabled = true;
  pauseStudyTimerButton.disabled = false;
  resetStudyTimerButton.disabled = false;
}

function pauseStudyTimer() {
  if (studyTimerInterval) {
    clearInterval(studyTimerInterval);
    studyTimerInterval = null;
  }
  startStudyTimerButton.disabled = false;
  pauseStudyTimerButton.disabled = true;
}

function resetStudyTimer() {
  if (studyTimerInterval) {
    clearInterval(studyTimerInterval);
    studyTimerInterval = null;
  }
  studyTimeLeft = 0;
  updateStudyTimerDisplay();
  startStudyTimerButton.disabled = false;
  pauseStudyTimerButton.disabled = true;
  resetStudyTimerButton.disabled = true;
}

const showStudyTimerModal = () => {
  studyTimerModal.classList.add('show');
  document.body.style.overflow = 'hidden';
};

const hideStudyTimerModal = () => {
  studyTimerModal.classList.remove('show');
  document.body.style.overflow = '';
  pauseStudyTimer();
};

// Sample events data
const events = [
{ date: '2025-01-01', title: 'New Year\'s Day' },
{ date: '2025-01-20', title: 'Martin Luther King Jr. Day' },
{ date: '2025-02-14', title: 'Valentine\'s Day' },
{ date: '2025-02-17', title: 'Presidents\' Day' },
{ date: '2025-03-17', title: 'St. Patrick\'s Day' },
{ date: '2025-04-01', title: 'April Fools\' Day' },
{ date: '2025-05-26', title: 'Memorial Day' },
{ date: '2025-07-04', title: 'Independence Day' },
{ date: '2025-09-01', title: 'Labor Day' },
{ date: '2025-10-31', title: 'Halloween' },
{ date: '2025-10-14', title: 'PSAT/SAT Q2 starts' },
{ date: '2025-11-27', title: 'Thanksgiving' },
{ date: '2025-12-18', title: 'End of Q2' }
];

// --- PUZZLE CONSTANTS ---
const PUZZLE_LEVELS = [3, 4, 5]; // Grid sizes: 3x3, 4x4, 5x5

// --- PUZZLE STATE VARIABLES ---
let currentPuzzleLevel = 3;
let puzzleGrid = [];
let emptyTile = { row: 2, col: 2 }; // For 3x3, starts at bottom-right

const clubsData = [
{ name: "Amine Club", description: "Meets in 1-201", meetingDay: "Monday", time: "2:30 PM - 4:00 PM" },
{ name: "Art Club", description: "Meets in 1-114", meetingDay: "Tuesday", time: "2:30 PM - 3:30 PM" },
{ name: "Board Game Club", description: "Meets in 1-113", meetingDay: "Wednesday", time: "2:30 PM - 3:45 PM" },
{ name: "Book Club", description: "Meets in 1-115", meetingDay: "Every first Monday of every month", time: "2:30 PM - 4:00 PM" },
{ name: "Chem Lab Crew", description: "Meets in 1-221", meetingDay: "Thursday", time: "2:30 PM - 3:45 PM" },
{ name: "Chess Club", description: "Meets in 2-111", meetingDay: "Monday", time: "2:30 PM - 3:30 PM" },
{ name: "Club SWAG", description: "Meets in 1-211", meetingDay: "Wednesday", time: "After school" },
{ name: "Cinema Club", description: "Meets in 1-209", meetingDay: "Friday", time: "2:30 PM - 4:30 PM" },
{ name: "Computer Science", description: "Meets in 1-224", meetingDay: "Tuesday", time: "2:30 PM - 3:30 PM" },
{ name: "DnD Club", description: "Meets in 1-132", meetingDay: "Mondays", time: "2:30 PM - 4:30 PM" },
{ name: "eSports", description: "Meets in 1-212", meetingDay: "Fridays", time: "2:30 PM - 4:00 PM" },
{ name: "H.E.A.L", description: "Meets in 1-126", meetingDay: "Twice a month", time: "2:40 PM - 4:00 PM" },
{ name: "Paleontology Club", description: "Meets in 1-232", meetingDay: "Tuesdays", time: "2:30 PM - 3:30 PM" },
{ name: "Pride Panthers", description: "Meets in 1-113", meetingDay: "Fridays", time: "2:20 PM - 3:45 PM" },
{ name: "Robotics", description: "Meets in 1-113", meetingDay: "Thursday", time: "2:30 PM - 4:00 PM" },
{ name: "Spanish Club", description: "Meets in 1-209", meetingDay: "Friday", time: "" }
];

const newsData = [
{ title: "Campus Library Expansion Announced", description: "Details on the new library wing opening next semester.", link: "https://example.com/news1" },
{ title: "Student Art Exhibition This Weekend", description: "Showcase of student artwork in the main hall.", link: "https://example.com/news2" },
{ title: "New Cafeteria Menu Options", description: "Introducing healthier and diverse meal choices.", link: "https://example.com/news3" }
];

const renderNews = () => {
let html = '<h2>Latest News</h2><ul>';
newsData.forEach(news => {
html += `<li><strong><a href="${news.link}" target="_blank">${news.title}</a></strong>: ${news.description}</li>`;
});
html += '</ul>';
document.getElementById('news-content').innerHTML = html;
};

const renderClubs = () => {
let html = '<h2>Club List</h2><ul>';
clubsData.forEach(club => {
html += `<li><strong>${club.name}</strong>: ${club.description} - Meets ${club.meetingDay} at ${club.time}</li>`;
});
html += '</ul>';
html += '<h2>Weekly Calendar</h2><p>Club meetings are scheduled as follows:</p><ul>';
const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
days.forEach(day => {
const dayClubs = clubsData.filter(c => c.meetingDay === day);
if (dayClubs.length > 0) {
html += `<li><strong>${day}</strong>: ${dayClubs.map(c => `${c.name} (${c.time})`).join(', ')}</li>`;
} else {
html += `<li><strong>${day}</strong>: No club meetings</li>`;
}
});
html += '</ul>';
document.getElementById('clubs-content').innerHTML = html;
};

const showClubsModal = () => {
renderClubs();
clubsModal.classList.add('show');
document.body.style.overflow = 'hidden';
};

const hideClubsModal = () => {
clubsModal.classList.remove('show');
document.body.style.overflow = '';
};

// --- TRIVIA UTILITIES ---

const fetchTrivia = async () => {
const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
const key = `trivia-${today}`;
let stored = localStorage.getItem(TRIVIA_STORAGE_KEY);
if (stored) {
stored = JSON.parse(stored);
if (stored.date === today) {
return stored;
}
}
// Fetch new
try {
const response = await fetch('https://opentdb.com/api.php?amount=1&type=multiple');
const data = await response.json();
const question = data.results[0];
const options = [...question.incorrect_answers, question.correct_answer];
const shuffled = options.sort(() => Math.random() - 0.5);
const trivia = {
date: today,
question: question.question,
options: shuffled,
correct: question.correct_answer,
answered: false,
selected: null
};
localStorage.setItem(TRIVIA_STORAGE_KEY, JSON.stringify(trivia));
return trivia;
} catch (e) {
console.error('Error fetching trivia:', e);
return null;
}
};

const renderTrivia = (trivia) => {
if (!trivia) {
document.getElementById('trivia-content').innerHTML = '<p>Unable to load trivia. Try again later.</p>';
return;
}
let html = `<h3>${trivia.question}</h3>`;
if (trivia.answered) {
html += '<p>You have already answered today\'s trivia.</p>';
html += `<p>Your answer: ${trivia.selected}</p>`;
html += `<p>Correct answer: ${trivia.correct}</p>`;
html += `<p>${trivia.selected === trivia.correct ? 'Correct!' : 'Incorrect.'}</p>`;
} else {
html += '<div id="options">';
trivia.options.forEach((option, index) => {
html += `<button class="trivia-option" data-option="${option}">${option}</button>`;
});
html += '</div>';
}
document.getElementById('trivia-content').innerHTML = html;

// Add listeners for options
document.querySelectorAll('.trivia-option').forEach(btn => {
btn.addEventListener('click', (e) => {
const selected = e.target.getAttribute('data-option');
trivia.selected = selected;
trivia.answered = true;
localStorage.setItem(TRIVIA_STORAGE_KEY, JSON.stringify(trivia));
renderTrivia(trivia);
});
});
};

const showTriviaModal = async () => {
const trivia = await fetchTrivia();
renderTrivia(trivia);
triviaModal.classList.add('show');
document.body.style.overflow = 'hidden';
};

const hideTriviaModal = () => {
triviaModal.classList.remove('show');
document.body.style.overflow = '';
};

// --- PUZZLE UTILITIES ---

const generatePuzzle = (level) => {
const size = level;
const totalTiles = size * size;
const grid = [];
let number = 1;
for (let row = 0; row < size; row++) {
grid[row] = [];
for (let col = 0; col < size; col++) {
if (row === size - 1 && col === size - 1) {
grid[row][col] = null; // Empty tile
} else {
grid[row][col] = number++;
}
}
}
// Simple shuffle: swap random tiles
for (let i = 0; i < 1000; i++) {
const r1 = Math.floor(Math.random() * size);
const c1 = Math.floor(Math.random() * size);
const r2 = Math.floor(Math.random() * size);
const c2 = Math.floor(Math.random() * size);
[grid[r1][c1], grid[r2][c2]] = [grid[r2][c2], grid[r1][c1]];
}
// Find empty tile position
for (let row = 0; row < size; row++) {
for (let col = 0; col < size; col++) {
if (grid[row][col] === null) {
emptyTile = { row, col };
}
}
}
return grid;
};

const renderPuzzle = () => {
const size = currentPuzzleLevel;
const grid = puzzleGrid;
let html = '<div style="text-align: center; margin-bottom: 20px;">';
html += '<h3>Level: ' + size + 'x' + size + '</h3>';
html += '<div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">';
PUZZLE_LEVELS.forEach(level => {
html += `<button class="puzzle-level-btn" data-level="${level}" style="padding: 10px 15px; background: var(--accent-blue); color: var(--primary-bg); border: none; border-radius: 5px; cursor: pointer;">${level}x${level}</button>`;
});
html += '</div>';
html += '<div class="puzzle-grid" style="display: inline-block; border: 2px solid var(--border-color);">';
for (let row = 0; row < size; row++) {
for (let col = 0; col < size; col++) {
const tile = grid[row][col];
const isEmpty = tile === null;
html += `<div class="puzzle-tile ${isEmpty ? 'empty' : ''}" data-row="${row}" data-col="${col}" style="width: 60px; height: 60px; display: inline-block; border: 1px solid var(--border-color); background: ${isEmpty ? 'var(--card-bg-subtle)' : 'var(--accent-blue)'}; color: var(--primary-bg); font-size: 24px; font-weight: bold; cursor: pointer; text-align: center; line-height: 60px; margin: 0; vertical-align: top;">${isEmpty ? '' : tile}</div>`;
}
html += '<br>';
}
html += '</div>';
html += '<p id="puzzle-status" style="margin-top: 20px; font-weight: bold;">Move the tiles to solve the puzzle!</p>';
html += '</div>';
document.getElementById('puzzle-content').innerHTML = html;

// Add listeners for level buttons
document.querySelectorAll('.puzzle-level-btn').forEach(btn => {
btn.addEventListener('click', (e) => {
const level = parseInt(e.target.getAttribute('data-level'));
currentPuzzleLevel = level;
puzzleGrid = generatePuzzle(level);
renderPuzzle();
});
});

// Add listeners for tiles
document.querySelectorAll('.puzzle-tile:not(.empty)').forEach(tile => {
tile.addEventListener('click', (e) => {
const row = parseInt(e.target.getAttribute('data-row'));
const col = parseInt(e.target.getAttribute('data-col'));
moveTile(row, col);
});
});
};

const moveTile = (row, col) => {
const size = currentPuzzleLevel;
const grid = puzzleGrid;
const empty = emptyTile;
// Check if adjacent
const dr = Math.abs(row - empty.row);
const dc = Math.abs(col - empty.col);
if ((dr === 1 && dc === 0) || (dr === 0 && dc === 1)) {
// Swap
[grid[empty.row][empty.col], grid[row][col]] = [grid[row][col], grid[empty.row][empty.col]];
emptyTile = { row, col };
renderPuzzle();
if (checkWin()) {
document.getElementById('puzzle-status').textContent = 'Congratulations! Puzzle solved!';
}
}
};

const checkWin = () => {
const size = currentPuzzleLevel;
const grid = puzzleGrid;
let number = 1;
for (let row = 0; row < size; row++) {
for (let col = 0; col < size; col++) {
if (row === size - 1 && col === size - 1) {
if (grid[row][col] !== null) return false;
} else {
if (grid[row][col] !== number++) return false;
}
}
}
return true;
};

const showPuzzleModal = () => {
puzzleGrid = generatePuzzle(currentPuzzleLevel);
renderPuzzle();
puzzleModal.classList.add('show');
document.body.style.overflow = 'hidden';
};

const hidePuzzleModal = () => {
puzzleModal.classList.remove('show');
document.body.style.overflow = '';
};
const showCalendarModal = () => {
renderCalendar();
calendarModal.classList.add('show');
document.body.style.overflow = 'hidden';
};
const hideCalendarModal = () => {
calendarModal.classList.remove('show');
document.body.style.overflow = '';
};
const renderCalendar = () => {
const now = new Date();
const year = now.getFullYear();
const eventMap = new Map();
events.forEach(event => eventMap.set(event.date, event.title));
let html = `<h2>${year} Calendar</h2>`;
html += '<div class="calendar-grid">';
for (let month = 0; month < 12; month++) {
const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });
html += `<div class="calendar-month"><h3>${monthName}</h3><div class="days">`;
const firstDay = new Date(year, month, 1).getDay();
const daysInMonth = new Date(year, month + 1, 0).getDate();
for (let i = 0; i < firstDay; i++) {
html += '<div class="day"></div>';
}
for (let day = 1; day <= daysInMonth; day++) {
const date = new Date(year, month, day);
const dayOfWeek = date.getDay();
let className = 'day';
if (day === now.getDate() && month === now.getMonth()) {
className += ' today';
}
if (dayOfWeek === 0 || dayOfWeek === 6) {
className += ' holiday';
}
const dateStr = date.toISOString().split('T')[0];
const eventTitle = eventMap.get(dateStr);
if (eventTitle) {
className += ' event-day';
}
let dataAttr = eventTitle ? ` data-event-title="${eventTitle}"` : '';
html += `<div class="${className}"${dataAttr}>${day}</div>`;
}
html += '</div></div>';
}
html += '</div>';
document.getElementById('calendar-content').innerHTML = html;

// Add event listeners for tooltips
document.querySelectorAll('.event-day').forEach(day => {
day.addEventListener('mouseenter', (e) => {
const title = e.target.getAttribute('data-event-title');
if (title) {
const tooltip = document.getElementById('calendar-tooltip');
tooltip.textContent = title;
const rect = e.target.getBoundingClientRect();
tooltip.style.left = (rect.right + 10) + 'px';
tooltip.style.top = rect.top + 'px';
tooltip.style.display = 'block';
}
});
day.addEventListener('mouseleave', () => {
const tooltip = document.getElementById('calendar-tooltip');
tooltip.style.display = 'none';
});
});
};

// --- WEATHER UTILITIES ---

const fetchWeather = async () => {
try {
const response = await fetch('https://wttr.in/Orlando?format=j1');
const data = await response.json();
const current = data.current_condition[0];
const temp = current.temp_F;
const condition = current.weatherDesc[0].value;
const feels = current.FeelsLikeF;
const humidity = current.humidity;
const wind = current.windspeedMiles;
document.getElementById('weather-content').innerHTML = `
<div class="card-grid">
<div class="card">
<span class="icon">🌤️</span>
<h3>Current Weather in Florida</h3>
<p><strong>Temperature:</strong> ${temp}°F</p>
<p><strong>Condition:</strong> ${condition}</p>
<p><strong>Feels Like:</strong> ${feels}°F</p>
<p><strong>Humidity:</strong> ${humidity}%</p>
<p><strong>Wind Speed:</strong> ${wind} mph</p>
</div>
</div>
`;
} catch (e) {
document.getElementById('weather-content').innerHTML = '<p>Unable to load weather. Please try again later.</p>';
}
};

// --- DISPLAY SETTINGS UTILITIES ---

const loadDisplaySettings = () => {
try {
const settings = JSON.parse(localStorage.getItem(DISPLAY_STORAGE_KEY)) || {};
return settings;
} catch (e) {
return {};
}
};

const saveDisplaySettings = (settings) => {
try {
localStorage.setItem(DISPLAY_STORAGE_KEY, JSON.stringify(settings));
} catch (e) {
console.error("Error saving display settings:", e);
}
};

const applyDisplaySettings = (settings) => {
const fontSize = settings.fontSize || '16px';
const fontColor = settings.fontColor || '#f8f9fa';
const bgImage = settings.bgImage || '';
document.body.style.fontSize = fontSize;
document.body.style.color = fontColor;
if (bgImage) {
document.body.style.backgroundImage = `url(${bgImage})`;
} else {
document.body.style.backgroundImage = '';
}
};

const resetDisplaySettings = () => {
localStorage.removeItem(DISPLAY_STORAGE_KEY);
applyDisplaySettings({});
document.getElementById('font-size').value = '16px';
document.getElementById('font-color').value = '#f8f9fa';
document.getElementById('bg-upload').value = '';
showMessageBox(document.getElementById('display-message'), 'Display settings reset!', 'success');
};

// --- GENERAL UTILITIES ---
const applyMode = (mode) => {
if (mode === 'light') {
appBody.classList.add('light-mode');
} else {
appBody.classList.remove('light-mode');
}
updateActiveButton(mode);
};

const updateActiveButton = (mode) => {
darkModeButton.classList.remove('active');
lightModeButton.classList.remove('active');

if (mode === 'dark') {
darkModeButton.classList.add('active');
} else {
lightModeButton.classList.add('active');
}
};

const saveModePreference = (mode) => {
try {
localStorage.setItem(THEME_STORAGE_KEY, mode);
applyMode(mode);
showMessageBox(messageBox, `${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode activated and saved!`, 'success');
} catch (error) {
console.error("Error saving mode preference to localStorage:", error);
showMessageBox(messageBox, "Failed to save mode locally.", 'error');
}
};

const loadModePreference = () => {
try {
const savedMode = localStorage.getItem(THEME_STORAGE_KEY);
applyMode(savedMode || DEFAULT_MODE);
} catch (error) {
console.error("Error loading mode preference from localStorage:", error);
applyMode(DEFAULT_MODE);
}
};

const showMessageBox = (box, message, type) => {
box.textContent = message;
box.classList.remove('hidden');
box.style.backgroundColor = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
box.style.color = 'var(--primary-bg)';

setTimeout(() => box.classList.add('hidden'), 3000);
};

// --- PERIOD NAME UTILITIES ---

const getUniquePeriodKeys = () => {
const keys = new Set();
for (const day in defaultSchedules) {
defaultSchedules[day].forEach(block => keys.add(block.period));
}
return Array.from(keys).filter(key => !DEFAULT_LUNCH_MAP.hasOwnProperty(key));
};

const loadPeriodNames = () => {
try {
const savedNames = localStorage.getItem(NAMES_STORAGE_KEY);
if (savedNames) {
const customNames = JSON.parse(savedNames);
for (const day in schedules) {
schedules[day] = defaultSchedules[day].map(block => {
const originalKey = block.period;
const customName = customNames[originalKey];
if (customName) {
return { ...block, period: customName };
}
return block;
});
}
}
} catch (error) {
console.error("Error loading period names from localStorage:", error);
}
};

const populatePeriodForm = () => {
const uniqueKeys = getUniquePeriodKeys();
let savedNames = {};
try {
const savedNamesStr = localStorage.getItem(NAMES_STORAGE_KEY);
if (savedNamesStr) {
savedNames = JSON.parse(savedNamesStr);
}
} catch (e) { /* ignore parse errors */ }

let formContent = '';
uniqueKeys.sort().forEach(key => {
const currentName = savedNames[key] || key;
formContent += `
<label for="name-${key.replace(/\s/g, '_')}">${key}</label>
<input type="text" id="name-${key.replace(/\s/g, '_')}" name="${key}" value="${currentName}" placeholder="${key}">
`;
});

let existingButton = periodNamesForm.querySelector('.save-settings-button');
let buttonHTML = existingButton ? existingButton.outerHTML : '<button type="submit" class="save-settings-button">Save Period Names</button>';

periodNamesForm.innerHTML = formContent + buttonHTML;

periodNamesForm.removeEventListener('submit', handlePeriodFormSubmit);
periodNamesForm.addEventListener('submit', handlePeriodFormSubmit);
};

const handlePeriodFormSubmit = (e) => {
e.preventDefault();
const formData = new FormData(periodNamesForm);
const customNames = {};
const defaultKeys = getUniquePeriodKeys();

for (const [originalKey, customName] of formData.entries()) {
const trimmedName = customName.trim();
if (defaultKeys.includes(originalKey) && trimmedName.length > 0) {
if (trimmedName !== originalKey) {
customNames[originalKey] = trimmedName;
}
}
}

try {
localStorage.setItem(NAMES_STORAGE_KEY, JSON.stringify(customNames));
schedules = JSON.parse(JSON.stringify(defaultSchedules));
loadPeriodNames();
updatePeriodTimer();
showMessageBox(periodMessageBox, 'Period names saved successfully! Restarting timer...', 'success');
} catch (error) {
console.error("Error saving period names to localStorage:", error);
showMessageBox(periodMessageBox, 'Failed to save period names.', 'error');
}
};

// --- LUNCH NAME UTILITIES ---

const loadLunchNames = () => {
let customLunchMap = {};
try {
const savedNamesStr = localStorage.getItem(LUNCH_STORAGE_KEY);
if (savedNamesStr) {
customLunchMap = JSON.parse(savedNamesStr);
}
} catch (e) { /* ignore parse errors */ }

for (const key in DEFAULT_LUNCH_MAP) {
const input = document.getElementById(`lunch-${key.replace(/\s/g, '_')}`);
if (input) {
input.value = customLunchMap[key] || DEFAULT_LUNCH_MAP[key];
}
}
return customLunchMap;
};

const handleLunchFormSubmit = (e) => {
e.preventDefault();
const formData = new FormData(lunchNamesForm);
const customLunchMap = {};

for (const [originalKey, customName] of formData.entries()) {
const trimmedName = customName.trim();
if (trimmedName.length > 0 && DEFAULT_LUNCH_MAP.hasOwnProperty(originalKey)) {
if (trimmedName !== DEFAULT_LUNCH_MAP[originalKey]) {
customLunchMap[originalKey] = trimmedName;
}
}
}

try {
localStorage.setItem(LUNCH_STORAGE_KEY, JSON.stringify(customLunchMap));
updateLunchDisplay();
showMessageBox(lunchMessageBox, 'Lunch periods saved successfully!', 'success');
} catch (error) {
console.error("Error saving lunch names to localStorage:", error);
showMessageBox(lunchMessageBox, 'Failed to save lunch periods.', 'error');
}
};

const updateLunchDisplay = () => {
const now = new Date();
const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
const schedule = schedules[dayName] || [];
const customLunchMap = loadLunchNames();

let currentLunch = "No Scheduled Lunch Today";
let foundLunch = false;

for (let block of defaultSchedules[dayName] || []) {
const originalPeriodKey = block.period;

if (DEFAULT_LUNCH_MAP.hasOwnProperty(originalPeriodKey)) {
const lunchName = customLunchMap[originalPeriodKey] || DEFAULT_LUNCH_MAP[originalPeriodKey];
const workingBlock = schedule.find(b => b.start === block.start && b.end === block.end);

if (workingBlock) {
currentLunch = `${lunchName} (${workingBlock.start} - ${workingBlock.end})`;
foundLunch = true;
break;
}
}
}

currentLunchDisplay.innerText = foundLunch ? currentLunch : "No Scheduled Lunch Today";
}

// --- REMINDER UTILITIES (MODIFIED FOR INTERVAL CHECK) ---

const loadReminders = () => {
try {
const remindersStr = localStorage.getItem(REMINDER_STORAGE_KEY);
// We no longer filter out past reminders here, the interval checker will handle cleanup
return remindersStr ? JSON.parse(remindersStr) : [];
} catch (e) {
console.error("Error loading reminders:", e);
return [];
}
};

const saveReminders = (reminders) => {
try {
localStorage.setItem(REMINDER_STORAGE_KEY, JSON.stringify(reminders));
} catch (e) {
console.error("Error saving reminders:", e);
}
};

const deleteReminder = (id) => {
let reminders = loadReminders();
reminders = reminders.filter(r => r.id !== id);
saveReminders(reminders);
renderReminders();
showMessageBox(reminderMessageBox, 'Reminder deleted.', 'success');
};

const renderReminders = () => {
const reminders = loadReminders().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
activeRemindersList.innerHTML = '';

if (reminders.length === 0) {
activeRemindersList.innerHTML = `<li style="font-size: 14px; color: var(--text-color); opacity: 0.7; border-bottom: none;">No active reminders set.</li>`;
return;
}

reminders.forEach(r => {
// Since we now store the local time string (YYYY-MM-DDTHH:MM:SS), this will correctly parse it as local time.
const reminderTime = new Date(r.timestamp);
const item = document.createElement('li');
const dateStr = reminderTime.toLocaleDateString();
const timeStr = reminderTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

item.innerHTML = `
<span><strong>${r.title}</strong><br><small style="opacity: 0.8; color: var(--accent-yellow);">${dateStr} @ ${timeStr}</small></span>
<button class="delete-reminder-button" data-id="${r.id}" style="background: var(--accent-red); color: var(--primary-bg); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;">&times; Delete</button>
`;
activeRemindersList.appendChild(item);
});

document.querySelectorAll('.delete-reminder-button').forEach(button => {
button.addEventListener('click', (e) => {
const id = e.target.getAttribute('data-id');
deleteReminder(id);
});
});
};

const handleReminderSubmit = (e) => {
e.preventDefault();
const title = document.getElementById('reminder-title').value.trim();
const date = document.getElementById('reminder-date').value;
const time = document.getElementById('reminder-time').value;

if (!title || !date || !time) {
showMessageBox(reminderMessageBox, 'Please fill out all fields.', 'error');
return;
}

// This creates the standardized local time string (e.g., "2025-10-02T09:45:00")
const datetimeString = `${date}T${time}:00`;

// We create a Date object *only* for validation against the current time.
const reminderTime = new Date(datetimeString);
const now = new Date();

if (reminderTime.getTime() <= now.getTime()) {
showMessageBox(reminderMessageBox, 'Reminder time must be in the future.', 'error');
return;
}

const newReminder = {
id: Date.now().toString(),
title: title,
// CRITICAL FIX: We save the local time string directly, not the UTC-converted ISO string.
timestamp: datetimeString,
};

let reminders = loadReminders();
reminders.push(newReminder);
saveReminders(reminders);

e.target.reset();
renderReminders();
showMessageBox(reminderMessageBox, 'Reminder created and scheduled!', 'success');
};

// Function to show custom slide-in notification
const showInAppNotification = (title, body) => {
console.log(`[Notification Fired] Title: ${title}, Body: ${body}`); // Debugging log

const notificationTitle = inAppNotification.querySelector('h4');
const notificationMessage = document.getElementById('notification-message');

// Ensure we don't try to show it if it's currently showing
inAppNotification.classList.remove('show');

// Slight delay to reset the animation state before showing
setTimeout(() => {
notificationTitle.innerHTML = `<span>🔔</span> ${title}`;
notificationMessage.textContent = body;

// Show the notification
inAppNotification.classList.add('show');

// Auto-hide after 5 seconds
setTimeout(() => {
inAppNotification.classList.remove('show');
}, 5000);
}, 50); // Small delay to force the CSS transition to re-fire
}


// Function to check reminders in the 1-second interval
const checkIntervalReminders = () => {
let reminders = loadReminders();
// Get current time in milliseconds (based on the user's clock/timezone)
const now = new Date().getTime();
let remindersToKeep = [];
let firedCount = 0;

reminders.forEach(r => {
// Parse the stored local time string into a Date object (which respects the user's timezone)
const reminderTime = new Date(r.timestamp).getTime();

// Check if the reminder time is in the past (or within the next second)
if (reminderTime <= now + 1000) {
console.log(`[Interval Checker] Reminder FIRED: "${r.title}"`);
showInAppNotification("Reminder", r.title);
firedCount++;
} else {
// Keep active future reminders
remindersToKeep.push(r);
}
});

// If any reminder fired, save the reduced list and re-render
if (reminders.length !== remindersToKeep.length) {
saveReminders(remindersToKeep);
renderReminders();
}
};


// --- TIMER AND DISPLAY UTILITIES ---

const formatTimeLeft = (totalSeconds) => {
if (totalSeconds < 0) return "0s";
const hours = Math.floor(totalSeconds / 3600);
const minutes = Math.floor((totalSeconds % 3600) / 60);
const seconds = totalSeconds % 60;
let parts = [];
if (hours > 0) parts.push(`${hours}h`);
if (minutes > 0) parts.push(`${minutes}m`);
if (totalSeconds >= 0) {
parts.push(`${seconds}s`);
}
return parts.join(" ");
};
const timeToMinutes = (timeStr) => {
const parts = timeStr.split(":").map(Number);
return parts[0] * 60 + parts[1];
};

const calculateWeekendTarget = (now) => {
let nextDay = new Date(now);
let dayOfWeek = nextDay.getDay();
let daysUntilMonday = (8 - dayOfWeek) % 7;
if (daysUntilMonday === 0) daysUntilMonday = 7;
nextDay.setDate(nextDay.getDate() + daysUntilMonday);
nextDay.setHours(7, 20, 0, 0);
return nextDay;
};

const updateInfoSection = () => {
const now = new Date();
const timeStr = now.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', second: '2-digit' });
const dateStr = (now.getMonth() + 1).toString().padStart(2, '0') + '/' + now.getDate().toString().padStart(2, '0') + '/' + now.getFullYear();
const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
const schedule = schedules[dayName] || [];
const currentMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;

let parity = "Unknown Schedule";

if (schedule.length > 0) {
const firstStartMinutes = timeToMinutes(schedule[0].start);
const lastEndMinutes = timeToMinutes(schedule[schedule.length - 1].end);
let inSession = false;
for (let block of schedule) {
const startMinutes = timeToMinutes(block.start);
const endMinutes = timeToMinutes(block.end);

if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
parity = dayName + " Schedule";
inSession = true;
break;
}
}
if (!inSession) {
if (currentMinutes < firstStartMinutes) {
parity = "Before School";
} else if (currentMinutes >= lastEndMinutes) {
parity = "After School";
} else {
parity = "Passing Time";
}
}
} else {
parity = "Weekend / No School";
}
const infoEl = document.getElementById("info-section");
if (infoEl) {
infoEl.innerText = `Time: ${timeStr} | Date: ${dateStr} | ${parity}`;
}
};

const updatePeriodTimer = () => {
const now = new Date();
const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
const schedule = schedules[dayName] || [];
const currentMinutes = now.getHours() * 60 + now.getMinutes();
let currentPeriod = "No Class";
let totalSecondsLeft = -1;

for (let block of schedule) {
const startMinutes = timeToMinutes(block.start);
const endMinutes = timeToMinutes(block.end);
if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
currentPeriod = block.period;
totalSecondsLeft = (endMinutes * 60) - (currentMinutes * 60) - now.getSeconds();
break;
}
}

if (totalSecondsLeft === -1) {
let nextTarget = null;

if (schedule.length > 0) {
const firstStartMinutes = timeToMinutes(schedule[0].start);
const lastEndMinutes = timeToMinutes(schedule[schedule.length - 1].end);
if (currentMinutes < firstStartMinutes) {
nextTarget = new Date(now);
const firstPeriodStart = schedule[0].start.split(":").map(Number);
nextTarget.setHours(firstPeriodStart[0], firstPeriodStart[1], 0, 0);
currentPeriod = "Before School";
} else if (currentMinutes >= lastEndMinutes) {
currentPeriod = "After School";
let nextDay = new Date(now);
nextDay.setDate(now.getDate() + 1);
while (nextDay.getDay() === 0 || nextDay.getDay() === 6) { nextDay.setDate(nextDay.getDate() + 1); }
nextTarget = nextDay;
nextTarget.setHours(7, 20, 0, 0);
} else {
for (let i = 0; i < schedule.length; i++) {
const block = schedule[i];
const startMinutes = timeToMinutes(block.start);
if (currentMinutes < startMinutes) {
nextTarget = new Date(now);
const blockStart = block.start.split(":").map(Number);
nextTarget.setHours(blockStart[0], blockStart[1], 0, 0);
currentPeriod = `Next: ${block.period}`;
break;
}
}
}
} else {
currentPeriod = "Weekend/Break";
nextTarget = calculateWeekendTarget(now);
}

if (nextTarget) {
totalSecondsLeft = Math.floor((nextTarget.getTime() - now.getTime()) / 1000);
if (totalSecondsLeft < 0) totalSecondsLeft = 0;
}
}

let timeLeft = formatTimeLeft(totalSecondsLeft);
const timerContainer = document.getElementById("period-timer");
let timerTextSpan = document.getElementById("timer-text");

if (!timerTextSpan) {
timerContainer.innerHTML = `${currentPeriod} – <span id="timer-text" class="timer-text">${timeLeft} left</span>`;
timerTextSpan = document.getElementById("timer-text");
} else {
timerContainer.firstChild.nodeValue = `${currentPeriod} – `;
timerTextSpan.innerText = `${timeLeft} left`;
}

timerTextSpan.classList.remove('timer-active');
timerTextSpan.style.color = 'var(--text-color)';

if (totalSecondsLeft > 0 && currentPeriod !== "After School" && currentPeriod !== "Weekend/Break") {
timerTextSpan.classList.add('timer-active');
const fifteenMinutesInSeconds = 15 * 60;

if (totalSecondsLeft > fifteenMinutesInSeconds) {
timerTextSpan.style.color = 'var(--accent-green)';
} else {
timerTextSpan.style.color = 'var(--accent-red)';
}
}
updateInfoSection();
// IMPORTANT: Call the new check function every second
checkIntervalReminders();
};

const showReminderModal = () => {
renderReminders();
reminderModal.classList.add('show');
document.body.style.overflow = 'hidden';
};
const hideReminderModal = () => {
reminderModal.classList.remove('show');
document.body.style.overflow = '';
};


// --- NEW: Profile Uploader Functions ---

/**
 * Initializes the profile uploader state when the account modal is opened.
 */
function initProfileUploader() {
    if (!currentUser) return; // Should be logged in to see modal

    // Select elements *inside* the modal
    fileInput = document.getElementById('fileInput');
    cropperWrapper = document.getElementById('cropper-wrapper');
    cropperImg = document.getElementById('cropper-image');
    uploadBtn = document.getElementById('uploadBtn');
    currentAvatar = document.getElementById('current-avatar');
    noAvatarText = document.getElementById('no-avatar-text');
    status = document.getElementById('status');

    // Detach old listeners to prevent duplicates
    fileInput.removeEventListener('change', handleFileChange);
    uploadBtn.removeEventListener('click', handleUpload);
    
    // Attach new listeners
    fileInput.addEventListener('change', handleFileChange);
    uploadBtn.addEventListener('click', handleUpload);

    const avatarUrl = currentUser.user_metadata?.avatar_url;

    if (avatarUrl) {
        currentAvatar.src = avatarUrl;
        currentAvatar.style.display = '';
        noAvatarText.style.display = 'none';

        // Parse the storage path from the public URL
        try {
            const url = new URL(avatarUrl);
            const parts = url.pathname.split('/');
            const idx = parts.indexOf('profile-pictures'); // Bucket name
            if (idx !== -1) {
                oldAvatarPath = parts.slice(idx + 1).join('/'); 
            } else {
                oldAvatarPath = null;
            }
        } catch (e) {
            oldAvatarPath = null;
        }
    } else {
        currentAvatar.style.display = 'none';
        noAvatarText.style.display = '';
        oldAvatarPath = null;
    }

    // Reset cropper state
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    cropperWrapper.style.display = 'none';
    fileInput.value = "";
    uploadBtn.disabled = true;
    if (status) status.textContent = "";
}

/**
 * Handles the file input change event to load the cropper.
 */
function handleFileChange(e) {
    const file = e.target.files[0];
    if (!file) {
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
    }
    if (!file.type.startsWith("image/")) {
        status.textContent = "Only image files are allowed.";
        fileInput.value = "";
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
    }
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
        status.textContent = "File too large (max 5 MB).";
        fileInput.value = "";
        cropperWrapper.style.display = 'none';
        uploadBtn.disabled = true;
        return;
    }
    status.textContent = "";

    const url = URL.createObjectURL(file);
    cropperImg.src = url;
    cropperWrapper.style.display = '';
    uploadBtn.disabled = false;

    cropperImg.onload = () => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropperImg, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            background: false,
            guides: false,
            autoCropArea: 1,
            cropBoxResizable: false,
            cropBoxMovable: false,
            movable: true,
            zoomable: true,
            minContainerWidth: 260,
            minContainerHeight: 260,
        });
    };
}

/**
 * Handles the upload button click event.
 */
async function handleUpload() {
    if (!cropper || !currentUser) return;
    status.textContent = "Processing image...";
    uploadBtn.disabled = true;

    cropper.getCroppedCanvas({ width: 300, height: 300, imageSmoothingQuality: 'high' })
        .toBlob(async (blob) => {
            if (!blob) {
                status.textContent = "Failed to crop image.";
                uploadBtn.disabled = false;
                return;
            }

            // 1. Delete old avatar
            if (oldAvatarPath) {
                try {
                    const { error: removeError } = await supabaseClient.storage
                        .from("profile-pictures")
                        .remove([oldAvatarPath]);
                    if (removeError) {
                        console.warn("Failed to delete old avatar:", removeError.message);
                    }
                } catch (err) {
                    console.warn("Error while deleting old avatar:", err);
                }
            }

            // 2. Upload new avatar
            const fileName = `profile-${currentUser.id}-${Date.now()}.png`;
            status.textContent = "Uploading...";
            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                .from("profile-pictures")
                .upload(fileName, blob, { upsert: true });

            if (uploadError) {
                status.textContent = "Upload failed: " + uploadError.message;
                uploadBtn.disabled = false;
                return;
            }

            // 3. Get public URL
            const { data: publicUrlData } = supabaseClient.storage
                .from("profile-pictures")
                .getPublicUrl(fileName);

            const publicUrl = publicUrlData?.publicUrl;
            if (!publicUrl) {
                status.textContent = "Could not retrieve image URL.";
                uploadBtn.disabled = false;
                return;
            }

            // 4. Save to auth metadata (this updates what header-profile-picture reads)
            const { data: authUpdateData, error: authUpdateError } = await supabaseClient.auth.updateUser({
                data: { avatar_url: publicUrl }
            });
            
            if(authUpdateError) {
                    status.textContent = "Upload succeeded, but failed to update auth user: " + authUpdateError.message;
                    uploadBtn.disabled = false;
                    return;
            }
            
            // 5. Save to "profiles" table (to keep in sync)
            const { error: profileUpdateError } = await supabaseClient
                .from("profiles") // Using "profiles" table from ConnectIndex.html
                .update({ avatar_url: publicUrl }) // Assuming it has an 'avatar_url' column
                .eq("id", currentUser.id);

            if (profileUpdateError) {
                status.textContent = "Auth updated, but profile table save failed.";
                console.warn("Profile table update error:", profileUpdateError.message);
                // Not fatal, as the auth user is updated
            } else {
                status.textContent = "Profile picture updated!";
            }

            // 6. Update UI
            currentAvatar.src = publicUrl;
            currentAvatar.style.display = '';
            noAvatarText.style.display = 'none';
            cropperWrapper.style.display = 'none';
            fileInput.value = "";
            uploadBtn.disabled = true;

            oldAvatarPath = fileName; // Cache new path
            
            // Manually update the global currentUser object and header image
            if (authUpdateData.user) {
                currentUser = authUpdateData.user;
            }
            headerProfilePicture.src = publicUrl;

        }, "image/png", 0.95);
}


// --- MODIFIED: Modal Show/Hide Functions ---

const showAccountModal = () => {
    // Check if user is logged in
    if (!currentUser) {
        alert("Please log in to manage your account.");
        return;
    }
    accountModal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // NEW: Initialize the profile picture uploader logic
    initProfileUploader(); 
};

const hideAccountModal = () => {
    accountModal.classList.remove('show');
    document.body.style.overflow = '';
    
    // NEW: Destroy cropper instance to free resources
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
};

const showDisplayModal = () => {
displayModal.classList.add('show');
document.body.style.overflow = 'hidden';
};
const hideDisplayModal = () => {
displayModal.classList.remove('show');
document.body.style.overflow = '';
};


// --- DOM READY AND LISTENERS ---
document.addEventListener('DOMContentLoaded', () => {

// --- NEW: Load user session ---
loadUserSession();

// 0. Load Custom Names and Populate Forms
loadPeriodNames();
populatePeriodForm();
loadLunchNames();
lunchNamesForm.addEventListener('submit', handleLunchFormSubmit);

// 1. Load Theme Preference
loadModePreference();

// 1.5. Load and apply display settings
const displaySettings = loadDisplaySettings();
applyDisplaySettings(displaySettings);
document.getElementById('font-size').value = displaySettings.fontSize || '16px';
document.getElementById('font-color').value = displaySettings.fontColor || '#f8f9fa';

// 2. Attach theme-related event listeners
darkModeButton.addEventListener('click', () => saveModePreference('dark'));
lightModeButton.addEventListener('click', () => saveModePreference('light'));

// 3. Start the timer loop and lunch display update
updatePeriodTimer();
updateLunchDisplay();
// The main interval now also runs the reminder check
setInterval(() => {
updatePeriodTimer();
updateLunchDisplay();
}, 1000);

// 4. Tab Switching
document.querySelectorAll(".left-box button").forEach(button => {
button.addEventListener("click", () => {
const target = button.getAttribute("data-tab");
if (target === "polls") {
window.location.href = "https://docs.google.com/forms/d/e/1FAIpQLSe5TOOGpEZc-IXcdIIieZpPeYvS4lcNZBjwruKpQlkJFpj8qg/viewform?usp=header";
return;
}
document.querySelectorAll(".left-box button").forEach(btn => btn.classList.remove("active"));
button.classList.add("active");
tabs.forEach(tab => {
tab.classList.remove("active");
if (tab.id === target) {
tab.classList.add("active");
if (tab.id === 'weather') {
fetchWeather();
}
if (tab.id === 'news') {
renderNews();
}
}
});
});
});
if (homeButton) homeButton.classList.add("active");

// 4.5. Close Tab Button Functionality
document.querySelectorAll('.close-tab-button').forEach(button => {
    button.addEventListener('click', () => {
        // Switch to home tab
        document.querySelectorAll(".left-box button").forEach(btn => btn.classList.remove("active"));
        const homeBtn = document.querySelector(".left-box button[data-tab='home']");
        homeBtn.classList.add("active");
        tabs.forEach(tab => {
            tab.classList.remove("active");
            if (tab.id === 'home') {
                tab.classList.add("active");
            }
        });
    });
});

// 5. Header Scroll Hide/Show
let lastScrollY = window.scrollY;
const header = document.querySelector('.header');
const headerHeight = header.offsetHeight;
window.addEventListener('scroll', () => {
const currentScrollY = window.scrollY;
if (currentScrollY > lastScrollY && currentScrollY > headerHeight) {
header.style.top = `-${headerHeight}px`;
} else {
header.style.top = '0';
}
lastScrollY = currentScrollY;
});

// 6. Image Preview (Placeholder for lunch items)
const fetchImage = async (food) => {
return `https://placehold.co/300x300/4cc9f0/1a1b2f?text=${encodeURIComponent(food)}`;
};
const preview = document.getElementById("preview");
document.querySelectorAll(".info p").forEach(item => {
item.addEventListener("mouseenter", async (e) => {
const food = e.target.getAttribute("data-food");
const imgUrl = await fetchImage(food);
preview.src = imgUrl;
preview.style.display = "block";
});
item.addEventListener("mousemove", (e) => {
preview.style.left = (e.pageX + 20) + "px";
preview.style.top = (e.pageY + 20) + "px";
});
item.addEventListener("mouseleave", () => {
preview.style.display = "none";
});
});

// 7. Modal Logic

// 8. Reminder Maker Logic
// Click handler for the card itself (opens modal)
if (notificationsCard) notificationsCard.addEventListener('click', showReminderModal);
// Click handler for the TEST button (fires animation)
if (testNotificationButton) {
testNotificationButton.addEventListener('click', (e) => {
e.stopPropagation(); // Stop the event from propagating to the card and opening the modal
showInAppNotification("Test Notification", "This should slide in smoothly!");
});
}
if (closeReminderModalButton) closeReminderModalButton.addEventListener('click', hideReminderModal);
if (reminderModal) reminderModal.addEventListener('click', (e) => {
if (e.target === reminderModal) { hideReminderModal(); }
});
if (reminderForm) reminderForm.addEventListener('submit', handleReminderSubmit);

// 9. Account Modal Logic (MODIFIED)
if (accountCard) accountCard.addEventListener('click', showAccountModal); // Uses new function
if (closeAccountModalButton) closeAccountModalButton.addEventListener('click', hideAccountModal); // Uses new function
if (accountModal) accountModal.addEventListener('click', (e) => {
if (e.target === accountModal) { hideAccountModal(); } // Uses new function
});
if (accountForm) accountForm.addEventListener('submit', (e) => {
e.preventDefault();
// This form now only saves username/password
// The profile picture is saved by its own button
// Placeholder: show confirmation message
confirmationMessage.style.display = 'block';
confirmationMessage.textContent = 'Username/Password save logic goes here!';
confirmationMessage.style.color = 'var(--accent-green)';
setTimeout(() => {
confirmationMessage.style.display = 'none';
}, 3000);
});

// 10. Display Modal Logic
if (displayCard) displayCard.addEventListener('click', showDisplayModal);
if (closeDisplayModalButton) closeDisplayModalButton.addEventListener('click', hideDisplayModal);
if (displayModal) displayModal.addEventListener('click', (e) => {
if (e.target === displayModal) { hideDisplayModal(); }
});
if (resetDisplayButton) resetDisplayButton.addEventListener('click', resetDisplaySettings);

// 11. Clubs Modal Logic
if (clubsCard) clubsCard.addEventListener('click', showClubsModal);
if (closeClubsModalButton) closeClubsModalButton.addEventListener('click', hideClubsModal);
if (clubsModal) clubsModal.addEventListener('click', (e) => {
if (e.target === clubsModal) { hideClubsModal(); }
});

// 12. Trivia Modal Logic
if (triviaCard) triviaCard.addEventListener('click', showTriviaModal);
if (closeTriviaModalButton) closeTriviaModalButton.addEventListener('click', hideTriviaModal);
if (triviaModal) triviaModal.addEventListener('click', (e) => {
if (e.target === triviaModal) { hideTriviaModal(); }
});

// 13. Puzzle Modal Logic
if (puzzleCard) puzzleCard.addEventListener('click', showPuzzleModal);
if (closePuzzleModalButton) closePuzzleModalButton.addEventListener('click', hidePuzzleModal);
if (puzzleModal) puzzleModal.addEventListener('click', (e) => {
if (e.target === puzzleModal) { hidePuzzleModal(); }
});
// 14. Calendar Modal Logic
if (eventsCard) eventsCard.addEventListener('click', showCalendarModal);
if (closeCalendarModalButton) closeCalendarModalButton.addEventListener('click', hideCalendarModal);
if (calendarModal) calendarModal.addEventListener('click', (e) => {
if (e.target === calendarModal) { hideCalendarModal(); }
});

// 15. Study Timer Modal Logic
if (studyTimerCard) studyTimerCard.addEventListener('click', showStudyTimerModal);
if (closeStudyTimerModalButton) closeStudyTimerModalButton.addEventListener('click', hideStudyTimerModal);
if (studyTimerModal) studyTimerModal.addEventListener('click', (e) => {
  if (e.target === studyTimerModal) { hideStudyTimerModal(); }
});
startStudyTimerButton.addEventListener('click', startStudyTimer);
pauseStudyTimerButton.addEventListener('click', pauseStudyTimer);
resetStudyTimerButton.addEventListener('click', resetStudyTimer);

// Initially disable pause and reset
pauseStudyTimerButton.disabled = true;
resetStudyTimerButton.disabled = true;

// Font size change
document.getElementById('font-size').addEventListener('change', (e) => {
const settings = loadDisplaySettings();
settings.fontSize = e.target.value;
saveDisplaySettings(settings);
applyDisplaySettings(settings);
showMessageBox(document.getElementById('display-message'), 'Font size updated!', 'success');
});

// Font color change
document.getElementById('font-color').addEventListener('change', (e) => {
const settings = loadDisplaySettings();
settings.fontColor = e.target.value;
saveDisplaySettings(settings);
applyDisplaySettings(settings);
showMessageBox(document.getElementById('display-message'), 'Font color updated!', 'success');
});

// Background image upload
document.getElementById('bg-upload').addEventListener('change', (e) => {
const file = e.target.files[0];
if (file) {
const reader = new FileReader();
reader.onload = (event) => {
const settings = loadDisplaySettings();
settings.bgImage = event.target.result;
saveDisplaySettings(settings);
applyDisplaySettings(settings);
showMessageBox(document.getElementById('display-message'), 'Background image updated!', 'success');
};
reader.readAsDataURL(file);
}
});

// --- "My Posts" Modal Listeners (Supabase) ---
if (headerProfilePicture) headerProfilePicture.addEventListener('click', showMyPostsModal);
if (closeMyPostsModalButton) closeMyPostsModalButton.addEventListener('click', hideMyPostsModal);
if (myPostsModal) myPostsModal.addEventListener('click', (e) => {
    if (e.target === myPostsModal) { hideMyPostsModal(); }
});

// --- "My Posts" Customization Listeners (Supabase) ---
if (myPostsResetButton) myPostsResetButton.addEventListener('click', resetMyPostsDisplaySettings);

if (myPostsBgColorInput) myPostsBgColorInput.addEventListener('change', (e) => {
    saveMyPostsDisplaySettings({ bg_color: e.target.value });
});

if (myPostsFontColorInput) myPostsFontColorInput.addEventListener('change', (e) => {
    saveMyPostsDisplaySettings({ font_color: e.target.value });
});

if (myPostsBgImageInput) myPostsBgImageInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file || !currentUser) return;

    const filePath = `${currentUser.id}/${Date.now()}_${file.name}`;
    showMessageBox(myPostsDisplayMessage, 'Uploading image...', 'success');

    const { error: uploadError } = await supabaseClient.storage
        .from('post_backgrounds')
        .upload(filePath, file, {
            cacheControl: '3600',
            upsert: true 
        });

    if (uploadError) {
        console.error('Error uploading image:', uploadError);
        showMessageBox(myPostsDisplayMessage, `Upload Error: ${uploadError.message}`, 'error');
        return;
    }

    const { data: urlData } = supabaseClient.storage
        .from('post_backgrounds')
        .getPublicUrl(filePath);

    if (urlData) {
        await saveMyPostsDisplaySettings({ bg_image_url: urlData.publicUrl });
    }
});


});
</script>
</body>
</html>

