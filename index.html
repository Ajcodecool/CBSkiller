<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Crooms Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <style>
        /* ------------------------------------------------------------------- */
        /* ROOT THEME VARIABLES (Default: DARK MODE)                           */
        /* ------------------------------------------------------------------- */
        :root {
            /* Dynamic Theme Variables */
            --primary-bg: #1a1b2f; /* Main App Background (Dark Blue/Gray) */
            --content-bg: #2b2d42; /* Card/Section Background */
            --text-color: #f8f9fa; /* Light Text Color */
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --border-color: rgba(248, 249, 250, 0.1);
            --card-bg-subtle: rgba(248, 249, 250, 0.05);
            /* Fixed Accent Colors */
            --accent-blue: #4cc9f0;
            --accent-green: #80ed99;
            --accent-red: #ef476f;
            --accent-yellow: #ffd166;
            --radius: 15px;
        }

        /* ------------------------------------------------------------------- */
        /* LIGHT MODE OVERRIDES                                                */
        /* ------------------------------------------------------------------- */
        .light-mode {
            --primary-bg: #f0f4f8; /* Very Light Gray/Blue */
            --content-bg: #ffffff; /* White Cards */
            --text-color: #1a1b2f; /* Dark Text */
            --shadow: 0 4px 12px rgba(0,0,0,0.15);
            --border-color: rgba(26, 27, 47, 0.1);
            --card-bg-subtle: #f8f9fa; /* Off-white for subtle card areas */
        }
        /* ------------------------------------------------------------------- */
        /* BASE STYLES                                                         */
        /* ------------------------------------------------------------------- */
        body {
            margin: 0;
            font-family: "Segoe UI", Arial, sans-serif;
            background: var(--primary-bg);
            color: var(--text-color);
            padding-top: 65px;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        /* SQUIGGLY BACKGROUND LINES (Adapt to current text color for visibility) */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            /* SVG stroke color references the dynamic --text-color variable */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M0 50 Q50 0 100 50 T200 50 V200 H0 Z" fill="none" stroke="var(--text-color, rgba(255,255,255,0.05))" stroke-width="2"/></svg>');
            background-size: 200px 200px;
            z-index: -1;
            /* Opacity is adjusted dynamically based on theme contrast */
            opacity: var(--text-color-opacity, 0.05);
        }
        .light-mode::before {
            opacity: 0.1; /* Make squiggles slightly more visible on light background */
        }
        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            /* Use a semi-transparent primary background for the header */
            background: color-mix(in srgb, var(--primary-bg) 90%, transparent);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            transition: top 0.3s, background 0.3s;
        }
        .header .title-text {
            font-weight: bold;
            font-size: clamp(16px, 4vw, 20px);
            color: var(--accent-blue);
            flex-shrink: 0;
        }
        .header .user-id-display {
            font-size: 10px;
            color: var(--text-color);
            opacity: 0.6;
            padding-left: 10px;
            max-width: 40%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* NAVIGATION BUTTONS */
        .left-box {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px auto;
            max-width: 900px;
        }
        .left-box button {
            background: var(--content-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            /* Adding a subtle glowing transition effect */
            transition: 0.3s ease-in-out;
            /* Subtle shadow/border effect */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.1);
        }
        .left-box button:hover {
            /* Using a radial gradient effect for the 'light' feel */
            background: radial-gradient(circle at top left, var(--accent-blue) 10%, var(--content-bg) 100%);
            color: var(--primary-bg);
            transform: translateY(-3px);
            /* More pronounced shadow with a subtle blue glow */
            box-shadow: 0 8px 20px rgba(76, 201, 240, 0.4), 0 0 15px rgba(76, 201, 240, 0.3);
        }
        .left-box button.active {
            /* Active state uses a strong blue gradient */
            background: linear-gradient(45deg, var(--accent-blue), #2a8dff);
            color: var(--primary-bg);
            /* Added stronger shadow for active state */
            box-shadow: 0 4px 10px rgba(76, 201, 240, 0.6);
            transform: none; /* No lift when active */
        }
        /* TIMER STYLES (Pulse/Blink removed, replaced with color logic in JS) */
        .timer-text.timer-active {
            /* No animation */
            display: inline-block;
            font-weight: bolder;
            transition: color 0.3s;
            /* Default active color (will be overridden by JS for green/red) */
            color: var(--accent-red); /* Placeholder color, JS overrides this for green/red based on time left */
        }
        /* TAB CONTENT */
        .tab-content {
            display: none;
            animation: fadeInUp 0.7s ease;
        }
        .tab-content.active {
            display: block;
        }
        /* SECTION CONTAINER (Uses Content BG) */
        section, .right-box {
            background: var(--content-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin: 30px auto;
            max-width: 900px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s;
        }
        /* SQUIGGLES INSIDE CARDS (Less visible) */
        section::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M0 100 Q50 50 100 100 T200 100 V200 H0 Z" fill="none" stroke="var(--text-color, rgba(255,255,255,0.05))" stroke-width="2"/></svg>');
            background-size: 200px 200px;
            opacity: 0.1;
            z-index: 0;
        }
        section h1, section h2, section p, section .disclaimer-point {
            position: relative;
            z-index: 1;
        }
        section h1 { color: var(--accent-blue); }
        section h2 { color: var(--accent-green); }
        /* CARDS INSIDE SECTIONS */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: var(--card-bg-subtle);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* Slightly weaker card shadow */
            transition: 0.3s;
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        .card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: var(--shadow);
        }
        .card .icon {
            font-size: 35px;
            margin-bottom: 10px;
            display: block;
        }
        /* RIGHT BOX */
        .right-box {
            width: 280px;
            margin: 0 auto;
            animation: fadeIn 1s ease;
        }
        .right-box h2 {
            text-align: center;
            color: var(--accent-yellow);
        }
        .right-box .section {
            margin-top: 10px;
            background: var(--card-bg-subtle);
            padding: 10px;
            border-radius: var(--radius);
            text-align: center;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .right-box .info p {
            margin: 8px 0;
            cursor: pointer;
            transition: color 0.2s;
        }
        .right-box .info p:hover {
            color: var(--accent-blue);
        }
        /* FOOTER */
        footer {
            text-align: center;
            padding: 20px;
            background: var(--primary-bg);
            margin-top: 40px;
            color: var(--text-color);
            font-size: 14px;
            transition: background-color 0.3s, color 0.3s;
        }
        footer a {
            color: var(--accent-blue);
            text-decoration: none;
            cursor: pointer;
        }

        /* THEME BUTTON STYLES (Restored Gradients/Lighting) */
        .theme-button {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.3s, background-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #dark-mode-button {
            background-color: var(--content-bg);
            color: var(--text-color);
            border: 2px solid var(--accent-blue);
            background-image: linear-gradient(135deg, var(--content-bg), var(--content-bg) 80%, rgba(76, 201, 240, 0.1));
        }
        #dark-mode-button.active, #dark-mode-button:hover {
            background-image: linear-gradient(135deg, var(--accent-blue), #2a8dff); /* Blue Gradient */
            color: var(--primary-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.6);
        }
        #light-mode-button {
            background-color: var(--content-bg);
            color: var(--text-color);
            border: 2px solid var(--accent-yellow);
            background-image: linear-gradient(135deg, var(--content-bg), var(--content-bg) 80%, rgba(255, 209, 102, 0.1));
        }
        #light-mode-button.active, #light-mode-button:hover {
            background-image: linear-gradient(135deg, var(--accent-yellow), #ffc34d); /* Yellow Gradient */
            color: var(--primary-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 209, 102, 0.6);
        }
        /* ANIMATIONS AND MODALS (Kept for completeness) */
        @keyframes fadeInUp {
            from {opacity: 0; transform: translateY(20px);}
            to {opacity: 1; transform: translateY(0);}
        }
        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content {
            background: var(--content-bg); border-radius: var(--radius);
            padding: 40px 30px; max-width: 600px; width: 90%; max-height: 80vh;
            overflow-y: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            border: 2px solid var(--accent-red); position: relative;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .close-button {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            color: var(--text-color); font-size: 24px; cursor: pointer; line-height: 1;
            padding: 5px; opacity: 0.7; transition: opacity 0.2s, color 0.2s;
        }
        .close-button:hover { opacity: 1; color: var(--accent-red); }

        /* Settings Form Styles */
        .settings-form {
            text-align: left;
            margin-top: 15px;
        }
        .settings-form label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-green); /* Use accent color for label */
        }
        .settings-form input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background: var(--primary-bg);
            color: var(--text-color);
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .settings-form input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .save-settings-button {
            margin-top: 20px;
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, var(--accent-green), #4CAF50);
            color: var(--primary-bg);
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 8px rgba(128, 237, 153, 0.4);
        }
        .save-settings-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(128, 237, 153, 0.6);
        }

        /* Reminder list styles */
        #active-reminders-list, #cloud-reminder-list {
            list-style: none;
            padding: 0;
        }
        #active-reminders-list li, #cloud-reminder-list li {
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
        }
        #active-reminders-list li:last-child, #cloud-reminder-list li:last-child {
            border-bottom: none;
        }

        /* NEW: In-App Notification Styling for slide-in effect */
        #in-app-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: var(--accent-blue);
            color: var(--primary-bg);
            padding: 15px;
            border-radius: var(--radius);
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
            z-index: 1100; /* Above modals */
            transform: translateX(120%); /* Start off-screen to the right */
            /* Springy slide-in animation */
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #in-app-notification.show {
            transform: translateX(0); /* Slide into view */
        }

        #in-app-notification h4 {
            margin: 0 0 5px 0;
            font-weight: bold;
            font-size: 16px;
            color: var(--primary-bg);
            display: flex;
            align-items: center;
        }
        #in-app-notification h4 span {
            margin-right: 8px;
            font-size: 20px;
        }

        #in-app-notification p {
            margin: 0;
            font-size: 14px;
        }
    </style>
</head>
<body id="app-body">
    <div class="header">
        <div class="flex items-center">
            <span class="title-text">CROOMS CONNECT</span>
            <span id="userIdDisplay" class="user-id-display">Checking session...</span>
        </div>
        <div class="flex items-center">
            <span>ALPHA</span>
            <button id="logout-btn" style="margin-left:15px; font-size:12px; background:var(--accent-red); color:var(--primary-bg); border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;">
                Logout
            </button>
        </div>
    </div>

    <div class="left-box">
        <button data-tab="home">Home</button>
        <button data-tab="study">Study Tools</button>
        <button data-tab="community">Community</button>
        <button data-tab="polls">Polls</button>
        <button data-tab="games">Games</button>
        <button data-tab="settings">Settings</button>
    </div>

    <div class="right-box">
        <div class="section" id="info-section" style="color: var(--accent-yellow); font-weight: bold;">Loading current time and day type...</div>
        <div class="section" id="period-timer">Loading Period Timer...</div>
        <div class="section" id="current-lunch-display">Loading Lunch...</div>
        <div class="info">
            <p data-food="Mango">M – Mango</p>
            <p data-food="Mustard">T – Mustard</p>
            <p data-food="Still Water">W – Still Water</p>
            <p data-food="Burgers">T – 41 Burgers</p>
            <p data-food="Chickens">F – 67 Chickens</p>
        </div>
    </div>

    <div class="tab-content active" id="home">
        <section>
            <h1>Welcome to Crooms Connect</h1>
            <p>Your student hub with resources, schedules, and tools.</p>
            <div class="card-grid">
                <div class="card"><span class="icon"> 📰 </span><h3>News</h3><p>Latest announcements from campus.</p></div>
                <div class="card" onclick="window.location.href='events.html'" style="cursor: pointer;">
                    <span class="icon"> 📅 </span>
                    <h3>Events</h3>
                    <p>See what’s happening this week.</p>
                </div>
            </div>
        </section>
    </div>

    <div class="tab-content" id="study">
        <section>
            <h1>Study Tools</h1>
            <p>Helpful tools to keep you learning.</p>
            <div class="card-grid">
                <div class="card"><span class="icon"> 📝 </span><h3>Flashcards</h3><p>Review terms quickly.</p></div>
                <div class="card"><span class="icon"> ❓ </span><h3>Practice Quizzes</h3><p>Test your knowledge.</p></div>
            </div>
        </section>
    </div>

    <div class="tab-content" id="community">
        <section>
            <h1>Community</h1>
            <p>Connect with classmates and teachers.</p>
            <div class="card-grid">
                <div class="card"><span class="icon"> 👥 </span><h3>Clubs</h3><p>Find and join school clubs.</p></div>
                <div class="card"><span class="icon"> 💬 </span><h3>Forums</p><p>Discuss topics with peers.</p></div>
            </div>
        </section>
    </div>

    <div class="tab-content" id="polls">
        <section>
            <h1>Polls</h1>
            <p>Vote on important topics.</p>
            <div class="card-grid">
                <div class="card"><span class="icon"> 🗳️ </span><h3>Current Poll</h3><p>Vote on this week’s topic.</p></div>
                <div class="card"><span class="icon"> 📊 </span><h3>Results</h3><p>See community votes.</p></div>
            </div>
        </section>
    </div>

    <div class="tab-content" id="games">
        <section>
            <h1>Games</h1>
            <p>Fun mini-games to enjoy during breaks.</p>
            <div class="card-grid">
                <div class="card"><span class="icon"> 🎮 </span><h3>Trivia</h3><p>Test your knowledge in quick rounds.</p></div>
                <div class="card"><span class="icon"> 🧩 </span><h3>Puzzle</h3><p>Relax and challenge your mind.</p></div>
            </div>
        </section>
    </div>

    <div class="tab-content" id="settings">
        <section>
            <h1>User Settings & Customization</h1>
            <p>Personalize your experience.</p>
            <div class="card-grid">

                <div class="card" id="supabase-reminders-card">
                    <span class="icon"> ☁️ </span>
                    <h3>Cloud Reminders</h3>
                    <p>Reminders saved to your account, accessible on any device.</p>
                    <form id="cloud-reminder-form" class="settings-form" style="margin-bottom:10px;">
                        <label for="cloud-reminder-title">Title</label>
                        <input type="text" id="cloud-reminder-title" required placeholder="e.g., Study for Math Test">
                        <label for="cloud-reminder-datetime">Date & Time</label>
                        <input type="datetime-local" id="cloud-reminder-datetime" required>
                        <button type="submit" class="save-settings-button" style="background: linear-gradient(45deg, var(--accent-blue), #2a8dff);">Add Cloud Reminder</button>
                        <div id="cloud-reminder-message" class="p-2 mt-2 text-center rounded-lg font-medium" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
                    </form>
                    <ul id="cloud-reminder-list"></ul>
                </div>

                <div class="card theme-selector-card">
                    <span class="icon"> 🌓 </span>
                    <h3>Appearance</h3>
                    <p style="margin-bottom: 20px; font-size: 14px;">Toggle between Dark and Light mode. Saved locally.</p>
                    <div class="flex flex-col space-y-4">
                        <button id="dark-mode-button" class="theme-button">
                            <span class="icon"> 🌙 </span> Dark Mode
                        </button>
                        <button id="light-mode-button" class="theme-button">
                            <span class="icon"> ☀️ </span> Light Mode
                        </button>
                    </div>
                    <div id="messageBox" class="p-3 mt-4 text-center rounded-lg font-medium hidden" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
                </div>

                <div class="card period-names-card">
                    <span class="icon"> 📚 </span>
                    <h3>Period Names</h3>
                    <p style="margin-bottom: 10px; font-size: 14px;">Personalize the names of your classes. Saved locally.</p>
                    <form class="settings-form" id="period-names-form">
                        <button type="submit" class="save-settings-button">Save Period Names</button>
                    </form>
                    <div id="periodMessage" class="p-3 mt-4 text-center rounded-lg font-medium hidden" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
                </div>

                <div class="card lunch-names-card">
                    <span class="icon"> 🍔 </span>
                    <h3>Lunch Periods</h3>
                    <p style="margin-bottom: 10px; font-size: 14px;">Set which lunch you have. Saved locally.</p>
                    <form class="settings-form" id="lunch-names-form">
                        <label for="lunch-5th_Period_A">5th Period Lunch (Usually A Lunch)</label>
                        <input type="text" id="lunch-5th_Period_A" name="5th Period A" value="A Lunch" placeholder="A Lunch">
                        <label for="lunch-5th_Period_B">5th Period Lunch (Usually B Lunch)</label>
                        <input type="text" id="lunch-5th_Period_B" name="5th Period B" value="B Lunch" placeholder="B Lunch">
                        <label for="lunch-Homeroom_A">Homeroom Lunch (Wednesday A Lunch)</label>
                        <input type="text" id="lunch-Homeroom_A" name="Homeroom A" value="A Lunch" placeholder="A Lunch">
                        <label for="lunch-Homeroom_B">Homeroom Lunch (Wednesday B Lunch)</label>
                        <input type="text" id="lunch-Homeroom_B" name="Homeroom B" value="B Lunch" placeholder="B Lunch">
                        <button type="submit" class="save-settings-button">Save Lunch Periods</button>
                    </form>
                    <div id="lunchMessage" class="p-3 mt-4 text-center rounded-lg font-medium hidden" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
                </div>

                <div class="card" id="notifications-card" style="cursor: pointer;">
                    <span class="icon"> 🔔 </span>
                    <h3>Local Reminders</h3>
                    <p>Set up alerts for important events. Saved only on this device.</p>
                    <button id="test-notification-button" style="margin-top: 10px; background: var(--accent-blue); color: var(--primary-bg); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px; font-weight: bold;">Test Slide-in</button>
                </div>

                <div class="card"><span class="icon"> 🔑 </span><h3>Account</h3><p>Privacy and security options.</p></div>
                <div class="card"><span class="icon"> ⚙️ </span><h3>Display</h3><p>Adjust font size and layout.</p></div>
            </div>
        </section>
    </div>

    <div id="legal-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" id="close-modal-button">&times;</button>
            <h1>Legal Disclaimer <span style="font-size: 14px; color: var(--text-color);"> (Last Updated: October 2nd, 2025)</span></h1>
            <div class="disclaimer-point">
                <strong>1. General Information & Accuracy</strong>
                <p>The information provided by Crooms Connect is for general informational purposes only. All information is provided in good faith; however, we make no representation or warranty of any kind regarding the accuracy, adequacy, validity, reliability, availability, or completeness of any information, including schedules or event times.</p>
            </div>
            <div class="disclaimer-point">
                <strong>2. Educational Purpose Only</strong>
                <p>This platform is intended solely as an educational and communication tool for students. It is not an official source for administrative, financial, or legal decisions. Always refer to official school publications and staff for critical information.</p>
            </div>
            <div class="disclaimer-point">
                <strong>3. External Links Disclaimer</strong>
                <p>The platform may contain links to external websites that are not provided or maintained by or in any way affiliated with Crooms Connect. Please note that we do not guarantee the accuracy, relevance, timeliness, or completeness of any information on these external websites.</p>
            </div>
            <div class="disclaimer-point">
                <strong>4. "AS IS" and "AS AVAILABLE" Disclaimer</strong>
                <p>The platform is provided "AS IS" and "AS AVAILABLE" and with all faults and defects without warranty of any kind.</p>
            </div>
            <div class="disclaimer-point">
                <strong>5. User-Generated Content</strong>
                <p>Users are responsible for any content they post. We are not responsible for user-generated content, but we reserve the right to remove any content we deem inappropriate or harmful.</p></div>
            <div class="disclaimer-point">
                <strong>6. Limitation of Liability</strong>
                <p>Under no circumstance shall we be liable for any loss or damage of any kind incurred as a result of the use of the platform or reliance on any information provided. Your use of the platform and your reliance on any information is solely at your own risk.</p>
            </div>
            <div class="disclaimer-point">
                <strong>7. Indemnification Clause</strong>
                <p>You agree to defend, indemnify, and hold harmless Crooms Connect, its developers, and affiliates from and against any claims, damages, obligations, losses, liabilities, costs, or debt arising from: (a) your use of and access to the platform; (b) your violation of any term of this Disclaimer; or (c) any content you post on the platform.</p>
            </div>
            <div class="disclaimer-point">
                <strong>8. Intellectual Property (IP)</strong>
                <p>All original content, features, and functionality (excluding user-generated content) are and will remain the exclusive property of Crooms Connect. By posting User-Generated Content, you grant Crooms Connect a worldwide, non-exclusive, royalty-free license to use, reproduce, and display that content on the platform.</p>
            </div>
            <div class="disclaimer-point">
                <strong>9. User Conduct & Termination</strong>
                <p>We reserve the right, but not the obligation, to monitor and remove any User-Generated Content that we deem inappropriate, illegal, or in violation of these terms. We may terminate or suspend access to our platform immediately, without prior notice or liability, for any reason, including without limitation if you breach this Disclaimer.</p>
            </div>
        </div>
    </div>

    <div id="reminder-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button" id="close-reminder-modal-button">&times;</button>
            <h1>Set New Local Reminder</h1>
            <form class="settings-form" id="reminder-form">
                <label for="reminder-title">Title</label>
                <input type="text" id="reminder-title" required placeholder="e.g., Study for Math Test">
                <label for="reminder-date">Date</label>
                <input type="date" id="reminder-date" required>
                <label for="reminder-time">Time</label>
                <input type="time" id="reminder-time" required>
                <button type="submit" class="save-settings-button" style="background: linear-gradient(45deg, var(--accent-blue), #2a8dff);">Create Reminder</button>
                <div id="reminder-list-container" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <h3 style="color: var(--accent-yellow); margin-bottom: 10px;">Scheduled Local Reminders</h3>
                    <ul id="active-reminders-list"></ul>
                </div>
                <div id="reminder-message" class="p-3 mt-4 text-center rounded-lg font-medium hidden" style="background-color: var(--primary-bg); color: var(--text-color);"></div>
            </form>
        </div>
    </div>

    <div id="in-app-notification">
        <h4><span>🔔</span> Reminder Fired</h4>
        <p id="notification-message">Your reminder message goes here.</p>
    </div>

    <footer>
        <p>© 2025 Crooms Connect | <a id="open-legal-modal">Legal Disclaimer</a></p>
    </footer>
    
    <img id="preview" style="position: absolute; display: none; width: 150px; height: 150px; border-radius: 10px; box-shadow: var(--shadow); border: 2px solid var(--accent-blue); pointer-events: none; z-index: 999;"/>

    <script>
        // --- SUPABASE & AUTHENTICATION ---
        const supabaseUrl = 'https://jxxnfsydrflnephmfjm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eG5mc3lkanJmbG5lcGhtZmptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NTA3NjUsImV4cCI6MjA3NTAyNjc2NX0.-IRbU1ER8lu7eNPoETgVQaFJ4Fp9VMowjzWfN7EZY6w';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function enforceAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = "auth.html"; // Redirect to your login page
            } else {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    document.getElementById("userIdDisplay").textContent = "Signed in as: " + (user.email || user.id);
                }
                // Now that we are authenticated, fetch cloud reminders
                fetchCloudReminders(); 
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            window.location.href = "auth.html"; // Redirect to login page after logout
        }

        // --- SCHEDULE DATA ---
        const defaultSchedules = {
            "Monday": [{ period: "1st Period", start: "07:20", end: "08:13" }, { period: "2nd Period", start: "08:18", end: "09:10" }, { period: "3rd Period", start: "09:15", end: "10:05" }, { period: "4th Period", start: "10:10", end: "11:02" }, { period: "5th Period A", start: "11:07", end: "11:57" }, { period: "5th Period B", start: "11:57", end: "12:27" }, { period: "6th Period", start: "12:32", end: "13:24" }, { period: "7th Period", start: "13:29", end: "14:20" }],
            "Tuesday": [{ period: "1st Period", start: "07:20", end: "08:13" }, { period: "2nd Period", start: "08:18", end: "09:10" }, { period: "3rd Period", start: "09:15", end: "10:05" }, { period: "4th Period", start: "10:10", end: "11:02" }, { period: "5th Period A", start: "11:07", end: "11:57" }, { period: "5th Period B", start: "11:57", end: "12:27" }, { period: "6th Period", start: "12:32", end: "13:24" }, { period: "7th Period", start: "13:29", end: "14:20" }],
            "Wednesday": [{ period: "2nd Period", start: "07:20", end: "08:49" }, { period: "4th Period", start: "08:55", end: "10:21" }, { period: "Homeroom B", start: "10:27", end: "11:17" }, { period: "Homeroom A", start: "11:17", end: "11:47" }, { period: "6th Period", start: "11:53", end: "13:20" }],
            "Thursday": [{ period: "1st Period", start: "07:20", end: "08:55" }, { period: "3rd Period", start: "09:01", end: "10:33" }, { period: "5th Period B", start: "10:39", end: "12:11" }, { period: "5th Period A", start: "12:11", end: "12:41" }, { period: "7th Period", start: "12:47", end: "14:20" }],
            "Friday": [{ period: "1st Period", start: "07:20", end: "08:13" }, { period: "2nd Period", start: "08:18", end: "09:10" }, { period: "3rd Period", start: "09:15", end: "10:05" }, { period: "4th Period", start: "10:10", end: "11:02" }, { period: "5th Period A", start: "11:07", end: "11:57" }, { period: "5th Period B", start: "11:57", end: "12:27" }, { period: "6th Period", start: "12:32", end: "13:24" }, { period: "7th Period", start: "13:29", end: "14:20" }]
        };
        let schedules = JSON.parse(JSON.stringify(defaultSchedules));

        // --- DOM Elements ---
        const appBody = document.getElementById('app-body');
        const darkModeButton = document.getElementById('dark-mode-button');
        const lightModeButton = document.getElementById('light-mode-button');
        const messageBox = document.getElementById('messageBox');
        const tabs = document.querySelectorAll(".tab-content");
        const homeButton = document.querySelector(".left-box button[data-tab='home']");
        const periodNamesForm = document.getElementById('period-names-form');
        const periodMessageBox = document.getElementById('periodMessage');
        const lunchNamesForm = document.getElementById('lunch-names-form');
        const lunchMessageBox = document.getElementById('lunchMessage');
        const currentLunchDisplay = document.getElementById('current-lunch-display');
        const notificationsCard = document.getElementById('notifications-card');
        const reminderModal = document.getElementById('reminder-modal');
        const reminderForm = document.getElementById('reminder-form');
        const reminderMessageBox = document.getElementById('reminder-message');
        const activeRemindersList = document.getElementById('active-reminders-list');
        const closeReminderModalButton = document.getElementById('close-reminder-modal-button');
        const inAppNotification = document.getElementById('in-app-notification');
        const testNotificationButton = document.getElementById('test-notification-button');
        const logoutBtn = document.getElementById('logout-btn');
        const cloudReminderForm = document.getElementById('cloud-reminder-form');
        const cloudReminderMsg = document.getElementById('cloud-reminder-message');
        const cloudReminderList = document.getElementById('cloud-reminder-list');

        // --- CONSTANTS ---
        const THEME_STORAGE_KEY = 'croomsConnectThemeMode';
        const NAMES_STORAGE_KEY = 'croomsConnectPeriodNames';
        const LUNCH_STORAGE_KEY = 'croomsConnectLunchNames';
        const REMINDER_STORAGE_KEY = 'croomsConnectReminders';
        const DEFAULT_MODE = 'dark';
        const DEFAULT_LUNCH_MAP = { "5th Period B": "B Lunch", "5th Period A": "A Lunch", "Homeroom B": "B Lunch", "Homeroom A": "A Lunch" };

        // --- Supabase Cloud Reminders ---
        function showCloudMsg(msg, type = '') {
            cloudReminderMsg.textContent = msg;
            cloudReminderMsg.style.color = type === 'error' ? 'red' : 'green';
            setTimeout(() => cloudReminderMsg.textContent = '', 4000);
        }

        async function addCloudReminder(title, datetime) {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                showCloudMsg('You must be logged in to save reminders.', 'error');
                return;
            }
            const { error } = await supabase.from('reminders').insert([{ title, timestamp: datetime, user_id: user.id }]);
            if (error) {
                showCloudMsg('Error saving reminder: ' + error.message, 'error');
            } else {
                showCloudMsg('Reminder saved!', 'success');
                fetchCloudReminders();
            }
        }

        async function fetchCloudReminders() {
            const { data: { user } } = await supabase.auth.getUser();
            cloudReminderList.innerHTML = '';
            if (!user) {
                cloudReminderList.innerHTML = '<li>Please log in to view your reminders.</li>';
                return;
            }

            const { data, error } = await supabase.from('reminders').select('*').eq('user_id', user.id).order('timestamp', { ascending: true });
            if (error) {
                cloudReminderList.innerHTML = '<li>Error loading reminders.</li>';
                return;
            }
            if (!data || data.length === 0) {
                cloudReminderList.innerHTML = '<li>No cloud reminders found.</li>';
                return;
            }
            data.forEach(reminder => {
                const li = document.createElement('li');
                const reminderTime = new Date(reminder.timestamp);
                const dateStr = reminderTime.toLocaleDateString();
                const timeStr = reminderTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                li.innerHTML = `<span><strong>${reminder.title}</strong><br><small style="opacity: 0.8;">${dateStr} @ ${timeStr}</small></span>`;
                cloudReminderList.appendChild(li);
            });
        }
        
        // --- GENERAL UTILITIES ---
        const applyMode = (mode) => {
            appBody.classList.toggle('light-mode', mode === 'light');
            updateActiveButton(mode);
        };

        const updateActiveButton = (mode) => {
            darkModeButton.classList.toggle('active', mode === 'dark');
            lightModeButton.classList.toggle('active', mode === 'light');
        };

        const saveModePreference = (mode) => {
            try {
                localStorage.setItem(THEME_STORAGE_KEY, mode);
                applyMode(mode);
                showMessageBox(messageBox, `${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode activated and saved!`, 'success');
            } catch (error) {
                console.error("Error saving mode preference to localStorage:", error);
                showMessageBox(messageBox, "Failed to save mode locally.", 'error');
            }
        };

        const loadModePreference = () => {
            try {
                const savedMode = localStorage.getItem(THEME_STORAGE_KEY);
                applyMode(savedMode || DEFAULT_MODE);
            } catch (error) {
                console.error("Error loading mode preference from localStorage:", error);
                applyMode(DEFAULT_MODE);
            }
        };

        const showMessageBox = (box, message, type) => {
            box.textContent = message;
            box.classList.remove('hidden');
            box.style.backgroundColor = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
            box.style.color = 'var(--primary-bg)';
            setTimeout(() => box.classList.add('hidden'), 3000);
        };

        // --- PERIOD NAME UTILITIES ---
        const getUniquePeriodKeys = () => Array.from(new Set(Object.values(defaultSchedules).flat().map(block => block.period))).filter(key => !DEFAULT_LUNCH_MAP.hasOwnProperty(key));

        const loadPeriodNames = () => {
            try {
                const savedNames = localStorage.getItem(NAMES_STORAGE_KEY);
                if (savedNames) {
                    const customNames = JSON.parse(savedNames);
                    for (const day in schedules) {
                        schedules[day] = defaultSchedules[day].map(block => ({ ...block, period: customNames[block.period] || block.period }));
                    }
                }
            } catch (error) {
                console.error("Error loading period names from localStorage:", error);
            }
        };

        const populatePeriodForm = () => {
            const uniqueKeys = getUniquePeriodKeys();
            let savedNames = {};
            try {
                const savedNamesStr = localStorage.getItem(NAMES_STORAGE_KEY);
                if (savedNamesStr) savedNames = JSON.parse(savedNamesStr);
            } catch (e) { console.error(e); }

            let formContent = uniqueKeys.sort().map(key => {
                const currentName = savedNames[key] || key;
                return `<label for="name-${key.replace(/\s/g, '_')}">${key}</label><input type="text" id="name-${key.replace(/\s/g, '_')}" name="${key}" value="${currentName}" placeholder="${key}">`;
            }).join('');
            
            const buttonHTML = periodNamesForm.querySelector('.save-settings-button').outerHTML;
            periodNamesForm.innerHTML = formContent + buttonHTML;
            periodNamesForm.removeEventListener('submit', handlePeriodFormSubmit);
            periodNamesForm.addEventListener('submit', handlePeriodFormSubmit);
        };

        const handlePeriodFormSubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(periodNamesForm);
            const customNames = {};
            for (const [originalKey, customName] of formData.entries()) {
                const trimmedName = customName.trim();
                if (trimmedName && trimmedName !== originalKey) {
                    customNames[originalKey] = trimmedName;
                }
            }
            try {
                localStorage.setItem(NAMES_STORAGE_KEY, JSON.stringify(customNames));
                schedules = JSON.parse(JSON.stringify(defaultSchedules)); // Reset
                loadPeriodNames(); // Reload with new names
                updatePeriodTimer(); // Update display immediately
                showMessageBox(periodMessageBox, 'Period names saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving period names to localStorage:", error);
                showMessageBox(periodMessageBox, 'Failed to save period names.', 'error');
            }
        };

        // --- LUNCH NAME UTILITIES ---
        const loadLunchNames = () => {
            let customLunchMap = {};
            try {
                const savedNamesStr = localStorage.getItem(LUNCH_STORAGE_KEY);
                if (savedNamesStr) customLunchMap = JSON.parse(savedNamesStr);
            } catch (e) { console.error(e); }
            for (const key in DEFAULT_LUNCH_MAP) {
                const input = document.getElementById(`lunch-${key.replace(/\s/g, '_')}`);
                if (input) input.value = customLunchMap[key] || DEFAULT_LUNCH_MAP[key];
            }
            return customLunchMap;
        };

        const handleLunchFormSubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(lunchNamesForm);
            const customLunchMap = {};
            for (const [originalKey, customName] of formData.entries()) {
                const trimmedName = customName.trim();
                if (trimmedName && trimmedName !== DEFAULT_LUNCH_MAP[originalKey]) {
                    customLunchMap[originalKey] = trimmedName;
                }
            }
            try {
                localStorage.setItem(LUNCH_STORAGE_KEY, JSON.stringify(customLunchMap));
                updateLunchDisplay();
                showMessageBox(lunchMessageBox, 'Lunch periods saved successfully!', 'success');
            } catch (error) {
                console.error("Error saving lunch names to localStorage:", error);
                showMessageBox(lunchMessageBox, 'Failed to save lunch periods.', 'error');
            }
        };
        
        const updateLunchDisplay = () => {
            const dayName = new Date().toLocaleDateString("en-US", { weekday: "long" });
            const customLunchMap = loadLunchNames();
            let currentLunch = "No Scheduled Lunch Today";
        
            const daySchedule = defaultSchedules[dayName] || [];
            for (let block of daySchedule) {
                if (DEFAULT_LUNCH_MAP[block.period]) {
                    const lunchName = customLunchMap[block.period] || DEFAULT_LUNCH_MAP[block.period];
                    currentLunch = `${lunchName} (${block.start} - ${block.end})`;
                    break; 
                }
            }
            currentLunchDisplay.innerText = currentLunch;
        };

        // --- LOCAL REMINDER UTILITIES ---
        const loadReminders = () => {
            try {
                const remindersStr = localStorage.getItem(REMINDER_STORAGE_KEY);
                return remindersStr ? JSON.parse(remindersStr) : [];
            } catch (e) { return []; }
        };

        const saveReminders = (reminders) => {
            try {
                localStorage.setItem(REMINDER_STORAGE_KEY, JSON.stringify(reminders));
            } catch (e) { console.error("Error saving reminders:", e); }
        };

        const deleteReminder = (id) => {
            let reminders = loadReminders().filter(r => r.id !== id);
            saveReminders(reminders);
            renderReminders();
            showMessageBox(reminderMessageBox, 'Reminder deleted.', 'success');
        };

        const renderReminders = () => {
            const reminders = loadReminders().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            activeRemindersList.innerHTML = '';
            if (reminders.length === 0) {
                activeRemindersList.innerHTML = `<li style="opacity: 0.7; border-bottom: none;">No active local reminders set.</li>`;
                return;
            }
            reminders.forEach(r => {
                const reminderTime = new Date(r.timestamp);
                const item = document.createElement('li');
                item.innerHTML = `<span><strong>${r.title}</strong><br><small style="opacity: 0.8; color: var(--accent-yellow);">${reminderTime.toLocaleDateString()} @ ${reminderTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small></span>
                                  <button class="delete-reminder-button" data-id="${r.id}" style="background: var(--accent-red); color: var(--primary-bg); border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">&times;</button>`;
                activeRemindersList.appendChild(item);
            });
            document.querySelectorAll('.delete-reminder-button').forEach(button => button.addEventListener('click', (e) => deleteReminder(e.target.dataset.id)));
        };

        const handleReminderSubmit = (e) => {
            e.preventDefault();
            const title = document.getElementById('reminder-title').value.trim();
            const date = document.getElementById('reminder-date').value;
            const time = document.getElementById('reminder-time').value;
            if (!title || !date || !time) {
                showMessageBox(reminderMessageBox, 'Please fill out all fields.', 'error');
                return;
            }
            const datetimeString = `${date}T${time}:00`;
            if (new Date(datetimeString) <= new Date()) {
                showMessageBox(reminderMessageBox, 'Reminder time must be in the future.', 'error');
                return;
            }
            const newReminder = { id: Date.now().toString(), title, timestamp: datetimeString };
            let reminders = loadReminders();
            reminders.push(newReminder);
            saveReminders(reminders);
            e.target.reset();
            renderReminders();
            showMessageBox(reminderMessageBox, 'Local reminder created!', 'success');
        };

        const showInAppNotification = (title, body) => {
            inAppNotification.classList.remove('show');
            setTimeout(() => {
                inAppNotification.querySelector('h4').innerHTML = `<span>🔔</span> ${title}`;
                document.getElementById('notification-message').textContent = body;
                inAppNotification.classList.add('show');
                setTimeout(() => inAppNotification.classList.remove('show'), 5000);
            }, 50);
        }

        const checkIntervalReminders = () => {
            let reminders = loadReminders();
            const now = new Date().getTime();
            let remindersToKeep = [];
            reminders.forEach(r => {
                if (new Date(r.timestamp).getTime() <= now + 1000) {
                    showInAppNotification("Reminder", r.title);
                } else {
                    remindersToKeep.push(r);
                }
            });
            if (reminders.length !== remindersToKeep.length) {
                saveReminders(remindersToKeep);
                renderReminders();
            }
        };

        // --- TIMER AND DISPLAY UTILITIES ---
        const formatTimeLeft = (totalSeconds) => {
            if (totalSeconds < 0) return "0s";
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return [h > 0 ? `${h}h` : '', m > 0 ? `${m}m` : '', `${s}s`].filter(Boolean).join(" ");
        };

        const timeToMinutes = (timeStr) => {
            const [h, m] = timeStr.split(":").map(Number);
            return h * 60 + m;
        };
        
        const updateInfoSection = () => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString("en-US", { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = (now.getMonth() + 1).toString().padStart(2, '0') + '/' + now.getDate().toString().padStart(2, '0') + '/' + now.getFullYear();
            const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
            const schedule = schedules[dayName] || [];
            const currentMinutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds() / 60;
            let parity = "Weekend / No School";

            if (schedule.length > 0) {
                const firstStartMinutes = timeToMinutes(schedule[0].start);
                const lastEndMinutes = timeToMinutes(schedule[schedule.length - 1].end);
                if (currentMinutes < firstStartMinutes) parity = "Before School";
                else if (currentMinutes >= lastEndMinutes) parity = "After School";
                else {
                    const inClass = schedule.some(b => currentMinutes >= timeToMinutes(b.start) && currentMinutes < timeToMinutes(b.end));
                    parity = inClass ? `${dayName} Schedule` : "Passing Time";
                }
            }
            document.getElementById("info-section").innerText = `Time: ${timeStr} | Date: ${dateStr} | ${parity}`;
        };

        const updatePeriodTimer = () => {
            const now = new Date();
            const dayName = now.toLocaleDateString("en-US", { weekday: "long" });
            const schedule = schedules[dayName] || [];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            let currentPeriod = "No Class";
            let totalSecondsLeft = -1;

            const currentBlock = schedule.find(b => currentMinutes >= timeToMinutes(b.start) && currentMinutes < timeToMinutes(b.end));
            if (currentBlock) {
                currentPeriod = currentBlock.period;
                totalSecondsLeft = (timeToMinutes(currentBlock.end) * 60) - (currentMinutes * 60) - now.getSeconds();
            } else {
                let nextTarget;
                if (schedule.length > 0 && currentMinutes < timeToMinutes(schedule[schedule.length - 1].end)) {
                    const nextBlock = schedule.find(b => currentMinutes < timeToMinutes(b.start));
                    if(nextBlock) {
                        currentPeriod = `Next: ${nextBlock.period}`;
                        const [h, m] = nextBlock.start.split(':').map(Number);
                        nextTarget = new Date(now).setHours(h, m, 0, 0);
                    } else {
                         currentPeriod = "After School";
                    }
                } else {
                    currentPeriod = schedule.length > 0 ? "After School" : "Weekend/Break";
                    let nextDay = new Date(now);
                    nextDay.setDate(now.getDate() + 1);
                    while ([0, 6].includes(nextDay.getDay())) nextDay.setDate(nextDay.getDate() + 1);
                    nextTarget = nextDay.setHours(7, 20, 0, 0);
                }
                if(nextTarget) totalSecondsLeft = Math.floor((nextTarget - now.getTime()) / 1000);
            }

            const timerContainer = document.getElementById("period-timer");
            let timerTextSpan = document.getElementById("timer-text");
            const timeLeft = formatTimeLeft(totalSecondsLeft);
            
            if (!timerTextSpan) {
                timerContainer.innerHTML = `${currentPeriod} – <span id="timer-text" class="timer-text">${timeLeft} left</span>`;
                timerTextSpan = document.getElementById("timer-text");
            } else {
                timerContainer.firstChild.nodeValue = `${currentPeriod} – `;
                timerTextSpan.innerText = `${timeLeft} left`;
            }
            
            timerTextSpan.classList.toggle('timer-active', totalSecondsLeft > 0 && currentPeriod.indexOf('After') === -1 && currentPeriod.indexOf('Weekend') === -1);
            if (timerTextSpan.classList.contains('timer-active')) {
                timerTextSpan.style.color = totalSecondsLeft > 900 ? 'var(--accent-green)' : 'var(--accent-red)';
            } else {
                timerTextSpan.style.color = 'var(--text-color)';
            }
        };

        const showReminderModal = () => {
            renderReminders();
            reminderModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        const hideReminderModal = () => {
            reminderModal.classList.remove('show');
            document.body.style.overflow = '';
        };

        // --- DOM READY AND LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // 0. Enforce Login
            enforceAuth();
            
            // 1. Load Local Settings
            loadModePreference();
            loadPeriodNames();
            populatePeriodForm();
            loadLunchNames();

            // 2. Attach Event Listeners
            logoutBtn.addEventListener('click', handleLogout);
            darkModeButton.addEventListener('click', () => saveModePreference('dark'));
            lightModeButton.addEventListener('click', () => saveModePreference('light'));
            lunchNamesForm.addEventListener('submit', handleLunchFormSubmit);
            if(cloudReminderForm){
                cloudReminderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const title = document.getElementById('cloud-reminder-title').value;
                    const datetime = document.getElementById('cloud-reminder-datetime').value;
                    await addCloudReminder(title, datetime);
                    cloudReminderForm.reset();
                });
            }

            // 3. Start Timers
            updatePeriodTimer();
            updateLunchDisplay();
            updateInfoSection();
            setInterval(() => {
                updatePeriodTimer();
                updateLunchDisplay();
                updateInfoSection();
                checkIntervalReminders(); // Checks local reminders every second
            }, 1000);

            // 4. Tab Switching
            document.querySelectorAll(".left-box button").forEach(button => {
                button.addEventListener("click", () => {
                    document.querySelector(".left-box button.active")?.classList.remove("active");
                    button.classList.add("active");
                    document.querySelector(".tab-content.active")?.classList.remove("active");
                    document.getElementById(button.dataset.tab)?.classList.add("active");
                });
            });
            if (homeButton) homeButton.classList.add("active");

            // 5. Header Scroll Hide/Show
            let lastScrollY = window.scrollY;
            const header = document.querySelector('.header');
            window.addEventListener('scroll', () => {
                header.style.top = (window.scrollY > lastScrollY && window.scrollY > header.offsetHeight) ? `-${header.offsetHeight}px` : '0';
                lastScrollY = window.scrollY;
            });

            // 6. Image Preview
            const preview = document.getElementById("preview");
            document.querySelectorAll(".info p[data-food]").forEach(item => {
                item.addEventListener("mouseenter", (e) => {
                    preview.src = `https://placehold.co/300x300/4cc9f0/1a1b2f?text=${encodeURIComponent(e.target.dataset.food)}`;
                    preview.style.display = "block";
                });
                item.addEventListener("mousemove", (e) => {
                    preview.style.left = (e.pageX + 20) + "px";
                    preview.style.top = (e.pageY + 20) + "px";
                });
                item.addEventListener("mouseleave", () => preview.style.display = "none");
            });

            // 7. Modal Logic
            const legalModal = document.getElementById("legal-modal");
            const openModalLink = document.getElementById("open-legal-modal");
            const closeModalButton = document.getElementById("close-modal-button");
            const showLegalModal = () => { legalModal.classList.add('show'); document.body.style.overflow = 'hidden'; };
            const hideLegalModal = () => { legalModal.classList.remove('show'); document.body.style.overflow = ''; };
            openModalLink?.addEventListener('click', showLegalModal);
            closeModalButton?.addEventListener('click', hideLegalModal);
            legalModal?.addEventListener('click', (e) => { if (e.target === legalModal) hideLegalModal(); });

            // 8. Local Reminder Maker Logic
            notificationsCard?.addEventListener('click', showReminderModal);
            testNotificationButton?.addEventListener('click', (e) => {
                e.stopPropagation();
                showInAppNotification("Test Notification", "This should slide in smoothly!");
            });
            closeReminderModalButton?.addEventListener('click', hideReminderModal);
            reminderModal?.addEventListener('click', (e) => { if (e.target === reminderModal) hideReminderModal(); });
            reminderForm?.addEventListener('submit', handleReminderSubmit);
        });
    </script>
</body>
</html>
